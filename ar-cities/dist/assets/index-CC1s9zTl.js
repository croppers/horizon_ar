(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function o(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(n){if(n.ep)return;n.ep=!0;const a=o(n);fetch(n.href,a)}})();const wt="arcities.settings.v2";function Pt(){try{const t=localStorage.getItem(wt);if(t)return JSON.parse(t)}catch{}return{maxDistanceKm:1e3,units:"km",hfovDeg:60,headingOffsetDeg:0,smoothing:.15,showOffscreenIndicators:!1}}function St(t){try{localStorage.setItem(wt,JSON.stringify(t))}catch{}}function Dt(t){const e=t.settings||Pt();t.settings=e;const o=document.getElementById("startBtn"),i=document.getElementById("helpBtn"),n=document.getElementById("onboarding"),a=document.getElementById("collapseBtn"),s=document.getElementById("controlsBody"),c=document.getElementById("distance"),d=document.getElementById("distanceValue"),p=document.getElementById("unitsKm"),y=document.getElementById("unitsMi"),b=document.getElementById("hfov"),F=document.getElementById("hfovValue"),I=document.getElementById("headingOffset"),B=document.getElementById("headingOffsetValue"),O=document.getElementById("smooth"),L=document.getElementById("smoothValue"),E=document.getElementById("showOffscreen"),T=document.getElementById("dbgHeading"),v=document.getElementById("dbgPitch"),k=document.getElementById("dbgRoll"),C=document.getElementById("dbgSource"),G=document.getElementById("dbgRate"),S=document.getElementById("dbgSmooth"),A=document.getElementById("geoText"),g=document.getElementById("manualGeo"),l=document.getElementById("lat"),u=document.getElementById("lon"),M=document.getElementById("setGeo");localStorage.getItem("arcities.onboarded")||n.showModal(),document.getElementById("onboardingClose").addEventListener("click",()=>{localStorage.setItem("arcities.onboarded","1")}),i.addEventListener("click",()=>n.showModal()),a.addEventListener("click",()=>{const r=!(a.getAttribute("aria-expanded")==="true");a.setAttribute("aria-expanded",String(r)),s.style.display=r?"block":"none",a.textContent=r?"▾":"▸"}),c.value=String(e.maxDistanceKm),b.value=String(e.hfovDeg),I.value=String(e.headingOffsetDeg),O.value=String(e.smoothing),e.units==="km"?p.checked=!0:y.checked=!0,E.checked=!!e.showOffscreenIndicators;function D(f,r){if(r==="km")return`${Math.round(f)} km`;const h=f*.621371;return`${Math.round(h)} mi`}function m(){d.textContent=D(Number(c.value),e.units),F.textContent=`${b.value}°`,B.textContent=`${I.value}°`,L.textContent=`${Number(O.value).toFixed(2)}`}m();function w(){St(e),t.onSettingsChange?.(e),m()}return c.addEventListener("input",()=>{e.maxDistanceKm=Number(c.value),w()}),b.addEventListener("input",()=>{e.hfovDeg=Number(b.value),w()}),I.addEventListener("input",()=>{e.headingOffsetDeg=Number(I.value),w()}),O.addEventListener("input",()=>{e.smoothing=Number(O.value),w()}),E.addEventListener("change",()=>{e.showOffscreenIndicators=E.checked,w()}),p.addEventListener("change",()=>{e.units="km",w()}),y.addEventListener("change",()=>{e.units="mi",w()}),o.addEventListener("click",()=>t.onStart?.()),M.addEventListener("click",()=>{const f=Number(l.value),r=Number(u.value);!Number.isFinite(f)||!Number.isFinite(r)||t.onManualGeo?.({lat:f,lon:r})}),{setGeoStatus(f){A.textContent=f},showManualGeo(f){g.classList.toggle("hidden",!f)},updateDebug(f,r,h,P,R){T.textContent=f.toFixed(1),v.textContent=r.toFixed(1),k.textContent=h.toFixed(1),C.textContent=P,G.textContent=R?R.toFixed(0):"–",S.textContent=e.smoothing.toFixed(2)},getSettings(){return e}}}function j(t){return t*Math.PI/180}function It(t){return t*180/Math.PI}function N(t){let e=t%360;return e<0&&(e+=360),e}function J(t){return((t+180)%360+360)%360-180}function vt(t,e,o,i){const n=6371.0088,a=j(o-t),s=j(i-e),c=Math.sin(a/2)**2+Math.cos(j(t))*Math.cos(j(o))*Math.sin(s/2)**2,d=2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c));return n*d}function Et(t,e,o,i){const n=j(t),a=j(o),s=j(i-e),c=Math.sin(s)*Math.cos(a),d=Math.cos(n)*Math.sin(a)-Math.sin(n)*Math.cos(a)*Math.cos(s),p=It(Math.atan2(c,d));return N(p)}function kt(t,e,o){const i=J(e-t);return N(t+i*(1-Math.exp(-o)))}function gt(t,e,o){return t+(e-t)*(1-Math.exp(-o))}async function Ot(){try{const t=window,e=t.DeviceMotionEvent&&typeof t.DeviceMotionEvent.requestPermission=="function"?await t.DeviceMotionEvent.requestPermission():"granted",o=t.DeviceOrientationEvent&&typeof t.DeviceOrientationEvent.requestPermission=="function"?await t.DeviceOrientationEvent.requestPermission():"granted"}catch{}}async function Lt(t){try{const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}},audio:!1});return t.srcObject=e,await t.play(),e}catch(e){return console.warn("Camera access failed",e),null}}function Tt(t,e){if(!("geolocation"in navigator))return e(new DOMException("Geolocation not supported")),()=>{};if(!window.isSecureContext)return e(new DOMException("Geolocation requires HTTPS")),()=>{};let o=null;const i={enableHighAccuracy:!0,maximumAge:5e3,timeout:2e4};try{navigator.geolocation.getCurrentPosition(n=>{const{latitude:a,longitude:s,accuracy:c}=n.coords;t({lat:a,lon:s,accuracy:c})},n=>{e(n)},i)}catch(n){e(n)}try{o=navigator.geolocation.watchPosition(n=>{const{latitude:a,longitude:s,accuracy:c}=n.coords;t({lat:a,lon:s,accuracy:c})},n=>e(n),i)}catch(n){e(n)}return()=>{o!==null&&navigator.geolocation.clearWatch(o)}}function Bt(t,e,o,i){const n=e*e,a=2*(i*t+e*o),s=1-2*(t*t+n),c=Math.atan2(a,s);let d=2*(i*e-o*t);d=Math.max(-1,Math.min(1,d));const p=Math.asin(d),y=2*(i*o+t*e),b=1-2*(n+o*o);return{yaw:Math.atan2(y,b)*180/Math.PI,pitch:p*180/Math.PI,roll:c*180/Math.PI}}function Ct(t){let e=t.smoothing,o=t.headingOffsetDeg,i=new Set,n="deviceorientation+motion",a=null,s=0,c=0,d=0,p=0,y={headingDeg:0,pitchDeg:0,rollDeg:0,timestamp:performance.now()};const b=.02,F=.01;let I=null;const B=window,O=B.AbsoluteOrientationSensor,L=B.RelativeOrientationSensor;let E=null;function T(g){const l=N(s+o),u=c,M=d,D=kt(y.headingDeg,l,e),m=gt(y.pitchDeg,u,e),w=gt(y.rollDeg,M,e),f={headingDeg:D,pitchDeg:m,rollDeg:w,source:n,timestamp:g};y=f,i.forEach(r=>r(f))}function v(){try{const g=O||L;if(!g)return!1;const l=new g({frequency:60});return E=l,n="generic-sensor",l.onreading=()=>{const u=l.quaternion;if(!u)return;const{yaw:M,pitch:D,roll:m}=Bt(u[0],u[1],u[2],u[3]);s=N(M),c=D,d=m,T(performance.now())},l.onerror=()=>{},l.start(),!0}catch{return!1}}function k(){n="deviceorientation+motion";function g(u){const M=u;typeof M.webkitCompassHeading=="number"?I=N(M.webkitCompassHeading):typeof u.alpha=="number"&&(I=N(u.alpha))}function l(u){const M=performance.now(),D=p?(M-p)/1e3:0;p=M;const m=u.rotationRate;if(m){const f=m.alpha??0,r=m.beta??0,h=m.gamma??0;s=N(s+f*D),c=c+r*D,d=d+h*D}const w=u.accelerationIncludingGravity;if(w){const f=w.x??0,r=w.y??0,h=w.z??-9.8,P=Math.atan2(-f,Math.hypot(r,h))*180/Math.PI,R=Math.atan2(r,h)*180/Math.PI;c=c*(1-b)+P*b,d=d*(1-b)+R*b}if(I!=null){const f=J(I-s);s=N(s+f*F)}T(M)}return window.addEventListener("deviceorientation",g,!0),window.addEventListener("devicemotion",l,!0),()=>{window.removeEventListener("deviceorientation",g,!0),window.removeEventListener("devicemotion",l,!0)}}let C=[];function G(){n="virtual";let g=!1,l=0,u=0;const M=.1,D=.1;function m(r){g=!0,l=r.clientX,u=r.clientY,r.target.setPointerCapture?.(r.pointerId)}function w(r){g=!1,r.target.releasePointerCapture?.(r.pointerId)}function f(r){if(!g)return;const h=r.clientX-l,P=r.clientY-u;l=r.clientX,u=r.clientY,s=N(s+h*M),c=Math.max(-89,Math.min(89,c-P*D)),T(performance.now())}window.addEventListener("pointerdown",m),window.addEventListener("pointerup",w),window.addEventListener("pointermove",f),C.push(()=>{window.removeEventListener("pointerdown",m),window.removeEventListener("pointerup",w),window.removeEventListener("pointermove",f)})}if(!v()){const g=k();C.push(g);const l=setTimeout(()=>{p===0&&I==null&&G()},2e3);C.push(()=>clearTimeout(l))}function A(){T(performance.now()),a=requestAnimationFrame(A)}return a=requestAnimationFrame(A),{subscribe(g){return i.add(g),()=>i.delete(g)},setSmoothing(g){e=Math.max(0,Math.min(.3,g))},setHeadingOffset(g){o=g},getSource(){return n},stop(){a!==null&&cancelAnimationFrame(a),C.forEach(g=>g()),E?.stop?.(),i.clear()}}}function Rt(t,e,o){const i=o/2,n=t/e*i+i;return Math.max(0,Math.min(o,n))}function At(t,e,o){const i=o/2,n=-t/e*i+i;return Math.max(0,Math.min(o,n))}function Ft(t,e,o){return t*(o/Math.max(1,e))}function Gt(t,e){const o=e/2;return t>=-o&&t<=o}function _t(t){return t<0?"left":"right"}const $t="./surfrac0.1.PPS";let W=null,ot=!1;function Ht(t){let e="",o=0;for(;o<t.length;){const n=t[o];if(n==="#")for(;o<t.length&&t[o]!==`
`;)o++;else e+=n;if(o++,e.split(/\s+/).filter(Boolean).length>=6&&e.includes(`
`)&&e.length>256)break}return{tokens:e.trim().split(/\s+/),headerLen:e.length}}async function xt(){if(!(W||ot)){ot=!0;try{const t=await fetch($t,{cache:"force-cache"});if(!t.ok)throw new Error("failed to fetch land mask");const e=await t.arrayBuffer(),o=new Uint8Array(e),i=new TextDecoder("ascii").decode(o.subarray(0,Math.min(2048,o.length)));if(i.startsWith("P5")||i.startsWith("P6")||i.startsWith("P2")||i.startsWith("P3")){const{tokens:B,headerLen:O}=Ht(i),L=B[0];let E=1;const T=parseInt(B[E++],10),v=parseInt(B[E++],10),k=parseInt(B[E++],10)||255;if(!Number.isFinite(T)||!Number.isFinite(v))throw new Error("invalid PNM dims");const C=L==="P2"||L==="P3",G=L==="P6"||L==="P3";let S;if(C){const w=new TextDecoder("ascii").decode(o).replace(/#.*$/gm," ").trim().split(/\s+/),f=4;if(S=new Uint8ClampedArray(T*v),L==="P2")for(let r=0;r<S.length;r++){const h=parseFloat(w[f+r])||0;S[r]=Math.max(0,Math.min(255,Math.round(h/k*255)))}else for(let r=0,h=f;r<S.length;r++,h+=3){const P=parseFloat(w[h])||0,R=parseFloat(w[h+1])||0,Q=parseFloat(w[h+2])||0,Z=.2126*P+.7152*R+.0722*Q;S[r]=Math.max(0,Math.min(255,Math.round(Z/k*255)))}}else{let D=i.indexOf(`
`,i.indexOf(String(k)))+1;D<=0&&(D=O);const m=o.subarray(D),w=G?3:1,f=T*v*w*(k<256?1:2);if(m.length<f)throw new Error("PNM data truncated");if(S=new Uint8ClampedArray(T*v),k<256)if(G)for(let r=0,h=0;r<S.length;r++,h+=3)S[r]=m[h]*.2126+m[h+1]*.7152+m[h+2]*.0722&255;else S.set(m.subarray(0,S.length));else{const r=new DataView(m.buffer,m.byteOffset,m.byteLength);if(G){let h=0;for(let P=0;P<S.length;P++){const R=r.getUint16(h);h+=2;const Q=r.getUint16(h);h+=2;const Z=r.getUint16(h);h+=2;const $=.2126*R+.7152*Q+.0722*Z;S[P]=Math.round($/k*255)}}else{let h=0;for(let P=0;P<S.length;P++){const R=r.getUint16(h);h+=2,S[P]=Math.round(R/k*255)}}}}const A=1024,g=Math.max(1,Math.round(A*v/T)),l=document.createElement("canvas");l.width=A,l.height=g;const u=l.getContext("2d"),M=u.createImageData(A,g);for(let D=0;D<g;D++){const m=Math.floor(D/g*v);for(let w=0;w<A;w++){const f=Math.floor(w/A*T),h=S[m*T+f]>=128,P=(D*A+w)*4;M.data[P]=h?100:0,M.data[P+1]=h?180:0,M.data[P+2]=h?120:0,M.data[P+3]=h?220:0}}u.putImageData(M,0,0),W=l;return}const a=new TextDecoder("utf-8").decode(o).trim().split(/\s+/),s=3600,c=1800,d=s*c,p=1024,y=Math.max(1,Math.round(p*c/s)),b=document.createElement("canvas");b.width=p,b.height=y;const F=b.getContext("2d"),I=F.createImageData(p,y);for(let B=0;B<y;B++){const O=Math.floor(B/y*c);for(let L=0;L<p;L++){const E=Math.floor(L/p*s),T=O*s+E,k=(parseFloat(a[T])||0)>=.5,C=(B*p+L)*4;I.data[C]=k?100:0,I.data[C+1]=k?180:0,I.data[C+2]=k?120:0,I.data[C+3]=k?220:0}}F.putImageData(I,0,0),W=b}catch{}finally{ot=!1}}}function tt(t,e,o,i,n,a){const s=o+(t+180)/360*n,c=i+(90-e)/180*a;return{px:s,py:c}}function H(t){return t*Math.PI/180}function ft(t){return t*180/Math.PI}function it(t,e,o,i){const a=i/6371,s=H(o),c=H(t),d=H(e),p=Math.sin(c),y=Math.cos(c),b=Math.sin(a),F=Math.cos(a),I=p*F+y*b*Math.cos(s),B=Math.asin(Math.max(-1,Math.min(1,I))),O=Math.sin(s)*b*y,L=F-p*I,E=d+Math.atan2(O,L);return{lat:ft(B),lon:(ft(E)+540)%360-180}}function Nt(t,e,o,i,n,a){t.beginPath(),t.moveTo(e+a,o),t.arcTo(e+i,o,e+i,o+n,a),t.arcTo(e+i,o+n,e,o+n,a),t.arcTo(e,o+n,e,o,a),t.arcTo(e,o,e+i,o,a),t.closePath()}function Kt(t,e){const{x:o,y:i,w:n,h:a,user:s,headingDeg:c,hfovDeg:d,maxDistanceKm:p,cities:y}=e;t.save(),t.globalAlpha=.95,t.fillStyle="rgba(10,12,14,0.7)",Nt(t,o,i,n,a,8),t.fill(),t.restore(),!W&&!ot&&xt(),W&&(t.save(),t.globalAlpha=.5,t.drawImage(W,0,0,W.width,W.height,o,i,n,a),t.restore());const b=tt(s.lon,s.lat,o,i,n,a);t.save(),t.fillStyle="rgba(255,255,255,0.9)",t.beginPath(),t.arc(b.px,b.py,2.5,0,Math.PI*2),t.fill(),t.restore(),t.save(),t.strokeStyle="rgba(255,255,255,0.4)",t.lineWidth=1,t.beginPath();const F=128;for(let v=0;v<=F;v++){const k=v/F*360,C=it(s.lat,s.lon,k,p),G=tt(C.lon,C.lat,o,i,n,a);v===0?t.moveTo(G.px,G.py):t.lineTo(G.px,G.py)}t.closePath(),t.stroke(),t.restore(),t.save(),t.strokeStyle="rgba(255,220,120,0.7)",t.fillStyle="rgba(255,220,120,0.15)",t.lineWidth=1;const I=J(c-d/2),B=J(c+d/2),O=it(s.lat,s.lon,I,p),L=it(s.lat,s.lon,B,p),E=tt(O.lon,O.lat,o,i,n,a),T=tt(L.lon,L.lat,o,i,n,a);t.beginPath(),t.moveTo(b.px,b.py),t.lineTo(E.px,E.py),t.lineTo(T.px,T.py),t.closePath(),t.fill(),t.stroke(),t.restore(),t.save();for(const v of y){const C=vt(s.lat,s.lon,v.lat,v.lon)<=p,{px:G,py:S}=tt(v.lon,v.lat,o,i,n,a);let A=.25,g="rgba(180,220,255,";if(C){v.lat-s.lat;const l=v.lon-s.lon,u=Math.atan2(Math.sin(H(l))*Math.cos(H(v.lat)),Math.cos(H(s.lat))*Math.sin(H(v.lat))-Math.sin(H(s.lat))*Math.cos(H(v.lat))*Math.cos(H(l)))*180/Math.PI;Math.abs(J(u-c))<=d/2?(A=.9,g="rgba(255,255,255,"):(A=.6,g="rgba(120,180,255,")}t.fillStyle=`${g}${A})`,t.fillRect(G-1,S-1,2,2)}t.restore()}const Wt=t=>`${t.name}|${t.country}`,X=new Map;function Ut(t,e){const n=new Set([...X.keys(),...t.keys()]);for(const a of n){const s=X.get(a)??0,c=t.has(a),d=c?Math.min(1,s+4*e):Math.max(0,s-3*e);d<=0&&!c?X.delete(a):X.set(a,d)}}function Yt(t,e){return{w:t.measureText(e).width+12,h:24}}function Vt(t,e){return!(t.x+t.w<e.x||e.x+e.w<t.x||t.y+t.h<e.y||e.y+e.h<t.y)}function mt(t,e,o,i=12){const n=new Set,a=Math.max(12,t.h+6),s=t.y,c=[s];for(let d=1;d<=i;d++)c.push(s-d*a);for(let d=1;d<=i;d++)c.push(s+d*a);for(let d of c){if(d=Math.max(0,Math.min(o-t.h,d)),n.has(d))continue;n.add(d);const p={x:t.x,y:d,w:t.w,h:t.h};if(!e.some(y=>Vt(y,p)))return d}return null}function jt(t,e,o,i){const{width:n,height:a,hfovDeg:s,pitchDeg:c,headingDeg:d,cities:p,user:y,units:b,maxDistanceKm:F,showOffscreenIndicators:I,showMinimap:B}=e,O=Math.max(1,window.devicePixelRatio||1);(t.canvas.width!==Math.floor(n*O)||t.canvas.height!==Math.floor(a*O))&&(t.canvas.width=Math.floor(n*O),t.canvas.height=Math.floor(a*O)),t.setTransform(O,0,0,O,0,0),t.clearRect(0,0,n,a);const L=Ft(s,n,a),E=At(c,L,a);t.save(),t.strokeStyle="rgba(180,200,220,0.25)",t.lineWidth=2,t.beginPath(),t.moveTo(0,E),t.lineTo(n,E),t.stroke(),t.restore();const T=.621371,v=p.map(l=>{const u=vt(y.lat,y.lon,l.lat,l.lon);return{c:l,distKm:u,bearing:Et(y.lat,y.lon,l.lat,l.lon)}}).filter(l=>l.distKm<=F);v.sort((l,u)=>u.c.population-l.c.population);const k=[],C=[],G=[],S=new Set,A=24,g=i.v?Math.min(.1,(o-i.v)/1e3):0;i.v=o;for(const l of v){const u=Wt(l.c),M=J(l.bearing-d),D=!Gt(M,s),m=b==="km"?l.distKm:l.distKm*T,w=m>=100?Math.round(m).toString():m.toFixed(1),f=l.c.population,r=f>=1e6?`~${(f/1e6).toFixed(1)}M`:`~${Math.round(f/1e3)}k`,h=`${l.c.name}, ${l.c.country} — ${w} ${b} — Pop ${r}`;t.font="600 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";const{w:P,h:R}=Yt(t,h);let Q=Rt(M,s,n);const Z=Math.max(0,Math.min(a-A,E-6)),$={x:Math.max(4,Math.min(n-P-4,Q-P/2)),y:Z-R,w:P,h:R};if(D){if(!I){S.add(u);continue}S.add(u);const nt=X.get(u)??0;if(nt<=.01)continue;const q=_t(M),_=6,x=q==="left"?{x:_,y:Math.max(0,Math.min(a-R,E-R/2)),w:P,h:R}:{x:n-_-P,y:Math.max(0,Math.min(a-R,E-R/2)),w:P,h:R},dt=q==="left"?C:G,bt=Math.ceil(a/(x.h+6))+2,ht=mt(x,dt,a,bt);if(ht===null)continue;x.y=ht,dt.push({...x});const K=x.y+x.h/2,ut=x.y+x.h-6;t.save(),t.globalAlpha=nt,t.strokeStyle="rgba(255,255,255,0.6)",t.fillStyle="rgba(255,255,255,0.9)",t.lineWidth=2,t.beginPath(),q==="left"?(t.moveTo(_,K),t.lineTo(_+10,K-6),t.moveTo(_,K),t.lineTo(_+10,K+6),t.stroke(),t.textAlign="left",t.fillText(h,_+16,ut)):(t.moveTo(n-_,K),t.lineTo(n-_-10,K-6),t.moveTo(n-_,K),t.lineTo(n-_-10,K+6),t.stroke(),t.textAlign="right",t.fillText(h,n-_-16,ut)),t.restore()}else{const nt=Math.ceil(a/($.h+6))+2,q=mt($,k,a,nt);if(q===null)continue;$.y=q,k.push({...$}),S.add(u);const _=X.get(u)??0;if(_<=.01)continue;t.save(),t.globalAlpha=_,t.fillStyle="rgba(0,0,0,0.45)",t.strokeStyle="rgba(255,255,255,0.2)",qt(t,$.x,$.y,$.w,$.h,6),t.fill(),t.fillStyle="white",t.shadowColor="rgba(0,0,0,0.6)",t.shadowBlur=2,t.fillText(h,$.x+6,$.y+$.h-6),t.restore()}}if(Ut(S,g),B!==!1){const u=Math.min(240,Math.floor(n*.5)),M=Math.min(140,Math.floor(a*.35)),D=n-8-u,m=a-8-M;Kt(t,{x:D,y:m,w:u,h:M,user:y,headingDeg:d,hfovDeg:s,maxDistanceKm:F,cities:p})}return{visibleCount:k.length}}function qt(t,e,o,i,n,a){t.beginPath(),t.moveTo(e+a,o),t.arcTo(e+i,o,e+i,o+n,a),t.arcTo(e+i,o+n,e,o+n,a),t.arcTo(e,o+n,e,o,a),t.arcTo(e,o,e+i,o,a),t.closePath()}const Xt=document.getElementById("camera"),U=document.getElementById("overlay"),V=U.getContext("2d");let Y={maxDistanceKm:1e3,units:"km",hfovDeg:60,headingOffsetDeg:0,smoothing:.15,showOffscreenIndicators:!1},ct={lat:39.996,lon:-74.0621},lt=!1,rt=[],at=Ct({smoothing:Y.smoothing,headingOffsetDeg:Y.headingOffsetDeg});performance.now();let et=[],zt={v:0};const Jt=Dt({settings:Y,onSettingsChange:t=>{Y=t,at.setSmoothing(t.smoothing),at.setHeadingOffset(t.headingOffsetDeg)},onStart:async()=>{Qt(),Ot().catch(()=>{}),Lt(Xt).catch(()=>{})},onManualGeo:t=>{ct=t,lt=!0,z.setGeoStatus(`${t.lat.toFixed(5)}, ${t.lon.toFixed(5)} (manual)`)}}),z=Jt;function Qt(){z.setGeoStatus("requesting…"),Tt(t=>{ct={lat:t.lat,lon:t.lon},lt=!0,z.setGeoStatus(`${t.lat.toFixed(5)}, ${t.lon.toFixed(5)} ±${Math.round(t.accuracy||0)}m`)},t=>{console.warn("Geolocation error",t);let e="location error";const o=t;if(typeof o?.code=="number")switch(o.code){case 1:e="permission denied — check site settings";break;case 2:e="position unavailable";break;case 3:e="timeout — move outdoors or check settings";break;default:e="location error"}else o?.message&&(e=o.message);z.setGeoStatus(e),z.showManualGeo(!0)})}async function Zt(){rt=await(await fetch("./cities.json")).json()}function Mt(){const t=U.getBoundingClientRect();U.width=t.width*window.devicePixelRatio,U.height=t.height*window.devicePixelRatio}window.addEventListener("resize",Mt);Mt();let pt=performance.now(),st=0;at.subscribe(t=>{st++;const e=performance.now();if(e-pt>1e3){et.push(st),et.length>4&&et.shift();const o=et.reduce((i,n)=>i+n,0)/et.length;z.updateDebug(t.headingDeg,t.pitchDeg,t.rollDeg,t.source,o),st=0,pt=e}});function yt(){const t=performance.now();let e=window.__arc_heading??0,o=window.__arc_pitch??0;window.__arc_bound||(window.__arc_bound=!0,at.subscribe(a=>{window.__arc_heading=a.headingDeg,window.__arc_pitch=a.pitchDeg,window.__arc_roll=a.rollDeg}));const i=U.clientWidth,n=U.clientHeight;U.width=Math.floor(i*window.devicePixelRatio),U.height=Math.floor(n*window.devicePixelRatio),V.setTransform(window.devicePixelRatio,0,0,window.devicePixelRatio,0,0),lt&&rt.length>0?jt(V,{width:i,height:n,hfovDeg:Y.hfovDeg,pitchDeg:o,headingDeg:e,units:Y.units,maxDistanceKm:Y.maxDistanceKm,user:ct,cities:rt,showOffscreenIndicators:Y.showOffscreenIndicators},t,zt):(V.clearRect(0,0,i,n),V.fillStyle="rgba(255,255,255,0.7)",V.font="600 16px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial",V.textAlign="center",V.fillText("Press Start and allow permissions",i/2,n/2)),requestAnimationFrame(yt)}Zt();requestAnimationFrame(yt);"serviceWorker"in navigator&&navigator.serviceWorker.register("./sw.js").catch(()=>{});
