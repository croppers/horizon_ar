(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function o(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(n){if(n.ep)return;n.ep=!0;const i=o(n);fetch(n.href,i)}})();const ye="arcities.settings.v2";function De(){try{const e=localStorage.getItem(ye);if(e)return JSON.parse(e)}catch{}return{maxDistanceKm:1e3,units:"km",hfovDeg:60,headingOffsetDeg:0,smoothing:.15,showOffscreenIndicators:!1}}function Ie(e){try{localStorage.setItem(ye,JSON.stringify(e))}catch{}}function ke(e){const t=e.settings||De();e.settings=t;const o=document.getElementById("startBtn"),a=document.getElementById("helpBtn"),n=document.getElementById("onboarding"),i=document.getElementById("collapseBtn"),r=document.getElementById("controlsBody"),u=document.getElementById("distance"),l=document.getElementById("distanceValue"),d=document.getElementById("unitsKm"),c=document.getElementById("unitsMi"),s=document.getElementById("hfov"),h=document.getElementById("hfovValue"),f=document.getElementById("headingOffset"),w=document.getElementById("headingOffsetValue"),M=document.getElementById("smooth"),L=document.getElementById("smoothValue"),D=document.getElementById("showOffscreen"),A=document.getElementById("dbgHeading"),b=document.getElementById("dbgPitch"),G=document.getElementById("dbgRoll"),T=document.getElementById("dbgSource"),C=document.getElementById("dbgRate"),H=document.getElementById("dbgSmooth"),_=document.getElementById("geoText"),y=document.getElementById("manualGeo"),g=document.getElementById("lat"),m=document.getElementById("lon"),S=document.getElementById("setGeo");localStorage.getItem("arcities.onboarded")||n.showModal(),document.getElementById("onboardingClose").addEventListener("click",()=>{localStorage.setItem("arcities.onboarded","1")}),a.addEventListener("click",()=>n.showModal()),i.addEventListener("click",()=>{const p=!(i.getAttribute("aria-expanded")==="true");i.setAttribute("aria-expanded",String(p)),r.style.display=p?"block":"none",i.textContent=p?"▾":"▸"}),u.value=String(t.maxDistanceKm),s.value=String(t.hfovDeg),f.value=String(t.headingOffsetDeg),M.value=String(t.smoothing),t.units==="km"?d.checked=!0:c.checked=!0,D.checked=!!t.showOffscreenIndicators;function I(v,p){if(p==="km")return`${Math.round(v)} km`;const k=v*.621371;return`${Math.round(k)} mi`}function E(){l.textContent=I(Number(u.value),t.units),h.textContent=`${s.value}°`,w.textContent=`${f.value}°`,L.textContent=`${Number(M.value).toFixed(2)}`}E();function P(){Ie(t),e.onSettingsChange?.(t),E()}return u.addEventListener("input",()=>{t.maxDistanceKm=Number(u.value),P()}),s.addEventListener("input",()=>{t.hfovDeg=Number(s.value),P()}),f.addEventListener("input",()=>{t.headingOffsetDeg=Number(f.value),P()}),M.addEventListener("input",()=>{t.smoothing=Number(M.value),P()}),D.addEventListener("change",()=>{t.showOffscreenIndicators=D.checked,P()}),d.addEventListener("change",()=>{t.units="km",P()}),c.addEventListener("change",()=>{t.units="mi",P()}),o.addEventListener("click",()=>e.onStart?.()),S.addEventListener("click",()=>{const v=Number(g.value),p=Number(m.value);!Number.isFinite(v)||!Number.isFinite(p)||e.onManualGeo?.({lat:v,lon:p})}),{setGeoStatus(v){_.textContent=v},showManualGeo(v){y.classList.toggle("hidden",!v)},updateDebug(v,p,k,R,B){A.textContent=v.toFixed(1),b.textContent=p.toFixed(1),G.textContent=k.toFixed(1),T.textContent=R,C.textContent=B?B.toFixed(0):"–",H.textContent=t.smoothing.toFixed(2)},getSettings(){return t}}}function J(e){return e*Math.PI/180}function Oe(e){return e*180/Math.PI}function K(e){let t=e%360;return t<0&&(t+=360),t}function Z(e){return((e+180)%360+360)%360-180}function ve(e,t,o,a){const n=6371.0088,i=J(o-e),r=J(a-t),u=Math.sin(i/2)**2+Math.cos(J(e))*Math.cos(J(o))*Math.sin(r/2)**2,l=2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u));return n*l}function Le(e,t,o,a){const n=J(e),i=J(o),r=J(a-t),u=Math.sin(r)*Math.cos(i),l=Math.cos(n)*Math.sin(i)-Math.sin(n)*Math.cos(i)*Math.cos(r),d=Oe(Math.atan2(u,l));return K(d)}function Te(e,t,o){const a=Z(t-e);return K(e+a*(1-Math.exp(-o)))}function he(e,t,o){return e+(t-e)*(1-Math.exp(-o))}async function Be(){try{const e=window,t=e.DeviceMotionEvent&&typeof e.DeviceMotionEvent.requestPermission=="function"?await e.DeviceMotionEvent.requestPermission():"granted",o=e.DeviceOrientationEvent&&typeof e.DeviceOrientationEvent.requestPermission=="function"?await e.DeviceOrientationEvent.requestPermission():"granted"}catch{}}async function Ce(e){try{const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}},audio:!1});return e.srcObject=t,await e.play(),t}catch(t){return console.warn("Camera access failed",t),null}}function Re(e,t){if(!("geolocation"in navigator))return t(new DOMException("Geolocation not supported")),()=>{};if(!window.isSecureContext)return t(new DOMException("Geolocation requires HTTPS")),()=>{};let o=null;const a={enableHighAccuracy:!0,maximumAge:5e3,timeout:2e4};try{navigator.geolocation.getCurrentPosition(n=>{const{latitude:i,longitude:r,accuracy:u}=n.coords;e({lat:i,lon:r,accuracy:u})},n=>{t(n)},a)}catch(n){t(n)}try{o=navigator.geolocation.watchPosition(n=>{const{latitude:i,longitude:r,accuracy:u}=n.coords;e({lat:i,lon:r,accuracy:u})},n=>t(n),a)}catch(n){t(n)}return()=>{o!==null&&navigator.geolocation.clearWatch(o)}}function Ae(e,t,o,a){const n=t*t,i=2*(a*e+t*o),r=1-2*(e*e+n),u=Math.atan2(i,r);let l=2*(a*t-o*e);l=Math.max(-1,Math.min(1,l));const d=Math.asin(l),c=2*(a*o+e*t),s=1-2*(n+o*o);return{yaw:Math.atan2(c,s)*180/Math.PI,pitch:d*180/Math.PI,roll:u*180/Math.PI}}function Fe(e){let t=e.smoothing,o=e.headingOffsetDeg,a=new Set,n="deviceorientation+motion",i=null,r=0,u=0,l=0,d=0,c={headingDeg:0,pitchDeg:0,rollDeg:0,timestamp:performance.now()};const s=.02,h=.01;let f=null;const w=window,M=w.AbsoluteOrientationSensor,L=w.RelativeOrientationSensor;let D=null;function A(y){const g=K(r+o),m=u,S=l,I=Te(c.headingDeg,g,t),E=he(c.pitchDeg,m,t),P=he(c.rollDeg,S,t),v={headingDeg:I,pitchDeg:E,rollDeg:P,source:n,timestamp:y};c=v,a.forEach(p=>p(v))}function b(){try{const y=M||L;if(!y)return!1;const g=new y({frequency:60});return D=g,n="generic-sensor",g.onreading=()=>{const m=g.quaternion;if(!m)return;const{yaw:S,pitch:I,roll:E}=Ae(m[0],m[1],m[2],m[3]);r=K(S),u=I,l=E,A(performance.now())},g.onerror=()=>{},g.start(),!0}catch{return!1}}function G(){n="deviceorientation+motion";function y(m){const S=m;typeof S.webkitCompassHeading=="number"?f=K(S.webkitCompassHeading):typeof m.alpha=="number"&&(f=K(m.alpha))}function g(m){const S=performance.now(),I=d?(S-d)/1e3:0;d=S;const E=m.rotationRate;if(E){const v=E.alpha??0,p=E.beta??0,k=E.gamma??0;r=K(r+v*I),u=u+p*I,l=l+k*I}const P=m.accelerationIncludingGravity;if(P){const v=P.x??0,p=P.y??0,k=P.z??-9.8,R=Math.atan2(-v,Math.hypot(p,k))*180/Math.PI,B=Math.atan2(p,k)*180/Math.PI;u=u*(1-s)+R*s,l=l*(1-s)+B*s}if(f!=null){const v=Z(f-r);r=K(r+v*h)}A(S)}return window.addEventListener("deviceorientation",y,!0),window.addEventListener("devicemotion",g,!0),()=>{window.removeEventListener("deviceorientation",y,!0),window.removeEventListener("devicemotion",g,!0)}}let T=[];function C(){n="virtual";let y=!1,g=0,m=0;const S=.1,I=.1;function E(p){y=!0,g=p.clientX,m=p.clientY,p.target.setPointerCapture?.(p.pointerId)}function P(p){y=!1,p.target.releasePointerCapture?.(p.pointerId)}function v(p){if(!y)return;const k=p.clientX-g,R=p.clientY-m;g=p.clientX,m=p.clientY,r=K(r+k*S),u=Math.max(-89,Math.min(89,u-R*I)),A(performance.now())}window.addEventListener("pointerdown",E),window.addEventListener("pointerup",P),window.addEventListener("pointermove",v),T.push(()=>{window.removeEventListener("pointerdown",E),window.removeEventListener("pointerup",P),window.removeEventListener("pointermove",v)})}if(!b()){const y=G();T.push(y);const g=setTimeout(()=>{d===0&&f==null&&C()},2e3);T.push(()=>clearTimeout(g))}function _(){A(performance.now()),i=requestAnimationFrame(_)}return i=requestAnimationFrame(_),{subscribe(y){return a.add(y),()=>a.delete(y)},setSmoothing(y){t=Math.max(0,Math.min(.3,y))},setHeadingOffset(y){o=y},getSource(){return n},stop(){i!==null&&cancelAnimationFrame(i),T.forEach(y=>y()),D?.stop?.(),a.clear()}}}function Ge(e,t,o){const a=o/2,n=e/t*a+a;return Math.max(0,Math.min(o,n))}function _e(e,t,o){const a=o/2,n=-e/t*a+a;return Math.max(0,Math.min(o,n))}function $e(e,t,o){return e*(o/Math.max(1,t))}function He(e,t){const o=t/2;return e>=-o&&e<=o}function Ne(e){return e<0?"left":"right"}function Ke(e){return e}function We(e){if(e==null)return Ke;var t,o,a=e.scale[0],n=e.scale[1],i=e.translate[0],r=e.translate[1];return function(u,l){l||(t=o=0);var d=2,c=u.length,s=new Array(c);for(s[0]=(t+=u[0])*a+i,s[1]=(o+=u[1])*n+r;d<c;)s[d]=u[d],++d;return s}}function je(e,t){for(var o,a=e.length,n=a-t;n<--a;)o=e[n],e[n++]=e[a],e[a]=o}function Ye(e,t){return typeof t=="string"&&(t=e.objects[t]),t.type==="GeometryCollection"?{type:"FeatureCollection",features:t.geometries.map(function(o){return fe(e,o)})}:fe(e,t)}function fe(e,t){var o=t.id,a=t.bbox,n=t.properties==null?{}:t.properties,i=we(e,t);return o==null&&a==null?{type:"Feature",properties:n,geometry:i}:a==null?{type:"Feature",id:o,properties:n,geometry:i}:{type:"Feature",id:o,bbox:a,properties:n,geometry:i}}function we(e,t){var o=We(e.transform),a=e.arcs;function n(c,s){s.length&&s.pop();for(var h=a[c<0?~c:c],f=0,w=h.length;f<w;++f)s.push(o(h[f],f));c<0&&je(s,w)}function i(c){return o(c)}function r(c){for(var s=[],h=0,f=c.length;h<f;++h)n(c[h],s);return s.length<2&&s.push(s[0]),s}function u(c){for(var s=r(c);s.length<4;)s.push(s[0]);return s}function l(c){return c.map(u)}function d(c){var s=c.type,h;switch(s){case"GeometryCollection":return{type:s,geometries:c.geometries.map(d)};case"Point":h=i(c.coordinates);break;case"MultiPoint":h=c.coordinates.map(i);break;case"LineString":h=r(c.arcs);break;case"MultiLineString":h=c.arcs.map(r);break;case"Polygon":h=l(c.arcs);break;case"MultiPolygon":h=c.arcs.map(l);break;default:return null}return{type:s,coordinates:h}}return d(t)}function Ve(e,t){var o={},a={},n={},i=[],r=-1;t.forEach(function(d,c){var s=e.arcs[d<0?~d:d],h;s.length<3&&!s[1][0]&&!s[1][1]&&(h=t[++r],t[r]=d,t[c]=h)}),t.forEach(function(d){var c=u(d),s=c[0],h=c[1],f,w;if(f=n[s])if(delete n[f.end],f.push(d),f.end=h,w=a[h]){delete a[w.start];var M=w===f?f:f.concat(w);a[M.start=f.start]=n[M.end=w.end]=M}else a[f.start]=n[f.end]=f;else if(f=a[h])if(delete a[f.start],f.unshift(d),f.start=s,w=n[s]){delete n[w.end];var L=w===f?f:w.concat(f);a[L.start=w.start]=n[L.end=f.end]=L}else a[f.start]=n[f.end]=f;else f=[d],a[f.start=s]=n[f.end=h]=f});function u(d){var c=e.arcs[d<0?~d:d],s=c[0],h;return e.transform?(h=[0,0],c.forEach(function(f){h[0]+=f[0],h[1]+=f[1]})):h=c[c.length-1],d<0?[h,s]:[s,h]}function l(d,c){for(var s in d){var h=d[s];delete c[h.start],delete h.start,delete h.end,h.forEach(function(f){o[f<0?~f:f]=1}),i.push(h)}}return l(n,a),l(a,n),t.forEach(function(d){o[d<0?~d:d]||i.push([d])}),i}function qe(e){return we(e,Je.apply(this,arguments))}function Je(e,t,o){var a,n,i;if(arguments.length>1)a=Ue(e,t,o);else for(n=0,a=new Array(i=e.arcs.length);n<i;++n)a[n]=n;return{type:"MultiLineString",arcs:Ve(e,a)}}function Ue(e,t,o){var a=[],n=[],i;function r(s){var h=s<0?~s:s;(n[h]||(n[h]=[])).push({i:s,g:i})}function u(s){s.forEach(r)}function l(s){s.forEach(u)}function d(s){s.forEach(l)}function c(s){switch(i=s,s.type){case"GeometryCollection":s.geometries.forEach(c);break;case"LineString":u(s.arcs);break;case"MultiLineString":case"Polygon":l(s.arcs);break;case"MultiPolygon":d(s.arcs);break}}return c(t),n.forEach(o==null?function(s){a.push(s[0].i)}:function(s){o(s[0].g,s[s.length-1].g)&&a.push(s[0].i)}),a}const Xe="https://unpkg.com/world-atlas@2/countries-110m.json";let X=null,ee=null,ae=null;async function ze(){if(X)return;const e=await fetch(Xe,{cache:"force-cache"});if(!e.ok)throw new Error("Failed to load world topojson");X=await e.json(),ee=Ye(X,X.objects.land),ae=qe(X,X.objects.countries,(a,n)=>a!==n)}function j(e,t,o,a,n,i){const r=o+(e+180)/360*n,u=a+(90-t)/180*i;return{px:r,py:u}}function $(e){return e*Math.PI/180}function ge(e){return e*180/Math.PI}function oe(e,t,o,a){const i=a/6371,r=$(o),u=$(e),l=$(t),d=Math.sin(u),c=Math.cos(u),s=Math.sin(i),h=Math.cos(i),f=d*h+c*s*Math.cos(r),w=Math.asin(Math.max(-1,Math.min(1,f))),M=Math.sin(r)*s*c,L=h-d*f,D=l+Math.atan2(M,L);return{lat:ge(w),lon:(ge(D)+540)%360-180}}function Qe(e,t,o,a,n,i){e.beginPath(),e.moveTo(t+i,o),e.arcTo(t+a,o,t+a,o+n,i),e.arcTo(t+a,o+n,t,o+n,i),e.arcTo(t,o+n,t,o,i),e.arcTo(t,o,t+a,o,i),e.closePath()}function Ze(e,t,o,a,n,i){for(const r of t.coordinates){for(let u=0;u<r.length;u++){const[l,d]=r[u],{px:c,py:s}=j(l,d,o,a,n,i);u===0?e.moveTo(c,s):e.lineTo(c,s)}e.closePath()}}function xe(e,t,o,a,n,i){for(const r of t.coordinates)for(const u of r){for(let l=0;l<u.length;l++){const[d,c]=u[l],{px:s,py:h}=j(d,c,o,a,n,i);l===0?e.moveTo(s,h):e.lineTo(s,h)}e.closePath()}}function et(e,t,o,a,n,i){const r=t.type==="LineString"?[t.coordinates]:t.coordinates;for(const u of r)for(let l=0;l<u.length;l++){const[d,c]=u[l],{px:s,py:h}=j(d,c,o,a,n,i);l===0?e.moveTo(s,h):e.lineTo(s,h)}}async function tt(e,t){const{x:o,y:a,w:n,h:i,user:r,headingDeg:u,hfovDeg:l,maxDistanceKm:d,cities:c}=t;e.save(),e.globalAlpha=.95,e.fillStyle="rgba(10,12,14,0.7)",Qe(e,o,a,n,i,8),e.fill(),e.restore();try{await ze()}catch{}ee&&(e.save(),e.strokeStyle="rgba(120,160,120,0.6)",e.fillStyle="rgba(40,80,50,0.35)",e.lineWidth=1,e.beginPath(),ee.type==="Polygon"?Ze(e,ee,o,a,n,i):xe(e,ee,o,a,n,i),e.fill(),e.stroke(),e.restore()),ae&&(e.save(),e.strokeStyle="rgba(90,120,150,0.5)",e.lineWidth=.75,e.beginPath(),et(e,ae,o,a,n,i),e.stroke(),e.restore());const s=j(r.lon,r.lat,o,a,n,i);e.save(),e.fillStyle="rgba(255,255,255,0.9)",e.beginPath(),e.arc(s.px,s.py,2.5,0,Math.PI*2),e.fill(),e.restore(),e.save(),e.strokeStyle="rgba(255,255,255,0.4)",e.lineWidth=1,e.beginPath();const h=128;for(let b=0;b<=h;b++){const G=b/h*360,T=oe(r.lat,r.lon,G,d),C=j(T.lon,T.lat,o,a,n,i);b===0?e.moveTo(C.px,C.py):e.lineTo(C.px,C.py)}e.closePath(),e.stroke(),e.restore(),e.save(),e.strokeStyle="rgba(255,220,120,0.7)",e.fillStyle="rgba(255,220,120,0.15)",e.lineWidth=1;const f=Z(u-l/2),w=Z(u+l/2),M=oe(r.lat,r.lon,f,d),L=oe(r.lat,r.lon,w,d),D=j(M.lon,M.lat,o,a,n,i),A=j(L.lon,L.lat,o,a,n,i);e.beginPath(),e.moveTo(s.px,s.py),e.lineTo(D.px,D.py),e.lineTo(A.px,A.py),e.closePath(),e.fill(),e.stroke(),e.restore(),e.save();for(const b of c){const T=ve(r.lat,r.lon,b.lat,b.lon)<=d,{px:C,py:H}=j(b.lon,b.lat,o,a,n,i);let _=.25,y="rgba(180,220,255,";if(T){const g=Math.atan2(Math.sin($(b.lon-r.lon))*Math.cos($(b.lat)),Math.cos($(r.lat))*Math.sin($(b.lat))-Math.sin($(r.lat))*Math.cos($(b.lat))*Math.cos($(b.lon-r.lon)))*180/Math.PI;Math.abs(Z(g-u))<=l/2?(_=.9,y="rgba(255,255,255,"):(_=.6,y="rgba(120,180,255,")}e.fillStyle=`${y}${_})`,e.fillRect(C-1,H-1,2,2)}e.restore()}const nt=e=>`${e.name}|${e.country}`,z=new Map;function ot(e,t){const n=new Set([...z.keys(),...e.keys()]);for(const i of n){const r=z.get(i)??0,u=e.has(i),l=u?Math.min(1,r+4*t):Math.max(0,r-3*t);l<=0&&!u?z.delete(i):z.set(i,l)}}function it(e,t){return{w:e.measureText(t).width+12,h:24}}function at(e,t){return!(e.x+e.w<t.x||t.x+t.w<e.x||e.y+e.h<t.y||t.y+t.h<e.y)}function me(e,t,o,a=12){const n=new Set,i=Math.max(12,e.h+6),r=e.y,u=[r];for(let l=1;l<=a;l++)u.push(r-l*i);for(let l=1;l<=a;l++)u.push(r+l*i);for(let l of u){if(l=Math.max(0,Math.min(o-e.h,l)),n.has(l))continue;n.add(l);const d={x:e.x,y:l,w:e.w,h:e.h};if(!t.some(c=>at(c,d)))return l}return null}function st(e,t,o,a){const{width:n,height:i,hfovDeg:r,pitchDeg:u,headingDeg:l,cities:d,user:c,units:s,maxDistanceKm:h,showOffscreenIndicators:f,showMinimap:w}=t,M=Math.max(1,window.devicePixelRatio||1);(e.canvas.width!==Math.floor(n*M)||e.canvas.height!==Math.floor(i*M))&&(e.canvas.width=Math.floor(n*M),e.canvas.height=Math.floor(i*M)),e.setTransform(M,0,0,M,0,0),e.clearRect(0,0,n,i);const L=$e(r,n,i),D=_e(u,L,i);e.save(),e.strokeStyle="rgba(180,200,220,0.25)",e.lineWidth=2,e.beginPath(),e.moveTo(0,D),e.lineTo(n,D),e.stroke(),e.restore();const A=.621371,b=d.map(g=>{const m=ve(c.lat,c.lon,g.lat,g.lon);return{c:g,distKm:m,bearing:Le(c.lat,c.lon,g.lat,g.lon)}}).filter(g=>g.distKm<=h);b.sort((g,m)=>m.c.population-g.c.population);const G=[],T=[],C=[],H=new Set,_=24,y=a.v?Math.min(.1,(o-a.v)/1e3):0;a.v=o;for(const g of b){const m=nt(g.c),S=Z(g.bearing-l),I=!He(S,r),E=s==="km"?g.distKm:g.distKm*A,P=E>=100?Math.round(E).toString():E.toFixed(1),v=g.c.population,p=v>=1e6?`~${(v/1e6).toFixed(1)}M`:`~${Math.round(v/1e3)}k`,k=`${g.c.name}, ${g.c.country} — ${P} ${s} — Pop ${p}`;e.font="600 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";const{w:R,h:B}=it(e,k);let Se=Ge(S,r,n);const Ee=Math.max(0,Math.min(i-_,D-6)),F={x:Math.max(4,Math.min(n-R-4,Se-R/2)),y:Ee-B,w:R,h:B};if(I){if(!f){H.add(m);continue}H.add(m);const te=z.get(m)??0;if(te<=.01)continue;const U=Ne(S),O=6,N=U==="left"?{x:O,y:Math.max(0,Math.min(i-B,D-B/2)),w:R,h:B}:{x:n-O-R,y:Math.max(0,Math.min(i-B,D-B/2)),w:R,h:B},le=U==="left"?T:C,Pe=Math.ceil(i/(N.h+6))+2,ue=me(N,le,i,Pe);if(ue===null)continue;N.y=ue,le.push({...N});const W=N.y+N.h/2,de=N.y+N.h-6;e.save(),e.globalAlpha=te,e.strokeStyle="rgba(255,255,255,0.6)",e.fillStyle="rgba(255,255,255,0.9)",e.lineWidth=2,e.beginPath(),U==="left"?(e.moveTo(O,W),e.lineTo(O+10,W-6),e.moveTo(O,W),e.lineTo(O+10,W+6),e.stroke(),e.textAlign="left",e.fillText(k,O+16,de)):(e.moveTo(n-O,W),e.lineTo(n-O-10,W-6),e.moveTo(n-O,W),e.lineTo(n-O-10,W+6),e.stroke(),e.textAlign="right",e.fillText(k,n-O-16,de)),e.restore()}else{const te=Math.ceil(i/(F.h+6))+2,U=me(F,G,i,te);if(U===null)continue;F.y=U,G.push({...F}),H.add(m);const O=z.get(m)??0;if(O<=.01)continue;e.save(),e.globalAlpha=O,e.fillStyle="rgba(0,0,0,0.45)",e.strokeStyle="rgba(255,255,255,0.2)",rt(e,F.x,F.y,F.w,F.h,6),e.fill(),e.fillStyle="white",e.shadowColor="rgba(0,0,0,0.6)",e.shadowBlur=2,e.fillText(k,F.x+6,F.y+F.h-6),e.restore()}}if(ot(H,y),w!==!1){const m=Math.min(240,Math.floor(n*.5)),S=Math.min(140,Math.floor(i*.35)),I=n-8-m,E=i-8-S;tt(e,{x:I,y:E,w:m,h:S,user:c,headingDeg:l,hfovDeg:r,maxDistanceKm:h,cities:d})}return{visibleCount:G.length}}function rt(e,t,o,a,n,i){e.beginPath(),e.moveTo(t+i,o),e.arcTo(t+a,o,t+a,o+n,i),e.arcTo(t+a,o+n,t,o+n,i),e.arcTo(t,o+n,t,o,i),e.arcTo(t,o,t+a,o,i),e.closePath()}const ct=document.getElementById("camera"),Y=document.getElementById("overlay"),q=Y.getContext("2d");let V={maxDistanceKm:1e3,units:"km",hfovDeg:60,headingOffsetDeg:0,smoothing:.15,showOffscreenIndicators:!1},re={lat:39.996,lon:-74.0621},ce=!1,se=[],ne=Fe({smoothing:V.smoothing,headingOffsetDeg:V.headingOffsetDeg});performance.now();let x=[],lt={v:0};const ut=ke({settings:V,onSettingsChange:e=>{V=e,ne.setSmoothing(e.smoothing),ne.setHeadingOffset(e.headingOffsetDeg)},onStart:async()=>{dt(),Be().catch(()=>{}),Ce(ct).catch(()=>{})},onManualGeo:e=>{re=e,ce=!0,Q.setGeoStatus(`${e.lat.toFixed(5)}, ${e.lon.toFixed(5)} (manual)`)}}),Q=ut;function dt(){Q.setGeoStatus("requesting…"),Re(e=>{re={lat:e.lat,lon:e.lon},ce=!0,Q.setGeoStatus(`${e.lat.toFixed(5)}, ${e.lon.toFixed(5)} ±${Math.round(e.accuracy||0)}m`)},e=>{console.warn("Geolocation error",e);let t="location error";const o=e;if(typeof o?.code=="number")switch(o.code){case 1:t="permission denied — check site settings";break;case 2:t="position unavailable";break;case 3:t="timeout — move outdoors or check settings";break;default:t="location error"}else o?.message&&(t=o.message);Q.setGeoStatus(t),Q.showManualGeo(!0)})}async function ht(){se=await(await fetch("./cities.json")).json()}function Me(){const e=Y.getBoundingClientRect();Y.width=e.width*window.devicePixelRatio,Y.height=e.height*window.devicePixelRatio}window.addEventListener("resize",Me);Me();let pe=performance.now(),ie=0;ne.subscribe(e=>{ie++;const t=performance.now();if(t-pe>1e3){x.push(ie),x.length>4&&x.shift();const o=x.reduce((a,n)=>a+n,0)/x.length;Q.updateDebug(e.headingDeg,e.pitchDeg,e.rollDeg,e.source,o),ie=0,pe=t}});function be(){const e=performance.now();let t=window.__arc_heading??0,o=window.__arc_pitch??0;window.__arc_bound||(window.__arc_bound=!0,ne.subscribe(i=>{window.__arc_heading=i.headingDeg,window.__arc_pitch=i.pitchDeg,window.__arc_roll=i.rollDeg}));const a=Y.clientWidth,n=Y.clientHeight;Y.width=Math.floor(a*window.devicePixelRatio),Y.height=Math.floor(n*window.devicePixelRatio),q.setTransform(window.devicePixelRatio,0,0,window.devicePixelRatio,0,0),ce&&se.length>0?st(q,{width:a,height:n,hfovDeg:V.hfovDeg,pitchDeg:o,headingDeg:t,units:V.units,maxDistanceKm:V.maxDistanceKm,user:re,cities:se,showOffscreenIndicators:V.showOffscreenIndicators},e,lt):(q.clearRect(0,0,a,n),q.fillStyle="rgba(255,255,255,0.7)",q.font="600 16px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial",q.textAlign="center",q.fillText("Press Start and allow permissions",a/2,n/2)),requestAnimationFrame(be)}ht();requestAnimationFrame(be);"serviceWorker"in navigator&&navigator.serviceWorker.register("./sw.js").catch(()=>{});
