(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function o(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(n){if(n.ep)return;n.ep=!0;const i=o(n);fetch(n.href,i)}})();const le="arcities.settings.v2";function ge(){try{const e=localStorage.getItem(le);if(e)return JSON.parse(e)}catch{}return{maxDistanceKm:1e3,units:"km",hfovDeg:60,headingOffsetDeg:0,smoothing:.15,showOffscreenIndicators:!1}}function me(e){try{localStorage.setItem(le,JSON.stringify(e))}catch{}}function fe(e){const t=e.settings||ge();e.settings=t;const o=document.getElementById("startBtn"),a=document.getElementById("helpBtn"),n=document.getElementById("onboarding"),i=document.getElementById("collapseBtn"),r=document.getElementById("controlsBody"),d=document.getElementById("distance"),c=document.getElementById("distanceValue"),y=document.getElementById("unitsKm"),p=document.getElementById("unitsMi"),b=document.getElementById("hfov"),K=document.getElementById("hfovValue"),D=document.getElementById("headingOffset"),I=document.getElementById("headingOffsetValue"),k=document.getElementById("smooth"),O=document.getElementById("smoothValue"),x=document.getElementById("showOffscreen"),B=document.getElementById("dbgHeading"),F=document.getElementById("dbgPitch"),X=document.getElementById("dbgRoll"),T=document.getElementById("dbgSource"),C=document.getElementById("dbgRate"),z=document.getElementById("dbgSmooth"),N=document.getElementById("geoText"),s=document.getElementById("manualGeo"),u=document.getElementById("lat"),g=document.getElementById("lon"),w=document.getElementById("setGeo");localStorage.getItem("arcities.onboarded")||n.showModal(),document.getElementById("onboardingClose").addEventListener("click",()=>{localStorage.setItem("arcities.onboarded","1")}),a.addEventListener("click",()=>n.showModal()),i.addEventListener("click",()=>{const l=!(i.getAttribute("aria-expanded")==="true");i.setAttribute("aria-expanded",String(l)),r.style.display=l?"block":"none",i.textContent=l?"▾":"▸"}),d.value=String(t.maxDistanceKm),b.value=String(t.hfovDeg),D.value=String(t.headingOffsetDeg),k.value=String(t.smoothing),t.units==="km"?y.checked=!0:p.checked=!0,x.checked=!!t.showOffscreenIndicators;function M(h,l){if(l==="km")return`${Math.round(h)} km`;const f=h*.621371;return`${Math.round(f)} mi`}function v(){c.textContent=M(Number(d.value),t.units),K.textContent=`${b.value}°`,I.textContent=`${D.value}°`,O.textContent=`${Number(k.value).toFixed(2)}`}v();function m(){me(t),e.onSettingsChange?.(t),v()}return d.addEventListener("input",()=>{t.maxDistanceKm=Number(d.value),m()}),b.addEventListener("input",()=>{t.hfovDeg=Number(b.value),m()}),D.addEventListener("input",()=>{t.headingOffsetDeg=Number(D.value),m()}),k.addEventListener("input",()=>{t.smoothing=Number(k.value),m()}),x.addEventListener("change",()=>{t.showOffscreenIndicators=x.checked,m()}),y.addEventListener("change",()=>{t.units="km",m()}),p.addEventListener("change",()=>{t.units="mi",m()}),o.addEventListener("click",()=>e.onStart?.()),w.addEventListener("click",()=>{const h=Number(u.value),l=Number(g.value);!Number.isFinite(h)||!Number.isFinite(l)||e.onManualGeo?.({lat:h,lon:l})}),{setGeoStatus(h){N.textContent=h},showManualGeo(h){s.classList.toggle("hidden",!h)},updateDebug(h,l,f,E,Y){B.textContent=h.toFixed(1),F.textContent=l.toFixed(1),X.textContent=f.toFixed(1),T.textContent=E,C.textContent=Y?Y.toFixed(0):"–",z.textContent=t.smoothing.toFixed(2)},getSettings(){return t}}}function H(e){return e*Math.PI/180}function pe(e){return e*180/Math.PI}function L(e){let t=e%360;return t<0&&(t+=360),t}function ee(e){return((e+180)%360+360)%360-180}function we(e,t,o,a){const n=6371.0088,i=H(o-e),r=H(a-t),d=Math.sin(i/2)**2+Math.cos(H(e))*Math.cos(H(o))*Math.sin(r/2)**2,c=2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d));return n*c}function ve(e,t,o,a){const n=H(e),i=H(o),r=H(a-t),d=Math.sin(r)*Math.cos(i),c=Math.cos(n)*Math.sin(i)-Math.sin(n)*Math.cos(i)*Math.cos(r),y=pe(Math.atan2(d,c));return L(y)}function ye(e,t,o){const a=ee(t-e);return L(e+a*(1-Math.exp(-o)))}function se(e,t,o){return e+(t-e)*(1-Math.exp(-o))}async function Me(){try{const e=window,t=e.DeviceMotionEvent&&typeof e.DeviceMotionEvent.requestPermission=="function"?await e.DeviceMotionEvent.requestPermission():"granted",o=e.DeviceOrientationEvent&&typeof e.DeviceOrientationEvent.requestPermission=="function"?await e.DeviceOrientationEvent.requestPermission():"granted"}catch{}}async function be(e){try{const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}},audio:!1});return e.srcObject=t,await e.play(),t}catch(t){return console.warn("Camera access failed",t),null}}function Ee(e,t){if(!("geolocation"in navigator))return t(new DOMException("Geolocation not supported")),()=>{};if(!window.isSecureContext)return t(new DOMException("Geolocation requires HTTPS")),()=>{};let o=null;const a={enableHighAccuracy:!0,maximumAge:5e3,timeout:2e4};try{navigator.geolocation.getCurrentPosition(n=>{const{latitude:i,longitude:r,accuracy:d}=n.coords;e({lat:i,lon:r,accuracy:d})},n=>{t(n)},a)}catch(n){t(n)}try{o=navigator.geolocation.watchPosition(n=>{const{latitude:i,longitude:r,accuracy:d}=n.coords;e({lat:i,lon:r,accuracy:d})},n=>t(n),a)}catch(n){t(n)}return()=>{o!==null&&navigator.geolocation.clearWatch(o)}}function Se(e,t,o,a){const n=t*t,i=2*(a*e+t*o),r=1-2*(e*e+n),d=Math.atan2(i,r);let c=2*(a*t-o*e);c=Math.max(-1,Math.min(1,c));const y=Math.asin(c),p=2*(a*o+e*t),b=1-2*(n+o*o);return{yaw:Math.atan2(p,b)*180/Math.PI,pitch:y*180/Math.PI,roll:d*180/Math.PI}}function De(e){let t=e.smoothing,o=e.headingOffsetDeg,a=new Set,n="deviceorientation+motion",i=null,r=0,d=0,c=0,y=0,p={headingDeg:0,pitchDeg:0,rollDeg:0,timestamp:performance.now()};const b=.02,K=.01;let D=null;const I=window,k=I.AbsoluteOrientationSensor,O=I.RelativeOrientationSensor;let x=null;function B(s){const u=L(r+o),g=d,w=c,M=ye(p.headingDeg,u,t),v=se(p.pitchDeg,g,t),m=se(p.rollDeg,w,t),h={headingDeg:M,pitchDeg:v,rollDeg:m,source:n,timestamp:s};p=h,a.forEach(l=>l(h))}function F(){try{const s=k||O;if(!s)return!1;const u=new s({frequency:60});return x=u,n="generic-sensor",u.onreading=()=>{const g=u.quaternion;if(!g)return;const{yaw:w,pitch:M,roll:v}=Se(g[0],g[1],g[2],g[3]);r=L(w),d=M,c=v,B(performance.now())},u.onerror=()=>{},u.start(),!0}catch{return!1}}function X(){n="deviceorientation+motion";function s(g){const w=g;typeof w.webkitCompassHeading=="number"?D=L(w.webkitCompassHeading):typeof g.alpha=="number"&&(D=L(g.alpha))}function u(g){const w=performance.now(),M=y?(w-y)/1e3:0;y=w;const v=g.rotationRate;if(v){const h=v.alpha??0,l=v.beta??0,f=v.gamma??0;r=L(r+h*M),d=d+l*M,c=c+f*M}const m=g.accelerationIncludingGravity;if(m){const h=m.x??0,l=m.y??0,f=m.z??-9.8,E=Math.atan2(-h,Math.hypot(l,f))*180/Math.PI,Y=Math.atan2(l,f)*180/Math.PI;d=d*(1-b)+E*b,c=c*(1-b)+Y*b}if(D!=null){const h=ee(D-r);r=L(r+h*K)}B(w)}return window.addEventListener("deviceorientation",s,!0),window.addEventListener("devicemotion",u,!0),()=>{window.removeEventListener("deviceorientation",s,!0),window.removeEventListener("devicemotion",u,!0)}}let T=[];function C(){n="virtual";let s=!1,u=0,g=0;const w=.1,M=.1;function v(l){s=!0,u=l.clientX,g=l.clientY,l.target.setPointerCapture?.(l.pointerId)}function m(l){s=!1,l.target.releasePointerCapture?.(l.pointerId)}function h(l){if(!s)return;const f=l.clientX-u,E=l.clientY-g;u=l.clientX,g=l.clientY,r=L(r+f*w),d=Math.max(-89,Math.min(89,d-E*M)),B(performance.now())}window.addEventListener("pointerdown",v),window.addEventListener("pointerup",m),window.addEventListener("pointermove",h),T.push(()=>{window.removeEventListener("pointerdown",v),window.removeEventListener("pointerup",m),window.removeEventListener("pointermove",h)})}if(!F()){const s=X();T.push(s);const u=setTimeout(()=>{y===0&&D==null&&C()},2e3);T.push(()=>clearTimeout(u))}function N(){B(performance.now()),i=requestAnimationFrame(N)}return i=requestAnimationFrame(N),{subscribe(s){return a.add(s),()=>a.delete(s)},setSmoothing(s){t=Math.max(0,Math.min(.3,s))},setHeadingOffset(s){o=s},getSource(){return n},stop(){i!==null&&cancelAnimationFrame(i),T.forEach(s=>s()),x?.stop?.(),a.clear()}}}function Ie(e,t,o){const a=o/2,n=e/t*a+a;return Math.max(0,Math.min(o,n))}function Pe(e,t,o){const a=o/2,n=-e/t*a+a;return Math.max(0,Math.min(o,n))}function Oe(e,t,o){return e*(o/Math.max(1,t))}function Be(e,t){const o=t/2;return e>=-o&&e<=o}function Le(e){return e<0?"left":"right"}const ke=e=>`${e.name}|${e.country}`,V=new Map;function xe(e,t){const n=new Set([...V.keys(),...e.keys()]);for(const i of n){const r=V.get(i)??0,d=e.has(i),c=d?Math.min(1,r+4*t):Math.max(0,r-3*t);c<=0&&!d?V.delete(i):V.set(i,c)}}function Te(e,t){const o=e.measureText(t),a=(o.actualBoundingBoxAscent||12)+(o.actualBoundingBoxDescent||4);return{w:o.width+12,h:a}}function Ce(e,t){return!(e.x+e.w<t.x||t.x+t.w<e.x||e.y+e.h<t.y||t.y+t.h<e.y)}function re(e,t,o,a=12){const n=new Set,i=Math.max(10,e.h+4),r=e.y,d=[r];for(let c=1;c<=a;c++)d.push(r-c*i);for(let c=1;c<=a;c++)d.push(r+c*i);for(let c of d){if(c=Math.max(0,Math.min(o-e.h,c)),n.has(c))continue;n.add(c);const y={x:e.x,y:c,w:e.w,h:e.h};if(!t.some(p=>Ce(p,y)))return c}return null}function Ae(e,t,o,a){const{width:n,height:i,hfovDeg:r,pitchDeg:d,headingDeg:c,cities:y,user:p,units:b,maxDistanceKm:K,showOffscreenIndicators:D}=t,I=Math.max(1,window.devicePixelRatio||1);(e.canvas.width!==Math.floor(n*I)||e.canvas.height!==Math.floor(i*I))&&(e.canvas.width=Math.floor(n*I),e.canvas.height=Math.floor(i*I)),e.setTransform(I,0,0,I,0,0),e.clearRect(0,0,n,i);const k=Oe(r,n,i),O=Pe(d,k,i);e.save(),e.strokeStyle="rgba(180,200,220,0.25)",e.lineWidth=2,e.beginPath(),e.moveTo(0,O),e.lineTo(n,O),e.stroke(),e.restore();const x=.621371,B=y.map(s=>{const u=we(p.lat,p.lon,s.lat,s.lon);return{c:s,distKm:u,bearing:ve(p.lat,p.lon,s.lat,s.lon)}}).filter(s=>s.distKm<=K);B.sort((s,u)=>u.c.population-s.c.population);const F=[],X=[],T=[],C=new Set,z=22,N=a.v?Math.min(.1,(o-a.v)/1e3):0;a.v=o;for(const s of B){const u=ke(s.c),g=ee(s.bearing-c),w=!Be(g,r),M=b==="km"?s.distKm:s.distKm*x,v=M>=100?Math.round(M).toString():M.toFixed(1),m=s.c.population,h=m>=1e6?`~${(m/1e6).toFixed(1)}M`:`~${Math.round(m/1e3)}k`,l=`${s.c.name}, ${s.c.country} — ${v} ${b} — Pop ${h}`;e.font="600 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";const{w:f,h:E}=Te(e,l);let Y=Ie(g,r,n);const he=Math.max(0,Math.min(i-z,O-6)),P={x:Math.max(4,Math.min(n-f-4,Y-f/2)),y:he-E,w:f,h:E};if(w){if(!D){C.add(u);continue}C.add(u);const j=V.get(u)??0;if(j<=.01)continue;const W=Le(g),S=6,_=W==="left"?{x:S,y:Math.max(0,Math.min(i-E,O-E/2)),w:f,h:E}:{x:n-S-f,y:Math.max(0,Math.min(i-E,O-E/2)),w:f,h:E},oe=W==="left"?X:T,ie=re(_,oe,i);if(ie===null)continue;_.y=ie,oe.push({..._});const A=_.y+_.h/2,ae=_.y+_.h-6;e.save(),e.globalAlpha=j,e.strokeStyle="rgba(255,255,255,0.6)",e.fillStyle="rgba(255,255,255,0.9)",e.lineWidth=2,e.beginPath(),W==="left"?(e.moveTo(S,A),e.lineTo(S+10,A-6),e.moveTo(S,A),e.lineTo(S+10,A+6),e.stroke(),e.textAlign="left",e.fillText(l,S+16,ae)):(e.moveTo(n-S,A),e.lineTo(n-S-10,A-6),e.moveTo(n-S,A),e.lineTo(n-S-10,A+6),e.stroke(),e.textAlign="right",e.fillText(l,n-S-16,ae)),e.restore()}else{const j=re(P,F,i);if(j===null)continue;P.y=j,F.push({...P}),C.add(u);const W=V.get(u)??0;if(W<=.01)continue;e.save(),e.globalAlpha=W,e.fillStyle="rgba(0,0,0,0.45)",e.strokeStyle="rgba(255,255,255,0.2)",Ge(e,P.x,P.y,P.w,P.h,6),e.fill(),e.fillStyle="white",e.shadowColor="rgba(0,0,0,0.6)",e.shadowBlur=2,e.fillText(l,P.x+6,P.y+P.h-6),e.restore()}}return xe(C,N),{visibleCount:F.length}}function Ge(e,t,o,a,n,i){e.beginPath(),e.moveTo(t+i,o),e.arcTo(t+a,o,t+a,o+n,i),e.arcTo(t+a,o+n,t,o+n,i),e.arcTo(t,o+n,t,o,i),e.arcTo(t,o,t+a,o,i),e.closePath()}const Re=document.getElementById("camera"),G=document.getElementById("overlay"),$=G.getContext("2d");let R={maxDistanceKm:1e3,units:"km",hfovDeg:60,headingOffsetDeg:0,smoothing:.15,showOffscreenIndicators:!1},te={lat:0,lon:0},ne=!1,Z=[],J=De({smoothing:R.smoothing,headingOffsetDeg:R.headingOffsetDeg});performance.now();let U=[],Fe={v:0};const _e=fe({settings:R,onSettingsChange:e=>{R=e,J.setSmoothing(e.smoothing),J.setHeadingOffset(e.headingOffsetDeg)},onStart:async()=>{$e(),Me().catch(()=>{}),be(Re).catch(()=>{})},onManualGeo:e=>{te=e,ne=!0,q.setGeoStatus(`${e.lat.toFixed(5)}, ${e.lon.toFixed(5)} (manual)`)}}),q=_e;function $e(){q.setGeoStatus("requesting…"),Ee(e=>{te={lat:e.lat,lon:e.lon},ne=!0,q.setGeoStatus(`${e.lat.toFixed(5)}, ${e.lon.toFixed(5)} ±${Math.round(e.accuracy||0)}m`)},e=>{console.warn("Geolocation error",e);let t="location error";const o=e;if(typeof o?.code=="number")switch(o.code){case 1:t="permission denied — check site settings";break;case 2:t="position unavailable";break;case 3:t="timeout — move outdoors or check settings";break;default:t="location error"}else o?.message&&(t=o.message);q.setGeoStatus(t),q.showManualGeo(!0)})}async function He(){Z=await(await fetch("./cities.json")).json()}function de(){const e=G.getBoundingClientRect();G.width=e.width*window.devicePixelRatio,G.height=e.height*window.devicePixelRatio}window.addEventListener("resize",de);de();let ce=performance.now(),Q=0;J.subscribe(e=>{Q++;const t=performance.now();if(t-ce>1e3){U.push(Q),U.length>4&&U.shift();const o=U.reduce((a,n)=>a+n,0)/U.length;q.updateDebug(e.headingDeg,e.pitchDeg,e.rollDeg,e.source,o),Q=0,ce=t}});function ue(){const e=performance.now();let t=window.__arc_heading??0,o=window.__arc_pitch??0;window.__arc_bound||(window.__arc_bound=!0,J.subscribe(i=>{window.__arc_heading=i.headingDeg,window.__arc_pitch=i.pitchDeg,window.__arc_roll=i.rollDeg}));const a=G.clientWidth,n=G.clientHeight;G.width=Math.floor(a*window.devicePixelRatio),G.height=Math.floor(n*window.devicePixelRatio),$.setTransform(window.devicePixelRatio,0,0,window.devicePixelRatio,0,0),ne&&Z.length>0?Ae($,{width:a,height:n,hfovDeg:R.hfovDeg,pitchDeg:o,headingDeg:t,units:R.units,maxDistanceKm:R.maxDistanceKm,user:te,cities:Z,showOffscreenIndicators:R.showOffscreenIndicators},e,Fe):($.clearRect(0,0,a,n),$.fillStyle="rgba(255,255,255,0.7)",$.font="600 16px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial",$.textAlign="center",$.fillText("Press Start and allow permissions",a/2,n/2)),requestAnimationFrame(ue)}He();requestAnimationFrame(ue);"serviceWorker"in navigator&&navigator.serviceWorker.register("./sw.js").catch(()=>{});
