(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&a(c)}).observe(document,{childList:!0,subtree:!0});function o(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(n){if(n.ep)return;n.ep=!0;const i=o(n);fetch(n.href,i)}})();const ue="arcities.settings.v2";function me(){try{const e=localStorage.getItem(ue);if(e)return JSON.parse(e)}catch{}return{maxDistanceKm:1e3,units:"km",hfovDeg:60,headingOffsetDeg:0,smoothing:.15,showOffscreenIndicators:!1}}function fe(e){try{localStorage.setItem(ue,JSON.stringify(e))}catch{}}function pe(e){const t=e.settings||me();e.settings=t;const o=document.getElementById("startBtn"),a=document.getElementById("helpBtn"),n=document.getElementById("onboarding"),i=document.getElementById("collapseBtn"),c=document.getElementById("controlsBody"),d=document.getElementById("distance"),l=document.getElementById("distanceValue"),E=document.getElementById("unitsKm"),w=document.getElementById("unitsMi"),D=document.getElementById("hfov"),q=document.getElementById("hfovValue"),I=document.getElementById("headingOffset"),O=document.getElementById("headingOffsetValue"),G=document.getElementById("smooth"),x=document.getElementById("smoothValue"),R=document.getElementById("showOffscreen"),k=document.getElementById("dbgHeading"),N=document.getElementById("dbgPitch"),J=document.getElementById("dbgRoll"),A=document.getElementById("dbgSource"),_=document.getElementById("dbgRate"),ee=document.getElementById("dbgSmooth"),U=document.getElementById("geoText"),s=document.getElementById("manualGeo"),u=document.getElementById("lat"),m=document.getElementById("lon"),y=document.getElementById("setGeo");function M(r,g){if(!r)return null;let h=r.trim().toUpperCase();h=h.replace(/,/g," "),h=h.replace(/[\s]+/g," ");let P=null;const K=h.match(/([NSEW])$/);K&&(P=K[1],h=h.slice(0,-1).trim());const p=[];let T=h.replace(/°/g," ").replace(/'/g," ").replace(/"/g," ");if(T=T.replace(/[\s]+/g," ").trim(),!T)return null;for(const L of T.split(" ")){if(!L)continue;const Q=Number(L);if(!Number.isFinite(Q))return null;if(p.push(Q),p.length===3)break}if(p.length===0)return null;const C=p[0],v=p[1]||0,B=p[2]||0;let W=1;C<0&&(W=-1),P&&((P==="S"||P==="W")&&(W=-1),(P==="N"||P==="E")&&(W=1));let ne=Math.abs(C)+Math.abs(v)/60+Math.abs(B)/3600,X=W*ne;if(g){if(Math.abs(X)>90)return null}else if(Math.abs(X)>180)return null;return X}localStorage.getItem("arcities.onboarded")||n.showModal(),document.getElementById("onboardingClose").addEventListener("click",()=>{localStorage.setItem("arcities.onboarded","1")}),a.addEventListener("click",()=>n.showModal()),i.addEventListener("click",()=>{const g=!(i.getAttribute("aria-expanded")==="true");i.setAttribute("aria-expanded",String(g)),c.style.display=g?"block":"none",i.textContent=g?"▾":"▸"}),d.value=String(t.maxDistanceKm),D.value=String(t.hfovDeg),I.value=String(t.headingOffsetDeg),G.value=String(t.smoothing),t.units==="km"?E.checked=!0:w.checked=!0,R.checked=!!t.showOffscreenIndicators;function S(r,g){if(g==="km")return`${Math.round(r)} km`;const h=r*.621371;return`${Math.round(h)} mi`}function b(){l.textContent=S(Number(d.value),t.units),q.textContent=`${D.value}°`,O.textContent=`${I.value}°`,x.textContent=`${Number(G.value).toFixed(2)}`}b();function f(){fe(t),e.onSettingsChange?.(t),b()}return d.addEventListener("input",()=>{t.maxDistanceKm=Number(d.value),f()}),D.addEventListener("input",()=>{t.hfovDeg=Number(D.value),f()}),I.addEventListener("input",()=>{t.headingOffsetDeg=Number(I.value),f()}),G.addEventListener("input",()=>{t.smoothing=Number(G.value),f()}),R.addEventListener("change",()=>{t.showOffscreenIndicators=R.checked,f()}),E.addEventListener("change",()=>{t.units="km",f()}),w.addEventListener("change",()=>{t.units="mi",f()}),o.addEventListener("click",()=>e.onStart?.()),y.addEventListener("click",()=>{const r=M(u.value,!0),g=M(m.value,!1);if(!Number.isFinite(r)||!Number.isFinite(g)){const h=document.getElementById("geoText");h&&(h.textContent="invalid lat/lon format");return}e.onManualGeo?.({lat:r,lon:g})}),{setGeoStatus(r){U.textContent=r},showManualGeo(r){s.classList.toggle("hidden",!r)},updateDebug(r,g,h,P,K){k.textContent=r.toFixed(1),N.textContent=g.toFixed(1),J.textContent=h.toFixed(1),A.textContent=P,_.textContent=K?K.toFixed(0):"–",ee.textContent=t.smoothing.toFixed(2)},getSettings(){return t}}}function V(e){return e*Math.PI/180}function ve(e){return e*180/Math.PI}function F(e){let t=e%360;return t<0&&(t+=360),t}function ae(e){return((e+180)%360+360)%360-180}function we(e,t,o,a){const n=6371.0088,i=V(o-e),c=V(a-t),d=Math.sin(i/2)**2+Math.cos(V(e))*Math.cos(V(o))*Math.sin(c/2)**2,l=2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d));return n*l}function ye(e,t,o,a){const n=V(e),i=V(o),c=V(a-t),d=Math.sin(c)*Math.cos(i),l=Math.cos(n)*Math.sin(i)-Math.sin(n)*Math.cos(i)*Math.cos(c),E=ve(Math.atan2(d,l));return F(E)}function Me(e,t,o){const a=ae(t-e);return F(e+a*(1-Math.exp(-o)))}function ce(e,t,o){return e+(t-e)*(1-Math.exp(-o))}async function be(){try{const e=window,t=e.DeviceMotionEvent&&typeof e.DeviceMotionEvent.requestPermission=="function"?await e.DeviceMotionEvent.requestPermission():"granted",o=e.DeviceOrientationEvent&&typeof e.DeviceOrientationEvent.requestPermission=="function"?await e.DeviceOrientationEvent.requestPermission():"granted"}catch{}}async function Ee(e){try{const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}},audio:!1});return e.srcObject=t,await e.play(),t}catch(t){return console.warn("Camera access failed",t),null}}function Se(e,t){if(!("geolocation"in navigator))return t(new DOMException("Geolocation not supported")),()=>{};if(!window.isSecureContext)return t(new DOMException("Geolocation requires HTTPS")),()=>{};let o=null;const a={enableHighAccuracy:!0,maximumAge:5e3,timeout:2e4};try{navigator.geolocation.getCurrentPosition(n=>{const{latitude:i,longitude:c,accuracy:d}=n.coords;e({lat:i,lon:c,accuracy:d})},n=>{t(n)},a)}catch(n){t(n)}try{o=navigator.geolocation.watchPosition(n=>{const{latitude:i,longitude:c,accuracy:d}=n.coords;e({lat:i,lon:c,accuracy:d})},n=>t(n),a)}catch(n){t(n)}return()=>{o!==null&&navigator.geolocation.clearWatch(o)}}function De(e,t,o,a){const n=t*t,i=2*(a*e+t*o),c=1-2*(e*e+n),d=Math.atan2(i,c);let l=2*(a*t-o*e);l=Math.max(-1,Math.min(1,l));const E=Math.asin(l),w=2*(a*o+e*t),D=1-2*(n+o*o);return{yaw:Math.atan2(w,D)*180/Math.PI,pitch:E*180/Math.PI,roll:d*180/Math.PI}}function Ie(e){let t=e.smoothing,o=e.headingOffsetDeg,a=new Set,n="deviceorientation+motion",i=null,c=0,d=0,l=0,E=0,w={headingDeg:0,pitchDeg:0,rollDeg:0,timestamp:performance.now()};const D=.02,q=.01;let I=null;const O=window,G=O.AbsoluteOrientationSensor,x=O.RelativeOrientationSensor;let R=null;function k(s){const u=F(c+o),m=d,y=l,M=Me(w.headingDeg,u,t),S=ce(w.pitchDeg,m,t),b=ce(w.rollDeg,y,t),f={headingDeg:M,pitchDeg:S,rollDeg:b,source:n,timestamp:s};w=f,a.forEach(r=>r(f))}function N(){try{const s=G||x;if(!s)return!1;const u=new s({frequency:60});return R=u,n="generic-sensor",u.onreading=()=>{const m=u.quaternion;if(!m)return;const{yaw:y,pitch:M,roll:S}=De(m[0],m[1],m[2],m[3]);c=F(y),d=M,l=S,k(performance.now())},u.onerror=()=>{},u.start(),!0}catch{return!1}}function J(){n="deviceorientation+motion";function s(m){const y=m;typeof y.webkitCompassHeading=="number"?I=F(y.webkitCompassHeading):typeof m.alpha=="number"&&(I=F(m.alpha))}function u(m){const y=performance.now(),M=E?(y-E)/1e3:0;E=y;const S=m.rotationRate;if(S){const f=S.alpha??0,r=S.beta??0,g=S.gamma??0;c=F(c+f*M),d=d+r*M,l=l+g*M}const b=m.accelerationIncludingGravity;if(b){const f=b.x??0,r=b.y??0,g=b.z??-9.8,h=Math.atan2(-f,Math.hypot(r,g))*180/Math.PI,P=Math.atan2(r,g)*180/Math.PI;d=d*(1-D)+h*D,l=l*(1-D)+P*D}if(I!=null){const f=ae(I-c);c=F(c+f*q)}k(y)}return window.addEventListener("deviceorientation",s,!0),window.addEventListener("devicemotion",u,!0),()=>{window.removeEventListener("deviceorientation",s,!0),window.removeEventListener("devicemotion",u,!0)}}let A=[];function _(){n="virtual";let s=!1,u=0,m=0;const y=.1,M=.1;function S(r){s=!0,u=r.clientX,m=r.clientY,r.target.setPointerCapture?.(r.pointerId)}function b(r){s=!1,r.target.releasePointerCapture?.(r.pointerId)}function f(r){if(!s)return;const g=r.clientX-u,h=r.clientY-m;u=r.clientX,m=r.clientY,c=F(c+g*y),d=Math.max(-89,Math.min(89,d-h*M)),k(performance.now())}window.addEventListener("pointerdown",S),window.addEventListener("pointerup",b),window.addEventListener("pointermove",f),A.push(()=>{window.removeEventListener("pointerdown",S),window.removeEventListener("pointerup",b),window.removeEventListener("pointermove",f)})}if(!N()){const s=J();A.push(s);const u=setTimeout(()=>{E===0&&I==null&&_()},2e3);A.push(()=>clearTimeout(u))}function U(){k(performance.now()),i=requestAnimationFrame(U)}return i=requestAnimationFrame(U),{subscribe(s){return a.add(s),()=>a.delete(s)},setSmoothing(s){t=Math.max(0,Math.min(.3,s))},setHeadingOffset(s){o=s},getSource(){return n},stop(){i!==null&&cancelAnimationFrame(i),A.forEach(s=>s()),R?.stop?.(),a.clear()}}}function Pe(e,t,o){const a=o/2,n=e/t*a+a;return Math.max(0,Math.min(o,n))}function Oe(e,t,o){const a=o/2,n=-e/t*a+a;return Math.max(0,Math.min(o,n))}function Be(e,t,o){return e*(o/Math.max(1,t))}function Le(e,t){const o=t/2;return e>=-o&&e<=o}function xe(e){return e<0?"left":"right"}const ke=e=>`${e.name}|${e.country}`,j=new Map;function Te(e,t){const n=new Set([...j.keys(),...e.keys()]);for(const i of n){const c=j.get(i)??0,d=e.has(i),l=d?Math.min(1,c+4*t):Math.max(0,c-3*t);l<=0&&!d?j.delete(i):j.set(i,l)}}function Ce(e,t){return{w:e.measureText(t).width+12,h:24}}function Fe(e,t){return!(e.x+e.w<t.x||t.x+t.w<e.x||e.y+e.h<t.y||t.y+t.h<e.y)}function le(e,t,o,a=12){const n=new Set,i=Math.max(12,e.h+6),c=e.y,d=[c];for(let l=1;l<=a;l++)d.push(c-l*i);for(let l=1;l<=a;l++)d.push(c+l*i);for(let l of d){if(l=Math.max(0,Math.min(o-e.h,l)),n.has(l))continue;n.add(l);const E={x:e.x,y:l,w:e.w,h:e.h};if(!t.some(w=>Fe(w,E)))return l}return null}function Ge(e,t,o,a){const{width:n,height:i,hfovDeg:c,pitchDeg:d,headingDeg:l,cities:E,user:w,units:D,maxDistanceKm:q,showOffscreenIndicators:I}=t,O=Math.max(1,window.devicePixelRatio||1);(e.canvas.width!==Math.floor(n*O)||e.canvas.height!==Math.floor(i*O))&&(e.canvas.width=Math.floor(n*O),e.canvas.height=Math.floor(i*O)),e.setTransform(O,0,0,O,0,0),e.clearRect(0,0,n,i);const G=Be(c,n,i),x=Oe(d,G,i);e.save(),e.strokeStyle="rgba(180,200,220,0.25)",e.lineWidth=2,e.beginPath(),e.moveTo(0,x),e.lineTo(n,x),e.stroke(),e.restore();const R=.621371,k=E.map(s=>{const u=we(w.lat,w.lon,s.lat,s.lon);return{c:s,distKm:u,bearing:ye(w.lat,w.lon,s.lat,s.lon)}}).filter(s=>s.distKm<=q);k.sort((s,u)=>u.c.population-s.c.population);const N=[],J=[],A=[],_=new Set,ee=24,U=a.v?Math.min(.1,(o-a.v)/1e3):0;a.v=o;for(const s of k){const u=ke(s.c),m=ae(s.bearing-l),y=!Le(m,c),M=D==="km"?s.distKm:s.distKm*R,S=M>=100?Math.round(M).toString():M.toFixed(1),b=s.c.population,f=b>=1e6?`~${(b/1e6).toFixed(1)}M`:`~${Math.round(b/1e3)}k`,r=`${s.c.name}, ${s.c.country} — ${S} ${D} — Pop ${f}`;e.font="600 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";const{w:g,h}=Ce(e,r);let P=Pe(m,c,n);const K=Math.max(0,Math.min(i-ee,x-6)),p={x:Math.max(4,Math.min(n-g-4,P-g/2)),y:K-h,w:g,h};if(y){if(!I){_.add(u);continue}_.add(u);const T=j.get(u)??0;if(T<=.01)continue;const C=xe(m),v=6,B=C==="left"?{x:v,y:Math.max(0,Math.min(i-h,x-h/2)),w:g,h}:{x:n-v-g,y:Math.max(0,Math.min(i-h,x-h/2)),w:g,h},W=C==="left"?J:A,ne=Math.ceil(i/(B.h+6))+2,X=le(B,W,i,ne);if(X===null)continue;B.y=X,W.push({...B});const L=B.y+B.h/2,Q=B.y+B.h-6;e.save(),e.globalAlpha=T,e.strokeStyle="rgba(255,255,255,0.6)",e.fillStyle="rgba(255,255,255,0.9)",e.lineWidth=2,e.beginPath(),C==="left"?(e.moveTo(v,L),e.lineTo(v+10,L-6),e.moveTo(v,L),e.lineTo(v+10,L+6),e.stroke(),e.textAlign="left",e.fillText(r,v+16,Q)):(e.moveTo(n-v,L),e.lineTo(n-v-10,L-6),e.moveTo(n-v,L),e.lineTo(n-v-10,L+6),e.stroke(),e.textAlign="right",e.fillText(r,n-v-16,Q)),e.restore()}else{const T=Math.ceil(i/(p.h+6))+2,C=le(p,N,i,T);if(C===null)continue;p.y=C,N.push({...p}),_.add(u);const v=j.get(u)??0;if(v<=.01)continue;e.save(),e.globalAlpha=v,e.fillStyle="rgba(0,0,0,0.45)",e.strokeStyle="rgba(255,255,255,0.2)",Re(e,p.x,p.y,p.w,p.h,6),e.fill(),e.fillStyle="white",e.shadowColor="rgba(0,0,0,0.6)",e.shadowBlur=2,e.fillText(r,p.x+6,p.y+p.h-6),e.restore()}}return Te(_,U),{visibleCount:N.length}}function Re(e,t,o,a,n,i){e.beginPath(),e.moveTo(t+i,o),e.arcTo(t+a,o,t+a,o+n,i),e.arcTo(t+a,o+n,t,o+n,i),e.arcTo(t,o+n,t,o,i),e.arcTo(t,o,t+a,o,i),e.closePath()}const Ae=document.getElementById("camera"),$=document.getElementById("overlay"),Y=$.getContext("2d");let H={maxDistanceKm:1e3,units:"km",hfovDeg:60,headingOffsetDeg:0,smoothing:.15,showOffscreenIndicators:!1},se={lat:0,lon:0},re=!1,ie=[],te=Ie({smoothing:H.smoothing,headingOffsetDeg:H.headingOffsetDeg});performance.now();let Z=[],_e={v:0};const $e=pe({settings:H,onSettingsChange:e=>{H=e,te.setSmoothing(e.smoothing),te.setHeadingOffset(e.headingOffsetDeg)},onStart:async()=>{He(),be().catch(()=>{}),Ee(Ae).catch(()=>{})},onManualGeo:e=>{se=e,re=!0,z.setGeoStatus(`${e.lat.toFixed(5)}, ${e.lon.toFixed(5)} (manual)`)}}),z=$e;function He(){z.setGeoStatus("requesting…"),Se(e=>{se={lat:e.lat,lon:e.lon},re=!0,z.setGeoStatus(`${e.lat.toFixed(5)}, ${e.lon.toFixed(5)} ±${Math.round(e.accuracy||0)}m`)},e=>{console.warn("Geolocation error",e);let t="location error";const o=e;if(typeof o?.code=="number")switch(o.code){case 1:t="permission denied — check site settings";break;case 2:t="position unavailable";break;case 3:t="timeout — move outdoors or check settings";break;default:t="location error"}else o?.message&&(t=o.message);z.setGeoStatus(t),z.showManualGeo(!0)})}async function Ne(){ie=await(await fetch("./cities.json")).json()}function he(){const e=$.getBoundingClientRect();$.width=e.width*window.devicePixelRatio,$.height=e.height*window.devicePixelRatio}window.addEventListener("resize",he);he();let de=performance.now(),oe=0;te.subscribe(e=>{oe++;const t=performance.now();if(t-de>1e3){Z.push(oe),Z.length>4&&Z.shift();const o=Z.reduce((a,n)=>a+n,0)/Z.length;z.updateDebug(e.headingDeg,e.pitchDeg,e.rollDeg,e.source,o),oe=0,de=t}});function ge(){const e=performance.now();let t=window.__arc_heading??0,o=window.__arc_pitch??0;window.__arc_bound||(window.__arc_bound=!0,te.subscribe(i=>{window.__arc_heading=i.headingDeg,window.__arc_pitch=i.pitchDeg,window.__arc_roll=i.rollDeg}));const a=$.clientWidth,n=$.clientHeight;$.width=Math.floor(a*window.devicePixelRatio),$.height=Math.floor(n*window.devicePixelRatio),Y.setTransform(window.devicePixelRatio,0,0,window.devicePixelRatio,0,0),re&&ie.length>0?Ge(Y,{width:a,height:n,hfovDeg:H.hfovDeg,pitchDeg:o,headingDeg:t,units:H.units,maxDistanceKm:H.maxDistanceKm,user:se,cities:ie,showOffscreenIndicators:H.showOffscreenIndicators},e,_e):(Y.clearRect(0,0,a,n),Y.fillStyle="rgba(255,255,255,0.7)",Y.font="600 16px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial",Y.textAlign="center",Y.fillText("Press Start and allow permissions",a/2,n/2)),requestAnimationFrame(ge)}Ne();requestAnimationFrame(ge);"serviceWorker"in navigator&&navigator.serviceWorker.register("./sw.js").catch(()=>{});
