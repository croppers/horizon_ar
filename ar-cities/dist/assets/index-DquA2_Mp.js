(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function o(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(n){if(n.ep)return;n.ep=!0;const i=o(n);fetch(n.href,i)}})();const lt="arcities.settings.v1";function ht(){try{const t=localStorage.getItem(lt);if(t)return JSON.parse(t)}catch{}return{maxDistanceKm:1e3,units:"km",hfovDeg:60,headingOffsetDeg:0,smoothing:.15}}function mt(t){try{localStorage.setItem(lt,JSON.stringify(t))}catch{}}function gt(t){const e=t.settings||ht();t.settings=e;const o=document.getElementById("startBtn"),a=document.getElementById("helpBtn"),n=document.getElementById("onboarding"),i=document.getElementById("collapseBtn"),r=document.getElementById("controlsBody"),d=document.getElementById("distance"),s=document.getElementById("distanceValue"),b=document.getElementById("unitsKm"),M=document.getElementById("unitsMi"),E=document.getElementById("hfov"),_=document.getElementById("hfovValue"),w=document.getElementById("headingOffset"),$=document.getElementById("headingOffsetValue"),I=document.getElementById("smooth"),N=document.getElementById("smoothValue"),C=document.getElementById("dbgHeading"),P=document.getElementById("dbgPitch"),Y=document.getElementById("dbgRoll"),W=document.getElementById("dbgSource"),B=document.getElementById("dbgRate"),V=document.getElementById("dbgSmooth"),q=document.getElementById("geoText"),m=document.getElementById("manualGeo"),c=document.getElementById("lat"),g=document.getElementById("lon"),f=document.getElementById("setGeo");localStorage.getItem("arcities.onboarded")||n.showModal(),document.getElementById("onboardingClose").addEventListener("click",()=>{localStorage.setItem("arcities.onboarded","1")}),a.addEventListener("click",()=>n.showModal()),i.addEventListener("click",()=>{const u=!(i.getAttribute("aria-expanded")==="true");i.setAttribute("aria-expanded",String(u)),r.style.display=u?"block":"none",i.textContent=u?"▾":"▸"}),d.value=String(e.maxDistanceKm),E.value=String(e.hfovDeg),w.value=String(e.headingOffsetDeg),I.value=String(e.smoothing),e.units==="km"?b.checked=!0:M.checked=!0;function v(h,u){if(u==="km")return`${Math.round(h)} km`;const l=h*.621371;return`${Math.round(l)} mi`}function D(){s.textContent=v(Number(d.value),e.units),_.textContent=`${E.value}°`,$.textContent=`${w.value}°`,N.textContent=`${Number(I.value).toFixed(2)}`}D();function p(){mt(e),t.onSettingsChange?.(e),D()}return d.addEventListener("input",()=>{e.maxDistanceKm=Number(d.value),p()}),E.addEventListener("input",()=>{e.hfovDeg=Number(E.value),p()}),w.addEventListener("input",()=>{e.headingOffsetDeg=Number(w.value),p()}),I.addEventListener("input",()=>{e.smoothing=Number(I.value),p()}),b.addEventListener("change",()=>{e.units="km",p()}),M.addEventListener("change",()=>{e.units="mi",p()}),o.addEventListener("click",()=>t.onStart?.()),f.addEventListener("click",()=>{const h=Number(c.value),u=Number(g.value);!Number.isFinite(h)||!Number.isFinite(u)||t.onManualGeo?.({lat:h,lon:u})}),{setGeoStatus(h){q.textContent=h},showManualGeo(h){m.classList.toggle("hidden",!h)},updateDebug(h,u,l,y,x){C.textContent=h.toFixed(1),P.textContent=u.toFixed(1),Y.textContent=l.toFixed(1),W.textContent=y,B.textContent=x?x.toFixed(0):"–",V.textContent=e.smoothing.toFixed(2)},getSettings(){return e}}}function F(t){return t*Math.PI/180}function ft(t){return t*180/Math.PI}function O(t){let e=t%360;return e<0&&(e+=360),e}function tt(t){return((t+180)%360+360)%360-180}function pt(t,e,o,a){const n=6371.0088,i=F(o-t),r=F(a-e),d=Math.sin(i/2)**2+Math.cos(F(t))*Math.cos(F(o))*Math.sin(r/2)**2,s=2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d));return n*s}function vt(t,e,o,a){const n=F(t),i=F(o),r=F(a-e),d=Math.sin(r)*Math.cos(i),s=Math.cos(n)*Math.sin(i)-Math.sin(n)*Math.cos(i)*Math.cos(r),b=ft(Math.atan2(d,s));return O(b)}function wt(t,e,o){const a=tt(e-t);return O(t+a*(1-Math.exp(-o)))}function st(t,e,o){return t+(e-t)*(1-Math.exp(-o))}async function yt(){try{const t=window,e=t.DeviceMotionEvent&&typeof t.DeviceMotionEvent.requestPermission=="function"?await t.DeviceMotionEvent.requestPermission():"granted",o=t.DeviceOrientationEvent&&typeof t.DeviceOrientationEvent.requestPermission=="function"?await t.DeviceOrientationEvent.requestPermission():"granted"}catch{}}async function Mt(t){try{const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}},audio:!1});return t.srcObject=e,await t.play(),e}catch(e){return console.warn("Camera access failed",e),null}}function bt(t,e){if(!("geolocation"in navigator))return e(new DOMException("Geolocation not supported")),()=>{};let o=null;try{o=navigator.geolocation.watchPosition(a=>{const{latitude:n,longitude:i,accuracy:r}=a.coords;t({lat:n,lon:i,accuracy:r})},a=>e(a),{enableHighAccuracy:!0,maximumAge:5e3,timeout:2e4})}catch(a){e(a)}return()=>{o!==null&&navigator.geolocation.clearWatch(o)}}function Et(t,e,o,a){const n=e*e,i=2*(a*t+e*o),r=1-2*(t*t+n),d=Math.atan2(i,r);let s=2*(a*e-o*t);s=Math.max(-1,Math.min(1,s));const b=Math.asin(s),M=2*(a*o+t*e),E=1-2*(n+o*o);return{yaw:Math.atan2(M,E)*180/Math.PI,pitch:b*180/Math.PI,roll:d*180/Math.PI}}function Dt(t){let e=t.smoothing,o=t.headingOffsetDeg,a=new Set,n="deviceorientation+motion",i=null,r=0,d=0,s=0,b=0,M={headingDeg:0,pitchDeg:0,rollDeg:0,timestamp:performance.now()};const E=.02,_=.01;let w=null;const $=window,I=$.AbsoluteOrientationSensor,N=$.RelativeOrientationSensor;let C=null;function P(c){const g=O(r+o),f=d,v=s,D=wt(M.headingDeg,g,e),p=st(M.pitchDeg,f,e),h=st(M.rollDeg,v,e),u={headingDeg:D,pitchDeg:p,rollDeg:h,source:n,timestamp:c};M=u,a.forEach(l=>l(u))}function Y(){try{const c=I||N;if(!c)return!1;const g=new c({frequency:60});return C=g,n="generic-sensor",g.onreading=()=>{const f=g.quaternion;if(!f)return;const{yaw:v,pitch:D,roll:p}=Et(f[0],f[1],f[2],f[3]);r=O(v),d=D,s=p,P(performance.now())},g.onerror=()=>{},g.start(),!0}catch{return!1}}function W(){n="deviceorientation+motion";function c(f){const v=f;typeof v.webkitCompassHeading=="number"?w=O(v.webkitCompassHeading):typeof f.alpha=="number"&&(w=O(f.alpha))}function g(f){const v=performance.now(),D=b?(v-b)/1e3:0;b=v;const p=f.rotationRate;if(p){const u=p.alpha??0,l=p.beta??0,y=p.gamma??0;r=O(r+u*D),d=d+l*D,s=s+y*D}const h=f.accelerationIncludingGravity;if(h){const u=h.x??0,l=h.y??0,y=h.z??-9.8,x=Math.atan2(-u,Math.hypot(l,y))*180/Math.PI,J=Math.atan2(l,y)*180/Math.PI;d=d*(1-E)+x*E,s=s*(1-E)+J*E}if(w!=null){const u=tt(w-r);r=O(r+u*_)}P(v)}return window.addEventListener("deviceorientation",c,!0),window.addEventListener("devicemotion",g,!0),()=>{window.removeEventListener("deviceorientation",c,!0),window.removeEventListener("devicemotion",g,!0)}}let B=[];function V(){n="virtual";let c=!1,g=0,f=0;const v=.1,D=.1;function p(l){c=!0,g=l.clientX,f=l.clientY,l.target.setPointerCapture?.(l.pointerId)}function h(l){c=!1,l.target.releasePointerCapture?.(l.pointerId)}function u(l){if(!c)return;const y=l.clientX-g,x=l.clientY-f;g=l.clientX,f=l.clientY,r=O(r+y*v),d=Math.max(-89,Math.min(89,d-x*D)),P(performance.now())}window.addEventListener("pointerdown",p),window.addEventListener("pointerup",h),window.addEventListener("pointermove",u),B.push(()=>{window.removeEventListener("pointerdown",p),window.removeEventListener("pointerup",h),window.removeEventListener("pointermove",u)})}if(!Y()){const c=W();B.push(c);const g=setTimeout(()=>{b===0&&w==null&&V()},2e3);B.push(()=>clearTimeout(g))}function m(){P(performance.now()),i=requestAnimationFrame(m)}return i=requestAnimationFrame(m),{subscribe(c){return a.add(c),()=>a.delete(c)},setSmoothing(c){e=Math.max(0,Math.min(.3,c))},setHeadingOffset(c){o=c},getSource(){return n},stop(){i!==null&&cancelAnimationFrame(i),B.forEach(c=>c()),C?.stop?.(),a.clear()}}}function St(t,e,o){const a=o/2,n=t/e*a+a;return Math.max(0,Math.min(o,n))}function It(t,e,o){const a=o/2,n=-t/e*a+a;return Math.max(0,Math.min(o,n))}function Pt(t,e,o){return t*(o/Math.max(1,e))}function Bt(t,e){const o=e/2;return t>=-o&&t<=o}function Lt(t){return t<0?"left":"right"}const Ot=t=>`${t.name}|${t.country}`,K=new Map;function xt(t,e){const n=new Set([...K.keys(),...t.keys()]);for(const i of n){const r=K.get(i)??0,d=t.has(i),s=d?Math.min(1,r+4*e):Math.max(0,r-3*e);s<=0&&!d?K.delete(i):K.set(i,s)}}function Tt(t,e){const o=t.measureText(e),a=(o.actualBoundingBoxAscent||12)+(o.actualBoundingBoxDescent||4);return{w:o.width+12,h:a}}function kt(t,e){return!(t.x+t.w<e.x||e.x+e.w<t.x||t.y+t.h<e.y||e.y+e.h<t.y)}function rt(t,e,o,a=12){const n=new Set,i=Math.max(10,t.h+4),r=t.y,d=[r];for(let s=1;s<=a;s++)d.push(r-s*i);for(let s=1;s<=a;s++)d.push(r+s*i);for(let s of d){if(s=Math.max(0,Math.min(o-t.h,s)),n.has(s))continue;n.add(s);const b={x:t.x,y:s,w:t.w,h:t.h};if(!e.some(M=>kt(M,b)))return s}return null}function Ct(t,e,o,a){const{width:n,height:i,hfovDeg:r,pitchDeg:d,headingDeg:s,cities:b,user:M,units:E,maxDistanceKm:_}=e,w=Math.max(1,window.devicePixelRatio||1);(t.canvas.width!==Math.floor(n*w)||t.canvas.height!==Math.floor(i*w))&&(t.canvas.width=Math.floor(n*w),t.canvas.height=Math.floor(i*w)),t.setTransform(w,0,0,w,0,0),t.clearRect(0,0,n,i);const $=Pt(r,n,i),I=It(d,$,i);t.save(),t.strokeStyle="rgba(180,200,220,0.25)",t.lineWidth=2,t.beginPath(),t.moveTo(0,I),t.lineTo(n,I),t.stroke(),t.restore();const N=.621371,C=b.map(m=>{const c=pt(M.lat,M.lon,m.lat,m.lon);return{c:m,distKm:c,bearing:vt(M.lat,M.lon,m.lat,m.lon)}}).filter(m=>m.distKm<=_);C.sort((m,c)=>c.c.population-m.c.population);const P=[],Y=[],W=[],B=new Set,V=22,q=a.v?Math.min(.1,(o-a.v)/1e3):0;a.v=o;for(const m of C){const c=Ot(m.c),g=tt(m.bearing-s),f=!Bt(g,r),v=E==="km"?m.distKm:m.distKm*N,D=v>=100?Math.round(v).toString():v.toFixed(1),p=m.c.population,h=p>=1e6?`~${(p/1e6).toFixed(1)}M`:`~${Math.round(p/1e3)}k`,u=`${m.c.name}, ${m.c.country} — ${D} ${E} — Pop ${h}`;t.font="600 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";const{w:l,h:y}=Tt(t,u);let x=St(g,r,n);const J=Math.max(0,Math.min(i-V,I-6)),L={x:Math.max(4,Math.min(n-l-4,x-l/2)),y:J-y,w:l,h:y};if(f){B.add(c);const U=K.get(c)??0;if(U<=.01)continue;const H=Lt(g),S=6,A=H==="left"?{x:S,y:Math.max(0,Math.min(i-y,I-y/2)),w:l,h:y}:{x:n-S-l,y:Math.max(0,Math.min(i-y,I-y/2)),w:l,h:y},ot=H==="left"?Y:W,it=rt(A,ot,i);if(it===null)continue;A.y=it,ot.push({...A});const T=A.y+A.h/2,at=A.y+A.h-6;t.save(),t.globalAlpha=U,t.strokeStyle="rgba(255,255,255,0.6)",t.fillStyle="rgba(255,255,255,0.9)",t.lineWidth=2,t.beginPath(),H==="left"?(t.moveTo(S,T),t.lineTo(S+10,T-6),t.moveTo(S,T),t.lineTo(S+10,T+6),t.stroke(),t.textAlign="left",t.fillText(u,S+16,at)):(t.moveTo(n-S,T),t.lineTo(n-S-10,T-6),t.moveTo(n-S,T),t.lineTo(n-S-10,T+6),t.stroke(),t.textAlign="right",t.fillText(u,n-S-16,at)),t.restore()}else{const U=rt(L,P,i);if(U===null)continue;L.y=U,P.push({...L}),B.add(c);const H=K.get(c)??0;if(H<=.01)continue;t.save(),t.globalAlpha=H,t.fillStyle="rgba(0,0,0,0.45)",t.strokeStyle="rgba(255,255,255,0.2)",At(t,L.x,L.y,L.w,L.h,6),t.fill(),t.fillStyle="white",t.shadowColor="rgba(0,0,0,0.6)",t.shadowBlur=2,t.fillText(u,L.x+6,L.y+L.h-6),t.restore()}}return xt(B,q),{visibleCount:P.length}}function At(t,e,o,a,n,i){t.beginPath(),t.moveTo(e+i,o),t.arcTo(e+a,o,e+a,o+n,i),t.arcTo(e+a,o+n,e,o+n,i),t.arcTo(e,o+n,e,o,i),t.arcTo(e,o,e+a,o,i),t.closePath()}const Rt=document.getElementById("camera"),k=document.getElementById("overlay"),R=k.getContext("2d");let G={maxDistanceKm:1e3,units:"km",hfovDeg:60,headingOffsetDeg:0,smoothing:.15},et={lat:0,lon:0},nt=!1,Z=[],z=Dt({smoothing:G.smoothing,headingOffsetDeg:G.headingOffsetDeg});performance.now();let X=[],Ft={v:0};const Gt=gt({settings:G,onSettingsChange:t=>{G=t,z.setSmoothing(t.smoothing),z.setHeadingOffset(t.headingOffsetDeg)},onStart:async()=>{await yt(),await Mt(Rt),_t()},onManualGeo:t=>{et=t,nt=!0,j.setGeoStatus(`${t.lat.toFixed(5)}, ${t.lon.toFixed(5)} (manual)`)}}),j=Gt;function _t(){bt(t=>{et={lat:t.lat,lon:t.lon},nt=!0,j.setGeoStatus(`${t.lat.toFixed(5)}, ${t.lon.toFixed(5)} ±${Math.round(t.accuracy||0)}m`)},t=>{console.warn("Geolocation error",t),j.setGeoStatus("denied — enter lat/lon"),j.showManualGeo(!0)})}async function $t(){Z=await(await fetch("./cities.json")).json()}function dt(){const t=k.getBoundingClientRect();k.width=t.width*window.devicePixelRatio,k.height=t.height*window.devicePixelRatio}window.addEventListener("resize",dt);dt();let ct=performance.now(),Q=0;z.subscribe(t=>{Q++;const e=performance.now();if(e-ct>1e3){X.push(Q),X.length>4&&X.shift();const o=X.reduce((a,n)=>a+n,0)/X.length;j.updateDebug(t.headingDeg,t.pitchDeg,t.rollDeg,t.source,o),Q=0,ct=e}});function ut(){const t=performance.now();let e=window.__arc_heading??0,o=window.__arc_pitch??0;window.__arc_bound||(window.__arc_bound=!0,z.subscribe(i=>{window.__arc_heading=i.headingDeg,window.__arc_pitch=i.pitchDeg,window.__arc_roll=i.rollDeg}));const a=k.clientWidth,n=k.clientHeight;k.width=Math.floor(a*window.devicePixelRatio),k.height=Math.floor(n*window.devicePixelRatio),R.setTransform(window.devicePixelRatio,0,0,window.devicePixelRatio,0,0),nt&&Z.length>0?Ct(R,{width:a,height:n,hfovDeg:G.hfovDeg,pitchDeg:o,headingDeg:e,units:G.units,maxDistanceKm:G.maxDistanceKm,user:et,cities:Z},t,Ft):(R.clearRect(0,0,a,n),R.fillStyle="rgba(255,255,255,0.7)",R.font="600 16px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial",R.textAlign="center",R.fillText("Press Start and allow permissions",a/2,n/2)),requestAnimationFrame(ut)}$t();requestAnimationFrame(ut);"serviceWorker"in navigator&&navigator.serviceWorker.register("./sw.js").catch(()=>{});
