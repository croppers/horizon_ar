(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))e(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&e(c)}).observe(document,{childList:!0,subtree:!0});function o(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function e(i){if(i.ep)return;i.ep=!0;const r=o(i);fetch(i.href,r)}})();const Yt="arcities.settings.v2";function he(){try{const n=localStorage.getItem(Yt);if(n)return JSON.parse(n)}catch{}return{maxDistanceKm:1e3,units:"km",hfovDeg:60,headingOffsetDeg:0,smoothing:.15,showOffscreenIndicators:!1}}function de(n){try{localStorage.setItem(Yt,JSON.stringify(n))}catch{}}function ge(n){const t=n.settings||he();n.settings=t;const o=document.getElementById("startBtn"),e=document.getElementById("helpBtn"),i=document.getElementById("onboarding"),r=document.getElementById("collapseBtn"),c=document.getElementById("controlsBody"),s=document.getElementById("distance"),d=document.getElementById("distanceValue"),g=document.getElementById("unitsKm"),a=document.getElementById("unitsMi"),l=document.getElementById("hfov"),u=document.getElementById("hfovValue"),h=document.getElementById("headingOffset"),p=document.getElementById("headingOffsetValue"),M=document.getElementById("smooth"),w=document.getElementById("smoothValue"),I=document.getElementById("showOffscreen"),P=document.getElementById("dbgHeading"),L=document.getElementById("dbgPitch"),S=document.getElementById("dbgRoll"),R=document.getElementById("dbgSource"),O=document.getElementById("dbgRate"),A=document.getElementById("dbgSmooth"),T=document.getElementById("geoText"),E=document.getElementById("manualGeo"),y=document.getElementById("lat"),m=document.getElementById("lon"),B=document.getElementById("setGeo");localStorage.getItem("arcities.onboarded")||i.showModal(),document.getElementById("onboardingClose").addEventListener("click",()=>{localStorage.setItem("arcities.onboarded","1")}),e.addEventListener("click",()=>i.showModal()),r.addEventListener("click",()=>{const D=!(r.getAttribute("aria-expanded")==="true");r.setAttribute("aria-expanded",String(D)),c.style.display=D?"block":"none",r.textContent=D?"▾":"▸"}),s.value=String(t.maxDistanceKm),l.value=String(t.hfovDeg),h.value=String(t.headingOffsetDeg),M.value=String(t.smoothing),t.units==="km"?g.checked=!0:a.checked=!0,I.checked=!!t.showOffscreenIndicators;function $(v,D){if(D==="km")return`${Math.round(v)} km`;const N=v*.621371;return`${Math.round(N)} mi`}function _(){d.textContent=$(Number(s.value),t.units),u.textContent=`${l.value}°`,p.textContent=`${h.value}°`,w.textContent=`${Number(M.value).toFixed(2)}`}_();function f(){de(t),n.onSettingsChange?.(t),_()}return s.addEventListener("input",()=>{t.maxDistanceKm=Number(s.value),f()}),l.addEventListener("input",()=>{t.hfovDeg=Number(l.value),f()}),h.addEventListener("input",()=>{t.headingOffsetDeg=Number(h.value),f()}),M.addEventListener("input",()=>{t.smoothing=Number(M.value),f()}),I.addEventListener("change",()=>{t.showOffscreenIndicators=I.checked,f()}),g.addEventListener("change",()=>{t.units="km",f()}),a.addEventListener("change",()=>{t.units="mi",f()}),o.addEventListener("click",()=>n.onStart?.()),B.addEventListener("click",()=>{const v=Number(y.value),D=Number(m.value);!Number.isFinite(v)||!Number.isFinite(D)||n.onManualGeo?.({lat:v,lon:D})}),{setGeoStatus(v){T.textContent=v},showManualGeo(v){E.classList.toggle("hidden",!v)},updateDebug(v,D,N,k,K){P.textContent=v.toFixed(1),L.textContent=D.toFixed(1),S.textContent=N.toFixed(1),R.textContent=k,O.textContent=K?K.toFixed(0):"–",A.textContent=t.smoothing.toFixed(2)},getSettings(){return t}}}function fn(n){return n*Math.PI/180}function pe(n){return n*180/Math.PI}function on(n){let t=n%360;return t<0&&(t+=360),t}function dt(n){return((n+180)%360+360)%360-180}function me(n,t,o,e){const i=6371.0088,r=fn(o-n),c=fn(e-t),s=Math.sin(r/2)**2+Math.cos(fn(n))*Math.cos(fn(o))*Math.sin(c/2)**2,d=2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));return i*d}function ve(n,t,o,e){const i=fn(n),r=fn(o),c=fn(e-t),s=Math.sin(c)*Math.cos(r),d=Math.cos(i)*Math.sin(r)-Math.sin(i)*Math.cos(r)*Math.cos(c),g=pe(Math.atan2(s,d));return on(g)}function we(n,t,o){const e=dt(t-n);return on(n+e*(1-Math.exp(-o)))}function Et(n,t,o){return n+(t-n)*(1-Math.exp(-o))}async function ye(){try{const n=window,t=n.DeviceMotionEvent&&typeof n.DeviceMotionEvent.requestPermission=="function"?await n.DeviceMotionEvent.requestPermission():"granted",o=n.DeviceOrientationEvent&&typeof n.DeviceOrientationEvent.requestPermission=="function"?await n.DeviceOrientationEvent.requestPermission():"granted"}catch{}}async function Se(n){try{const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}},audio:!1});return n.srcObject=t,await n.play(),t}catch(t){return console.warn("Camera access failed",t),null}}function Ee(n,t){if(!("geolocation"in navigator))return t(new DOMException("Geolocation not supported")),()=>{};if(!window.isSecureContext)return t(new DOMException("Geolocation requires HTTPS")),()=>{};let o=null;const e={enableHighAccuracy:!0,maximumAge:5e3,timeout:2e4};try{navigator.geolocation.getCurrentPosition(i=>{const{latitude:r,longitude:c,accuracy:s}=i.coords;n({lat:r,lon:c,accuracy:s})},i=>{t(i)},e)}catch(i){t(i)}try{o=navigator.geolocation.watchPosition(i=>{const{latitude:r,longitude:c,accuracy:s}=i.coords;n({lat:r,lon:c,accuracy:s})},i=>t(i),e)}catch(i){t(i)}return()=>{o!==null&&navigator.geolocation.clearWatch(o)}}function Me(n,t,o,e){const i=t*t,r=2*(e*n+t*o),c=1-2*(n*n+i),s=Math.atan2(r,c);let d=2*(e*t-o*n);d=Math.max(-1,Math.min(1,d));const g=Math.asin(d),a=2*(e*o+n*t),l=1-2*(i+o*o);return{yaw:Math.atan2(a,l)*180/Math.PI,pitch:g*180/Math.PI,roll:s*180/Math.PI}}function Pe(n){let t=n.smoothing,o=n.headingOffsetDeg,e=new Set,i="deviceorientation+motion",r=null,c=0,s=0,d=0,g=0,a={headingDeg:0,pitchDeg:0,rollDeg:0,timestamp:performance.now()};const l=.02,u=.01;let h=null;const p=window,M=p.AbsoluteOrientationSensor,w=p.RelativeOrientationSensor;let I=null;function P(E){const y=on(c+o),m=s,B=d,$=we(a.headingDeg,y,t),_=Et(a.pitchDeg,m,t),f=Et(a.rollDeg,B,t),v={headingDeg:$,pitchDeg:_,rollDeg:f,source:i,timestamp:E};a=v,e.forEach(D=>D(v))}function L(){try{const E=M||w;if(!E)return!1;const y=new E({frequency:60});return I=y,i="generic-sensor",y.onreading=()=>{const m=y.quaternion;if(!m)return;const{yaw:B,pitch:$,roll:_}=Me(m[0],m[1],m[2],m[3]);c=on(B),s=$,d=_,P(performance.now())},y.onerror=()=>{},y.start(),!0}catch{return!1}}function S(){i="deviceorientation+motion";function E(m){const B=m;typeof B.webkitCompassHeading=="number"?h=on(B.webkitCompassHeading):typeof m.alpha=="number"&&(h=on(m.alpha))}function y(m){const B=performance.now(),$=g?(B-g)/1e3:0;g=B;const _=m.rotationRate;if(_){const v=_.alpha??0,D=_.beta??0,N=_.gamma??0;c=on(c+v*$),s=s+D*$,d=d+N*$}const f=m.accelerationIncludingGravity;if(f){const v=f.x??0,D=f.y??0,N=f.z??-9.8,k=Math.atan2(-v,Math.hypot(D,N))*180/Math.PI,K=Math.atan2(D,N)*180/Math.PI;s=s*(1-l)+k*l,d=d*(1-l)+K*l}if(h!=null){const v=dt(h-c);c=on(c+v*u)}P(B)}return window.addEventListener("deviceorientation",E,!0),window.addEventListener("devicemotion",y,!0),()=>{window.removeEventListener("deviceorientation",E,!0),window.removeEventListener("devicemotion",y,!0)}}let R=[];function O(){i="virtual";let E=!1,y=0,m=0;const B=.1,$=.1;function _(D){E=!0,y=D.clientX,m=D.clientY,D.target.setPointerCapture?.(D.pointerId)}function f(D){E=!1,D.target.releasePointerCapture?.(D.pointerId)}function v(D){if(!E)return;const N=D.clientX-y,k=D.clientY-m;y=D.clientX,m=D.clientY,c=on(c+N*B),s=Math.max(-89,Math.min(89,s-k*$)),P(performance.now())}window.addEventListener("pointerdown",_),window.addEventListener("pointerup",f),window.addEventListener("pointermove",v),R.push(()=>{window.removeEventListener("pointerdown",_),window.removeEventListener("pointerup",f),window.removeEventListener("pointermove",v)})}if(!L()){const E=S();R.push(E);const y=setTimeout(()=>{g===0&&h==null&&O()},2e3);R.push(()=>clearTimeout(y))}function T(){P(performance.now()),r=requestAnimationFrame(T)}return r=requestAnimationFrame(T),{subscribe(E){return e.add(E),()=>e.delete(E)},setSmoothing(E){t=Math.max(0,Math.min(.3,E))},setHeadingOffset(E){o=E},getSource(){return i},stop(){r!==null&&cancelAnimationFrame(r),R.forEach(E=>E()),I?.stop?.(),e.clear()}}}class hn{constructor(){this._partials=new Float64Array(32),this._n=0}add(t){const o=this._partials;let e=0;for(let i=0;i<this._n&&i<32;i++){const r=o[i],c=t+r,s=Math.abs(t)<Math.abs(r)?t-(c-r):r-(c-t);s&&(o[e++]=s),t=c}return o[e]=t,this._n=e+1,this}valueOf(){const t=this._partials;let o=this._n,e,i,r,c=0;if(o>0){for(c=t[--o];o>0&&(e=c,i=t[--o],c=e+i,r=i-(c-e),!r););o>0&&(r<0&&t[o-1]<0||r>0&&t[o-1]>0)&&(i=r*2,e=c+i,i==e-c&&(c=e))}return c}}function*Ie(n){for(const t of n)yield*t}function qt(n){return Array.from(Ie(n))}var F=1e-6,C=Math.PI,V=C/2,Mt=C/4,U=C*2,en=180/C,q=C/180,H=Math.abs,De=Math.atan,wn=Math.atan2,b=Math.cos,G=Math.sin,_e=Math.sign||function(n){return n>0?1:n<0?-1:0},ln=Math.sqrt;function xt(n){return n>1?0:n<-1?C:Math.acos(n)}function yn(n){return n>1?V:n<-1?-V:Math.asin(n)}function X(){}function Fn(n,t){n&&It.hasOwnProperty(n.type)&&It[n.type](n,t)}var Pt={Feature:function(n,t){Fn(n.geometry,t)},FeatureCollection:function(n,t){for(var o=n.features,e=-1,i=o.length;++e<i;)Fn(o[e].geometry,t)}},It={Sphere:function(n,t){t.sphere()},Point:function(n,t){n=n.coordinates,t.point(n[0],n[1],n[2])},MultiPoint:function(n,t){for(var o=n.coordinates,e=-1,i=o.length;++e<i;)n=o[e],t.point(n[0],n[1],n[2])},LineString:function(n,t){Jn(n.coordinates,t,0)},MultiLineString:function(n,t){for(var o=n.coordinates,e=-1,i=o.length;++e<i;)Jn(o[e],t,0)},Polygon:function(n,t){Dt(n.coordinates,t)},MultiPolygon:function(n,t){for(var o=n.coordinates,e=-1,i=o.length;++e<i;)Dt(o[e],t)},GeometryCollection:function(n,t){for(var o=n.geometries,e=-1,i=o.length;++e<i;)Fn(o[e],t)}};function Jn(n,t,o){var e=-1,i=n.length-o,r;for(t.lineStart();++e<i;)r=n[e],t.point(r[0],r[1],r[2]);t.lineEnd()}function Dt(n,t){var o=-1,e=n.length;for(t.polygonStart();++o<e;)Jn(n[o],t,1);t.polygonEnd()}function gn(n,t){n&&Pt.hasOwnProperty(n.type)?Pt[n.type](n,t):Fn(n,t)}function Qn(n){return[wn(n[1],n[0]),yn(n[2])]}function Sn(n){var t=n[0],o=n[1],e=b(o);return[e*b(t),e*G(t),G(o)]}function Tn(n,t){return n[0]*t[0]+n[1]*t[1]+n[2]*t[2]}function kn(n,t){return[n[1]*t[2]-n[2]*t[1],n[2]*t[0]-n[0]*t[2],n[0]*t[1]-n[1]*t[0]]}function xn(n,t){n[0]+=t[0],n[1]+=t[1],n[2]+=t[2]}function $n(n,t){return[n[0]*t,n[1]*t,n[2]*t]}function jn(n){var t=ln(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);n[0]/=t,n[1]/=t,n[2]/=t}function nt(n,t){function o(e,i){return e=n(e,i),t(e[0],e[1])}return n.invert&&t.invert&&(o.invert=function(e,i){return e=t.invert(e,i),e&&n.invert(e[0],e[1])}),o}function tt(n,t){return H(n)>C&&(n-=Math.round(n/U)*U),[n,t]}tt.invert=tt;function Le(n,t,o){return(n%=U)?t||o?nt(Lt(n),Rt(t,o)):Lt(n):t||o?Rt(t,o):tt}function _t(n){return function(t,o){return t+=n,H(t)>C&&(t-=Math.round(t/U)*U),[t,o]}}function Lt(n){var t=_t(n);return t.invert=_t(-n),t}function Rt(n,t){var o=b(n),e=G(n),i=b(t),r=G(t);function c(s,d){var g=b(d),a=b(s)*g,l=G(s)*g,u=G(d),h=u*o+a*e;return[wn(l*i-h*r,a*o-u*e),yn(h*i+l*r)]}return c.invert=function(s,d){var g=b(d),a=b(s)*g,l=G(s)*g,u=G(d),h=u*i-l*r;return[wn(l*i+u*r,a*o+h*e),yn(h*o-a*e)]},c}function Re(n,t,o,e,i,r){if(o){var c=b(t),s=G(t),d=e*o;i==null?(i=t+e*U,r=t-d/2):(i=Ot(c,i),r=Ot(c,r),(e>0?i<r:i>r)&&(i+=e*U));for(var g,a=i;e>0?a>r:a<r;a-=d)g=Qn([c,-s*b(a),-s*G(a)]),n.point(g[0],g[1])}}function Ot(n,t){t=Sn(t),t[0]-=n,jn(t);var o=xt(-t[1]);return((-t[2]<0?-o:o)+U-F)%U}function Vt(){var n=[],t;return{point:function(o,e,i){t.push([o,e,i])},lineStart:function(){n.push(t=[])},lineEnd:X,rejoin:function(){n.length>1&&n.push(n.pop().concat(n.shift()))},result:function(){var o=n;return n=[],t=null,o}}}function Nn(n,t){return H(n[0]-t[0])<F&&H(n[1]-t[1])<F}function Bn(n,t,o,e){this.x=n,this.z=t,this.o=o,this.e=e,this.v=!1,this.n=this.p=null}function Xt(n,t,o,e,i){var r=[],c=[],s,d;if(n.forEach(function(p){if(!((M=p.length-1)<=0)){var M,w=p[0],I=p[M],P;if(Nn(w,I)){if(!w[2]&&!I[2]){for(i.lineStart(),s=0;s<M;++s)i.point((w=p[s])[0],w[1]);i.lineEnd();return}I[0]+=2*F}r.push(P=new Bn(w,p,null,!0)),c.push(P.o=new Bn(w,null,P,!1)),r.push(P=new Bn(I,p,null,!1)),c.push(P.o=new Bn(I,null,P,!0))}}),!!r.length){for(c.sort(t),Tt(r),Tt(c),s=0,d=c.length;s<d;++s)c[s].e=o=!o;for(var g=r[0],a,l;;){for(var u=g,h=!0;u.v;)if((u=u.n)===g)return;a=u.z,i.lineStart();do{if(u.v=u.o.v=!0,u.e){if(h)for(s=0,d=a.length;s<d;++s)i.point((l=a[s])[0],l[1]);else e(u.x,u.n.x,1,i);u=u.n}else{if(h)for(a=u.p.z,s=a.length-1;s>=0;--s)i.point((l=a[s])[0],l[1]);else e(u.x,u.p.x,-1,i);u=u.p}u=u.o,a=u.z,h=!h}while(!u.v);i.lineEnd()}}}function Tt(n){if(t=n.length){for(var t,o=0,e=n[0],i;++o<t;)e.n=i=n[o],i.p=e,e=i;e.n=i=n[0],i.p=e}}function Vn(n){return H(n[0])<=C?n[0]:_e(n[0])*((H(n[0])+C)%U-C)}function Oe(n,t){var o=Vn(t),e=t[1],i=G(e),r=[G(o),-b(o),0],c=0,s=0,d=new hn;i===1?e=V+F:i===-1&&(e=-V-F);for(var g=0,a=n.length;g<a;++g)if(u=(l=n[g]).length)for(var l,u,h=l[u-1],p=Vn(h),M=h[1]/2+Mt,w=G(M),I=b(M),P=0;P<u;++P,p=S,w=O,I=A,h=L){var L=l[P],S=Vn(L),R=L[1]/2+Mt,O=G(R),A=b(R),T=S-p,E=T>=0?1:-1,y=E*T,m=y>C,B=w*O;if(d.add(wn(B*E*G(y),I*A+B*b(y))),c+=m?T+E*U:T,m^p>=o^S>=o){var $=kn(Sn(h),Sn(L));jn($);var _=kn(r,$);jn(_);var f=(m^T>=0?-1:1)*yn(_[2]);(e>f||e===f&&($[0]||$[1]))&&(s+=m^T>=0?1:-1)}}return(c<-F||c<F&&d<-1e-12)^s&1}function Ut(n,t,o,e){return function(i){var r=t(i),c=Vt(),s=t(c),d=!1,g,a,l,u={point:h,lineStart:M,lineEnd:w,polygonStart:function(){u.point=I,u.lineStart=P,u.lineEnd=L,a=[],g=[]},polygonEnd:function(){u.point=h,u.lineStart=M,u.lineEnd=w,a=qt(a);var S=Oe(g,e);a.length?(d||(i.polygonStart(),d=!0),Xt(a,$e,S,o,i)):S&&(d||(i.polygonStart(),d=!0),i.lineStart(),o(null,null,1,i),i.lineEnd()),d&&(i.polygonEnd(),d=!1),a=g=null},sphere:function(){i.polygonStart(),i.lineStart(),o(null,null,1,i),i.lineEnd(),i.polygonEnd()}};function h(S,R){n(S,R)&&i.point(S,R)}function p(S,R){r.point(S,R)}function M(){u.point=p,r.lineStart()}function w(){u.point=h,r.lineEnd()}function I(S,R){l.push([S,R]),s.point(S,R)}function P(){s.lineStart(),l=[]}function L(){I(l[0][0],l[0][1]),s.lineEnd();var S=s.clean(),R=c.result(),O,A=R.length,T,E,y;if(l.pop(),g.push(l),l=null,!!A){if(S&1){if(E=R[0],(T=E.length-1)>0){for(d||(i.polygonStart(),d=!0),i.lineStart(),O=0;O<T;++O)i.point((y=E[O])[0],y[1]);i.lineEnd()}return}A>1&&S&2&&R.push(R.pop().concat(R.shift())),a.push(R.filter(Te))}}return u}}function Te(n){return n.length>1}function $e(n,t){return((n=n.x)[0]<0?n[1]-V-F:V-n[1])-((t=t.x)[0]<0?t[1]-V-F:V-t[1])}const $t=Ut(function(){return!0},Be,Ce,[-C,-V]);function Be(n){var t=NaN,o=NaN,e=NaN,i;return{lineStart:function(){n.lineStart(),i=1},point:function(r,c){var s=r>0?C:-C,d=H(r-t);H(d-C)<F?(n.point(t,o=(o+c)/2>0?V:-V),n.point(e,o),n.lineEnd(),n.lineStart(),n.point(s,o),n.point(r,o),i=0):e!==s&&d>=C&&(H(t-e)<F&&(t-=e*F),H(r-s)<F&&(r-=s*F),o=Ae(t,o,r,c),n.point(e,o),n.lineEnd(),n.lineStart(),n.point(s,o),i=0),n.point(t=r,o=c),e=s},lineEnd:function(){n.lineEnd(),t=o=NaN},clean:function(){return 2-i}}}function Ae(n,t,o,e){var i,r,c=G(n-o);return H(c)>F?De((G(t)*(r=b(e))*G(o)-G(e)*(i=b(t))*G(n))/(i*r*c)):(t+e)/2}function Ce(n,t,o,e){var i;if(n==null)i=o*V,e.point(-C,i),e.point(0,i),e.point(C,i),e.point(C,0),e.point(C,-i),e.point(0,-i),e.point(-C,-i),e.point(-C,0),e.point(-C,i);else if(H(n[0]-t[0])>F){var r=n[0]<t[0]?C:-C;i=o*r/2,e.point(-r,i),e.point(0,i),e.point(r,i)}else e.point(t[0],t[1])}function Ne(n){var t=b(n),o=2*q,e=t>0,i=H(t)>F;function r(a,l,u,h){Re(h,n,o,u,a,l)}function c(a,l){return b(a)*b(l)>t}function s(a){var l,u,h,p,M;return{lineStart:function(){p=h=!1,M=1},point:function(w,I){var P=[w,I],L,S=c(w,I),R=e?S?0:g(w,I):S?g(w+(w<0?C:-C),I):0;if(!l&&(p=h=S)&&a.lineStart(),S!==h&&(L=d(l,P),(!L||Nn(l,L)||Nn(P,L))&&(P[2]=1)),S!==h)M=0,S?(a.lineStart(),L=d(P,l),a.point(L[0],L[1])):(L=d(l,P),a.point(L[0],L[1],2),a.lineEnd()),l=L;else if(i&&l&&e^S){var O;!(R&u)&&(O=d(P,l,!0))&&(M=0,e?(a.lineStart(),a.point(O[0][0],O[0][1]),a.point(O[1][0],O[1][1]),a.lineEnd()):(a.point(O[1][0],O[1][1]),a.lineEnd(),a.lineStart(),a.point(O[0][0],O[0][1],3)))}S&&(!l||!Nn(l,P))&&a.point(P[0],P[1]),l=P,h=S,u=R},lineEnd:function(){h&&a.lineEnd(),l=null},clean:function(){return M|(p&&h)<<1}}}function d(a,l,u){var h=Sn(a),p=Sn(l),M=[1,0,0],w=kn(h,p),I=Tn(w,w),P=w[0],L=I-P*P;if(!L)return!u&&a;var S=t*I/L,R=-t*P/L,O=kn(M,w),A=$n(M,S),T=$n(w,R);xn(A,T);var E=O,y=Tn(A,E),m=Tn(E,E),B=y*y-m*(Tn(A,A)-1);if(!(B<0)){var $=ln(B),_=$n(E,(-y-$)/m);if(xn(_,A),_=Qn(_),!u)return _;var f=a[0],v=l[0],D=a[1],N=l[1],k;v<f&&(k=f,f=v,v=k);var K=v-f,Z=H(K-C)<F,j=Z||K<F;if(!Z&&N<D&&(k=D,D=N,N=k),j?Z?D+N>0^_[1]<(H(_[0]-f)<F?D:N):D<=_[1]&&_[1]<=N:K>C^(f<=_[0]&&_[0]<=v)){var z=$n(E,(-y+$)/m);return xn(z,A),[_,Qn(z)]}}}function g(a,l){var u=e?n:C-n,h=0;return a<-u?h|=1:a>u&&(h|=2),l<-u?h|=4:l>u&&(h|=8),h}return Ut(c,s,r,e?[0,-n]:[-C,n-C])}function Fe(n,t,o,e,i,r){var c=n[0],s=n[1],d=t[0],g=t[1],a=0,l=1,u=d-c,h=g-s,p;if(p=o-c,!(!u&&p>0)){if(p/=u,u<0){if(p<a)return;p<l&&(l=p)}else if(u>0){if(p>l)return;p>a&&(a=p)}if(p=i-c,!(!u&&p<0)){if(p/=u,u<0){if(p>l)return;p>a&&(a=p)}else if(u>0){if(p<a)return;p<l&&(l=p)}if(p=e-s,!(!h&&p>0)){if(p/=h,h<0){if(p<a)return;p<l&&(l=p)}else if(h>0){if(p>l)return;p>a&&(a=p)}if(p=r-s,!(!h&&p<0)){if(p/=h,h<0){if(p>l)return;p>a&&(a=p)}else if(h>0){if(p<a)return;p<l&&(l=p)}return a>0&&(n[0]=c+a*u,n[1]=s+a*h),l<1&&(t[0]=c+l*u,t[1]=s+l*h),!0}}}}}var Pn=1e9,An=-Pn;function ke(n,t,o,e){function i(g,a){return n<=g&&g<=o&&t<=a&&a<=e}function r(g,a,l,u){var h=0,p=0;if(g==null||(h=c(g,l))!==(p=c(a,l))||d(g,a)<0^l>0)do u.point(h===0||h===3?n:o,h>1?e:t);while((h=(h+l+4)%4)!==p);else u.point(a[0],a[1])}function c(g,a){return H(g[0]-n)<F?a>0?0:3:H(g[0]-o)<F?a>0?2:1:H(g[1]-t)<F?a>0?1:0:a>0?3:2}function s(g,a){return d(g.x,a.x)}function d(g,a){var l=c(g,1),u=c(a,1);return l!==u?l-u:l===0?a[1]-g[1]:l===1?g[0]-a[0]:l===2?g[1]-a[1]:a[0]-g[0]}return function(g){var a=g,l=Vt(),u,h,p,M,w,I,P,L,S,R,O,A={point:T,lineStart:B,lineEnd:$,polygonStart:y,polygonEnd:m};function T(f,v){i(f,v)&&a.point(f,v)}function E(){for(var f=0,v=0,D=h.length;v<D;++v)for(var N=h[v],k=1,K=N.length,Z=N[0],j,z,nn=Z[0],Y=Z[1];k<K;++k)j=nn,z=Y,Z=N[k],nn=Z[0],Y=Z[1],z<=e?Y>e&&(nn-j)*(e-z)>(Y-z)*(n-j)&&++f:Y<=e&&(nn-j)*(e-z)<(Y-z)*(n-j)&&--f;return f}function y(){a=l,u=[],h=[],O=!0}function m(){var f=E(),v=O&&f,D=(u=qt(u)).length;(v||D)&&(g.polygonStart(),v&&(g.lineStart(),r(null,null,1,g),g.lineEnd()),D&&Xt(u,s,f,r,g),g.polygonEnd()),a=g,u=h=p=null}function B(){A.point=_,h&&h.push(p=[]),R=!0,S=!1,P=L=NaN}function $(){u&&(_(M,w),I&&S&&l.rejoin(),u.push(l.result())),A.point=T,S&&a.lineEnd()}function _(f,v){var D=i(f,v);if(h&&p.push([f,v]),R)M=f,w=v,I=D,R=!1,D&&(a.lineStart(),a.point(f,v));else if(D&&S)a.point(f,v);else{var N=[P=Math.max(An,Math.min(Pn,P)),L=Math.max(An,Math.min(Pn,L))],k=[f=Math.max(An,Math.min(Pn,f)),v=Math.max(An,Math.min(Pn,v))];Fe(N,k,n,t,o,e)?(S||(a.lineStart(),a.point(N[0],N[1])),a.point(k[0],k[1]),D||a.lineEnd(),O=!1):D&&(a.lineStart(),a.point(f,v),O=!1)}P=f,L=v,S=D}return A}}const et=n=>n;var Xn=new hn,it=new hn,Zt,Jt,ot,rt,rn={point:X,lineStart:X,lineEnd:X,polygonStart:function(){rn.lineStart=Ge,rn.lineEnd=He},polygonEnd:function(){rn.lineStart=rn.lineEnd=rn.point=X,Xn.add(H(it)),it=new hn},result:function(){var n=Xn/2;return Xn=new hn,n}};function Ge(){rn.point=be}function be(n,t){rn.point=Qt,Zt=ot=n,Jt=rt=t}function Qt(n,t){it.add(rt*n-ot*t),ot=n,rt=t}function He(){Qt(Zt,Jt)}var En=1/0,Gn=En,Rn=-En,bn=Rn,Hn={point:ze,lineStart:X,lineEnd:X,polygonStart:X,polygonEnd:X,result:function(){var n=[[En,Gn],[Rn,bn]];return Rn=bn=-(Gn=En=1/0),n}};function ze(n,t){n<En&&(En=n),n>Rn&&(Rn=n),t<Gn&&(Gn=t),t>bn&&(bn=t)}var at=0,st=0,In=0,zn=0,Kn=0,pn=0,ct=0,lt=0,Dn=0,jt,ne,J,Q,x={point:dn,lineStart:Bt,lineEnd:At,polygonStart:function(){x.lineStart=Ye,x.lineEnd=qe},polygonEnd:function(){x.point=dn,x.lineStart=Bt,x.lineEnd=At},result:function(){var n=Dn?[ct/Dn,lt/Dn]:pn?[zn/pn,Kn/pn]:In?[at/In,st/In]:[NaN,NaN];return at=st=In=zn=Kn=pn=ct=lt=Dn=0,n}};function dn(n,t){at+=n,st+=t,++In}function Bt(){x.point=Ke}function Ke(n,t){x.point=We,dn(J=n,Q=t)}function We(n,t){var o=n-J,e=t-Q,i=ln(o*o+e*e);zn+=i*(J+n)/2,Kn+=i*(Q+t)/2,pn+=i,dn(J=n,Q=t)}function At(){x.point=dn}function Ye(){x.point=xe}function qe(){te(jt,ne)}function xe(n,t){x.point=te,dn(jt=J=n,ne=Q=t)}function te(n,t){var o=n-J,e=t-Q,i=ln(o*o+e*e);zn+=i*(J+n)/2,Kn+=i*(Q+t)/2,pn+=i,i=Q*n-J*t,ct+=i*(J+n),lt+=i*(Q+t),Dn+=i*3,dn(J=n,Q=t)}function ee(n){this._context=n}ee.prototype={_radius:4.5,pointRadius:function(n){return this._radius=n,this},polygonStart:function(){this._line=0},polygonEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){this._line===0&&this._context.closePath(),this._point=NaN},point:function(n,t){switch(this._point){case 0:{this._context.moveTo(n,t),this._point=1;break}case 1:{this._context.lineTo(n,t);break}default:{this._context.moveTo(n+this._radius,t),this._context.arc(n,t,this._radius,0,U);break}}},result:X};var ut=new hn,Un,ie,oe,_n,Ln,On={point:X,lineStart:function(){On.point=Ve},lineEnd:function(){Un&&re(ie,oe),On.point=X},polygonStart:function(){Un=!0},polygonEnd:function(){Un=null},result:function(){var n=+ut;return ut=new hn,n}};function Ve(n,t){On.point=re,ie=_n=n,oe=Ln=t}function re(n,t){_n-=n,Ln-=t,ut.add(ln(_n*_n+Ln*Ln)),_n=n,Ln=t}let Ct,Wn,Nt,Ft;class kt{constructor(t){this._append=t==null?ae:Xe(t),this._radius=4.5,this._=""}pointRadius(t){return this._radius=+t,this}polygonStart(){this._line=0}polygonEnd(){this._line=NaN}lineStart(){this._point=0}lineEnd(){this._line===0&&(this._+="Z"),this._point=NaN}point(t,o){switch(this._point){case 0:{this._append`M${t},${o}`,this._point=1;break}case 1:{this._append`L${t},${o}`;break}default:{if(this._append`M${t},${o}`,this._radius!==Nt||this._append!==Wn){const e=this._radius,i=this._;this._="",this._append`m0,${e}a${e},${e} 0 1,1 0,${-2*e}a${e},${e} 0 1,1 0,${2*e}z`,Nt=e,Wn=this._append,Ft=this._,this._=i}this._+=Ft;break}}}result(){const t=this._;return this._="",t.length?t:null}}function ae(n){let t=1;this._+=n[0];for(const o=n.length;t<o;++t)this._+=arguments[t]+n[t]}function Xe(n){const t=Math.floor(n);if(!(t>=0))throw new RangeError(`invalid digits: ${n}`);if(t>15)return ae;if(t!==Ct){const o=10**t;Ct=t,Wn=function(i){let r=1;this._+=i[0];for(const c=i.length;r<c;++r)this._+=Math.round(arguments[r]*o)/o+i[r]}}return Wn}function Ue(n,t){let o=3,e=4.5,i,r;function c(s){return s&&(typeof e=="function"&&r.pointRadius(+e.apply(this,arguments)),gn(s,i(r))),r.result()}return c.area=function(s){return gn(s,i(rn)),rn.result()},c.measure=function(s){return gn(s,i(On)),On.result()},c.bounds=function(s){return gn(s,i(Hn)),Hn.result()},c.centroid=function(s){return gn(s,i(x)),x.result()},c.projection=function(s){return arguments.length?(i=s==null?(n=null,et):(n=s).stream,c):n},c.context=function(s){return arguments.length?(r=s==null?(t=null,new kt(o)):new ee(t=s),typeof e!="function"&&r.pointRadius(e),c):t},c.pointRadius=function(s){return arguments.length?(e=typeof s=="function"?s:(r.pointRadius(+s),+s),c):e},c.digits=function(s){if(!arguments.length)return o;if(s==null)o=null;else{const d=Math.floor(s);if(!(d>=0))throw new RangeError(`invalid digits: ${s}`);o=d}return t===null&&(r=new kt(o)),c},c.projection(n).digits(o).context(t)}function gt(n){return function(t){var o=new ft;for(var e in n)o[e]=n[e];return o.stream=t,o}}function ft(){}ft.prototype={constructor:ft,point:function(n,t){this.stream.point(n,t)},sphere:function(){this.stream.sphere()},lineStart:function(){this.stream.lineStart()},lineEnd:function(){this.stream.lineEnd()},polygonStart:function(){this.stream.polygonStart()},polygonEnd:function(){this.stream.polygonEnd()}};function pt(n,t,o){var e=n.clipExtent&&n.clipExtent();return n.scale(150).translate([0,0]),e!=null&&n.clipExtent(null),gn(o,n.stream(Hn)),t(Hn.result()),e!=null&&n.clipExtent(e),n}function se(n,t,o){return pt(n,function(e){var i=t[1][0]-t[0][0],r=t[1][1]-t[0][1],c=Math.min(i/(e[1][0]-e[0][0]),r/(e[1][1]-e[0][1])),s=+t[0][0]+(i-c*(e[1][0]+e[0][0]))/2,d=+t[0][1]+(r-c*(e[1][1]+e[0][1]))/2;n.scale(150*c).translate([s,d])},o)}function Ze(n,t,o){return se(n,[[0,0],t],o)}function Je(n,t,o){return pt(n,function(e){var i=+t,r=i/(e[1][0]-e[0][0]),c=(i-r*(e[1][0]+e[0][0]))/2,s=-r*e[0][1];n.scale(150*r).translate([c,s])},o)}function Qe(n,t,o){return pt(n,function(e){var i=+t,r=i/(e[1][1]-e[0][1]),c=-r*e[0][0],s=(i-r*(e[1][1]+e[0][1]))/2;n.scale(150*r).translate([c,s])},o)}var Gt=16,je=b(30*q);function bt(n,t){return+t?ti(n,t):ni(n)}function ni(n){return gt({point:function(t,o){t=n(t,o),this.stream.point(t[0],t[1])}})}function ti(n,t){function o(e,i,r,c,s,d,g,a,l,u,h,p,M,w){var I=g-e,P=a-i,L=I*I+P*P;if(L>4*t&&M--){var S=c+u,R=s+h,O=d+p,A=ln(S*S+R*R+O*O),T=yn(O/=A),E=H(H(O)-1)<F||H(r-l)<F?(r+l)/2:wn(R,S),y=n(E,T),m=y[0],B=y[1],$=m-e,_=B-i,f=P*$-I*_;(f*f/L>t||H((I*$+P*_)/L-.5)>.3||c*u+s*h+d*p<je)&&(o(e,i,r,c,s,d,m,B,E,S/=A,R/=A,O,M,w),w.point(m,B),o(m,B,E,S,R,O,g,a,l,u,h,p,M,w))}}return function(e){var i,r,c,s,d,g,a,l,u,h,p,M,w={point:I,lineStart:P,lineEnd:S,polygonStart:function(){e.polygonStart(),w.lineStart=R},polygonEnd:function(){e.polygonEnd(),w.lineStart=P}};function I(T,E){T=n(T,E),e.point(T[0],T[1])}function P(){l=NaN,w.point=L,e.lineStart()}function L(T,E){var y=Sn([T,E]),m=n(T,E);o(l,u,a,h,p,M,l=m[0],u=m[1],a=T,h=y[0],p=y[1],M=y[2],Gt,e),e.point(l,u)}function S(){w.point=I,e.lineEnd()}function R(){P(),w.point=O,w.lineEnd=A}function O(T,E){L(i=T,E),r=l,c=u,s=h,d=p,g=M,w.point=L}function A(){o(l,u,a,h,p,M,r,c,i,s,d,g,Gt,e),w.lineEnd=S,S()}return w}}var ei=gt({point:function(n,t){this.stream.point(n*q,t*q)}});function ii(n){return gt({point:function(t,o){var e=n(t,o);return this.stream.point(e[0],e[1])}})}function oi(n,t,o,e,i){function r(c,s){return c*=e,s*=i,[t+n*c,o-n*s]}return r.invert=function(c,s){return[(c-t)/n*e,(o-s)/n*i]},r}function Ht(n,t,o,e,i,r){if(!r)return oi(n,t,o,e,i);var c=b(r),s=G(r),d=c*n,g=s*n,a=c/n,l=s/n,u=(s*o-c*t)/n,h=(s*t+c*o)/n;function p(M,w){return M*=e,w*=i,[d*M-g*w+t,o-g*M-d*w]}return p.invert=function(M,w){return[e*(a*M-l*w+u),i*(h-l*M-a*w)]},p}function ri(n){return ai(function(){return n})()}function ai(n){var t,o=150,e=480,i=250,r=0,c=0,s=0,d=0,g=0,a,l=0,u=1,h=1,p=null,M=$t,w=null,I,P,L,S=et,R=.5,O,A,T,E,y;function m(f){return T(f[0]*q,f[1]*q)}function B(f){return f=T.invert(f[0],f[1]),f&&[f[0]*en,f[1]*en]}m.stream=function(f){return E&&y===f?E:E=ei(ii(a)(M(O(S(y=f)))))},m.preclip=function(f){return arguments.length?(M=f,p=void 0,_()):M},m.postclip=function(f){return arguments.length?(S=f,w=I=P=L=null,_()):S},m.clipAngle=function(f){return arguments.length?(M=+f?Ne(p=f*q):(p=null,$t),_()):p*en},m.clipExtent=function(f){return arguments.length?(S=f==null?(w=I=P=L=null,et):ke(w=+f[0][0],I=+f[0][1],P=+f[1][0],L=+f[1][1]),_()):w==null?null:[[w,I],[P,L]]},m.scale=function(f){return arguments.length?(o=+f,$()):o},m.translate=function(f){return arguments.length?(e=+f[0],i=+f[1],$()):[e,i]},m.center=function(f){return arguments.length?(r=f[0]%360*q,c=f[1]%360*q,$()):[r*en,c*en]},m.rotate=function(f){return arguments.length?(s=f[0]%360*q,d=f[1]%360*q,g=f.length>2?f[2]%360*q:0,$()):[s*en,d*en,g*en]},m.angle=function(f){return arguments.length?(l=f%360*q,$()):l*en},m.reflectX=function(f){return arguments.length?(u=f?-1:1,$()):u<0},m.reflectY=function(f){return arguments.length?(h=f?-1:1,$()):h<0},m.precision=function(f){return arguments.length?(O=bt(A,R=f*f),_()):ln(R)},m.fitExtent=function(f,v){return se(m,f,v)},m.fitSize=function(f,v){return Ze(m,f,v)},m.fitWidth=function(f,v){return Je(m,f,v)},m.fitHeight=function(f,v){return Qe(m,f,v)};function $(){var f=Ht(o,0,0,u,h,l).apply(null,t(r,c)),v=Ht(o,e-f[0],i-f[1],u,h,l);return a=Le(s,d,g),A=nt(t,v),T=nt(a,A),O=bt(A,R),_()}function _(){return E=y=null,m}return function(){return t=n.apply(this,arguments),m.invert=t.invert&&B,$()}}function si(n){return function(t,o){var e=b(t),i=b(o),r=n(e*i);return r===1/0?[2,0]:[r*i*G(t),r*G(o)]}}function ci(n){return function(t,o){var e=ln(t*t+o*o),i=n(e),r=G(i),c=b(i);return[wn(t*r,e*c),yn(e&&o*r/e)]}}var ce=si(function(n){return(n=xt(n))&&n/G(n)});ce.invert=ci(function(n){return n});function li(){return ri(ce).scale(79.4188).clipAngle(180-.001)}function ui(n){return n}function fi(n){if(n==null)return ui;var t,o,e=n.scale[0],i=n.scale[1],r=n.translate[0],c=n.translate[1];return function(s,d){d||(t=o=0);var g=2,a=s.length,l=new Array(a);for(l[0]=(t+=s[0])*e+r,l[1]=(o+=s[1])*i+c;g<a;)l[g]=s[g],++g;return l}}function hi(n,t){for(var o,e=n.length,i=e-t;i<--e;)o=n[i],n[i++]=n[e],n[e]=o}function di(n,t){return typeof t=="string"&&(t=n.objects[t]),t.type==="GeometryCollection"?{type:"FeatureCollection",features:t.geometries.map(function(o){return zt(n,o)})}:zt(n,t)}function zt(n,t){var o=t.id,e=t.bbox,i=t.properties==null?{}:t.properties,r=gi(n,t);return o==null&&e==null?{type:"Feature",properties:i,geometry:r}:e==null?{type:"Feature",id:o,properties:i,geometry:r}:{type:"Feature",id:o,bbox:e,properties:i,geometry:r}}function gi(n,t){var o=fi(n.transform),e=n.arcs;function i(a,l){l.length&&l.pop();for(var u=e[a<0?~a:a],h=0,p=u.length;h<p;++h)l.push(o(u[h],h));a<0&&hi(l,p)}function r(a){return o(a)}function c(a){for(var l=[],u=0,h=a.length;u<h;++u)i(a[u],l);return l.length<2&&l.push(l[0]),l}function s(a){for(var l=c(a);l.length<4;)l.push(l[0]);return l}function d(a){return a.map(s)}function g(a){var l=a.type,u;switch(l){case"GeometryCollection":return{type:l,geometries:a.geometries.map(g)};case"Point":u=r(a.coordinates);break;case"MultiPoint":u=a.coordinates.map(r);break;case"LineString":u=c(a.arcs);break;case"MultiLineString":u=a.arcs.map(c);break;case"Polygon":u=d(a.arcs);break;case"MultiPolygon":u=a.arcs.map(d);break;default:return null}return{type:l,coordinates:u}}return g(t)}const pi=6371;let Yn=null,Cn=null;async function mi(n="./land-110m.json"){if(!Yn)return Cn||(Cn=(async()=>{const t=await fetch(n,{cache:"force-cache"});if(!t.ok)throw new Error("land-110m.json load failed");const o=await t.json();Yn=di(o,o.objects.land)})(),Cn)}function vi(n){if(!Yn)return;const{ctx:t,x:o,y:e,w:i,h:r,userLon:c,userLat:s,headingDeg:d,hfovDeg:g,maxDistanceKm:a,styles:l}=n,u=o+i/2,h=e+r/2,p=Math.min(i,r)*.47,M=li().translate([u,h]).scale(p).rotate([-c,-s,d]),w=Ue(M,t);t.save(),t.globalAlpha=.95,t.fillStyle="rgba(10,12,14,0.7)",wi(t,o,e,i,r,8),t.fill();const I=g*Math.PI/180,P=p*(a/pi);t.beginPath(),t.moveTo(u,h),t.arc(u,h,P,-Math.PI/2-I/2,-Math.PI/2+I/2,!1),t.closePath(),t.clip(),t.globalAlpha=l?.alpha??.95,t.fillStyle=l?.fill??"rgba(60,90,70,0.25)",t.strokeStyle=l?.stroke??"rgba(255,255,255,0.45)",t.lineWidth=l?.lineWidth??.8,t.beginPath(),w(Yn),t.fill(),t.stroke(),t.restore()}function wi(n,t,o,e,i,r){n.beginPath(),n.moveTo(t+r,o),n.arcTo(t+e,o,t+e,o+i,r),n.arcTo(t+e,o+i,t,o+i,r),n.arcTo(t,o+i,t,o,r),n.arcTo(t,o,t+e,o,r),n.closePath()}function yi(n,t,o){const e=o/2,i=n/t*e+e;return Math.max(0,Math.min(o,i))}function Si(n,t,o){const e=o/2,i=-n/t*e+e;return Math.max(0,Math.min(o,i))}function Ei(n,t,o){return n*(o/Math.max(1,t))}function Mi(n,t){const o=t/2;return n>=-o&&n<=o}function Pi(n){return n<0?"left":"right"}const Ii=n=>`${n.name}|${n.country}`,mn=new Map;function Di(n,t){const i=new Set([...mn.keys(),...n.keys()]);for(const r of i){const c=mn.get(r)??0,s=n.has(r),d=s?Math.min(1,c+4*t):Math.max(0,c-3*t);d<=0&&!s?mn.delete(r):mn.set(r,d)}}function _i(n,t){return{w:n.measureText(t).width+12,h:24}}function Li(n,t){return!(n.x+n.w<t.x||t.x+t.w<n.x||n.y+n.h<t.y||t.y+t.h<n.y)}function Kt(n,t,o,e=12){const i=new Set,r=Math.max(12,n.h+6),c=n.y,s=[c];for(let d=1;d<=e;d++)s.push(c-d*r);for(let d=1;d<=e;d++)s.push(c+d*r);for(let d of s){if(d=Math.max(0,Math.min(o-n.h,d)),i.has(d))continue;i.add(d);const g={x:n.x,y:d,w:n.w,h:n.h};if(!t.some(a=>Li(a,g)))return d}return null}function Ri(n,t,o,e){const{width:i,height:r,hfovDeg:c,pitchDeg:s,headingDeg:d,cities:g,user:a,units:l,maxDistanceKm:u,showOffscreenIndicators:h,showMinimap:p}=t,M=Math.max(1,window.devicePixelRatio||1);(n.canvas.width!==Math.floor(i*M)||n.canvas.height!==Math.floor(r*M))&&(n.canvas.width=Math.floor(i*M),n.canvas.height=Math.floor(r*M)),n.setTransform(M,0,0,M,0,0),n.clearRect(0,0,i,r);const w=Ei(c,i,r),I=Si(s,w,r);n.save(),n.strokeStyle="rgba(180,200,220,0.25)",n.lineWidth=2,n.beginPath(),n.moveTo(0,I),n.lineTo(i,I),n.stroke(),n.restore();const P=.621371,L=g.map(y=>{const m=me(a.lat,a.lon,y.lat,y.lon);return{c:y,distKm:m,bearing:ve(a.lat,a.lon,y.lat,y.lon)}}).filter(y=>y.distKm<=u);L.sort((y,m)=>m.c.population-y.c.population);const S=[],R=[],O=[],A=new Set,T=24,E=e.v?Math.min(.1,(o-e.v)/1e3):0;e.v=o;for(const y of L){const m=Ii(y.c),B=dt(y.bearing-d),$=!Mi(B,c),_=l==="km"?y.distKm:y.distKm*P,f=_>=100?Math.round(_).toString():_.toFixed(1),v=y.c.population,D=v>=1e6?`~${(v/1e6).toFixed(1)}M`:`~${Math.round(v/1e3)}k`,N=`${y.c.name}, ${y.c.country} — ${f} ${l} — Pop ${D}`;n.font="600 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";const{w:k,h:K}=_i(n,N);let Z=yi(B,c,i);const j=Math.max(0,Math.min(r-T,I-6)),z={x:Math.max(4,Math.min(i-k-4,Z-k/2)),y:j-K,w:k,h:K};if($){if(!h){A.add(m);continue}A.add(m);const nn=mn.get(m)??0;if(nn<=.01)continue;const Y=Pi(B),W=6,tn=Y==="left"?{x:W,y:Math.max(0,Math.min(r-K,I-K/2)),w:k,h:K}:{x:i-W-k,y:Math.max(0,Math.min(r-K,I-K/2)),w:k,h:K},wt=Y==="left"?R:O,fe=Math.ceil(r/(tn.h+6))+2,yt=Kt(tn,wt,r,fe);if(yt===null)continue;tn.y=yt,wt.push({...tn});const an=tn.y+tn.h/2,St=tn.y+tn.h-6;n.save(),n.globalAlpha=nn,n.strokeStyle="rgba(255,255,255,0.6)",n.fillStyle="rgba(255,255,255,0.9)",n.lineWidth=2,n.beginPath(),Y==="left"?(n.moveTo(W,an),n.lineTo(W+10,an-6),n.moveTo(W,an),n.lineTo(W+10,an+6),n.stroke(),n.textAlign="left",n.fillText(N,W+16,St)):(n.moveTo(i-W,an),n.lineTo(i-W-10,an-6),n.moveTo(i-W,an),n.lineTo(i-W-10,an+6),n.stroke(),n.textAlign="right",n.fillText(N,i-W-16,St)),n.restore()}else{const nn=Math.ceil(r/(z.h+6))+2,Y=Kt(z,S,r,nn);if(Y===null)continue;z.y=Y,S.push({...z}),A.add(m);const W=mn.get(m)??0;if(W<=.01)continue;n.save(),n.globalAlpha=W,n.fillStyle="rgba(0,0,0,0.45)",n.strokeStyle="rgba(255,255,255,0.2)",Oi(n,z.x,z.y,z.w,z.h,6),n.fill(),n.fillStyle="white",n.shadowColor="rgba(0,0,0,0.6)",n.shadowBlur=2,n.fillText(N,z.x+6,z.y+z.h-6),n.restore()}}if(Di(A,E),p!==!1){const m=Math.min(240,Math.floor(i*.5)),B=Math.min(140,Math.floor(r*.35)),$=i-8-m,_=r-8-B;vi({ctx:n,x:$,y:_,w:m,h:B,userLon:a.lon,userLat:a.lat,headingDeg:d,hfovDeg:c,maxDistanceKm:u,styles:{stroke:"rgba(255,255,255,0.45)",fill:"rgba(60,90,70,0.25)",lineWidth:.8,alpha:1}})}return{visibleCount:S.length}}function Oi(n,t,o,e,i,r){n.beginPath(),n.moveTo(t+r,o),n.arcTo(t+e,o,t+e,o+i,r),n.arcTo(t+e,o+i,t,o+i,r),n.arcTo(t,o+i,t,o,r),n.arcTo(t,o,t+e,o,r),n.closePath()}const Ti=document.getElementById("camera"),sn=document.getElementById("overlay"),un=sn.getContext("2d");let cn={maxDistanceKm:1e3,units:"km",hfovDeg:60,headingOffsetDeg:0,smoothing:.15,showOffscreenIndicators:!1},mt={lat:39.996,lon:-74.0621},vt=!1,ht=[],qn=Pe({smoothing:cn.smoothing,headingOffsetDeg:cn.headingOffsetDeg});performance.now();let Mn=[],$i={v:0};const Bi=ge({settings:cn,onSettingsChange:n=>{cn=n,qn.setSmoothing(n.smoothing),qn.setHeadingOffset(n.headingOffsetDeg)},onStart:async()=>{Ai(),ye().catch(()=>{}),Se(Ti).catch(()=>{}),mi().catch(()=>{})},onManualGeo:n=>{mt=n,vt=!0,vn.setGeoStatus(`${n.lat.toFixed(5)}, ${n.lon.toFixed(5)} (manual)`)}}),vn=Bi;function Ai(){vn.setGeoStatus("requesting…"),Ee(n=>{mt={lat:n.lat,lon:n.lon},vt=!0,vn.setGeoStatus(`${n.lat.toFixed(5)}, ${n.lon.toFixed(5)} ±${Math.round(n.accuracy||0)}m`)},n=>{console.warn("Geolocation error",n);let t="location error";const o=n;if(typeof o?.code=="number")switch(o.code){case 1:t="permission denied — check site settings";break;case 2:t="position unavailable";break;case 3:t="timeout — move outdoors or check settings";break;default:t="location error"}else o?.message&&(t=o.message);vn.setGeoStatus(t),vn.showManualGeo(!0)})}async function Ci(){ht=await(await fetch("./cities.json")).json()}function le(){const n=sn.getBoundingClientRect();sn.width=n.width*window.devicePixelRatio,sn.height=n.height*window.devicePixelRatio}window.addEventListener("resize",le);le();let Wt=performance.now(),Zn=0;qn.subscribe(n=>{Zn++;const t=performance.now();if(t-Wt>1e3){Mn.push(Zn),Mn.length>4&&Mn.shift();const o=Mn.reduce((e,i)=>e+i,0)/Mn.length;vn.updateDebug(n.headingDeg,n.pitchDeg,n.rollDeg,n.source,o),Zn=0,Wt=t}});function ue(){const n=performance.now();let t=window.__arc_heading??0,o=window.__arc_pitch??0;window.__arc_bound||(window.__arc_bound=!0,qn.subscribe(r=>{window.__arc_heading=r.headingDeg,window.__arc_pitch=r.pitchDeg,window.__arc_roll=r.rollDeg}));const e=sn.clientWidth,i=sn.clientHeight;sn.width=Math.floor(e*window.devicePixelRatio),sn.height=Math.floor(i*window.devicePixelRatio),un.setTransform(window.devicePixelRatio,0,0,window.devicePixelRatio,0,0),vt&&ht.length>0?Ri(un,{width:e,height:i,hfovDeg:cn.hfovDeg,pitchDeg:o,headingDeg:t,units:cn.units,maxDistanceKm:cn.maxDistanceKm,user:mt,cities:ht,showOffscreenIndicators:cn.showOffscreenIndicators},n,$i):(un.clearRect(0,0,e,i),un.fillStyle="rgba(255,255,255,0.7)",un.font="600 16px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial",un.textAlign="center",un.fillText("Press Start and allow permissions",e/2,i/2)),requestAnimationFrame(ue)}Ci();requestAnimationFrame(ue);"serviceWorker"in navigator&&navigator.serviceWorker.register("./sw.js").catch(()=>{});
