(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function o(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(n){if(n.ep)return;n.ep=!0;const i=o(n);fetch(n.href,i)}})();const ye="arcities.settings.v2";function De(){try{const e=localStorage.getItem(ye);if(e)return JSON.parse(e)}catch{}return{maxDistanceKm:1e3,units:"km",hfovDeg:60,headingOffsetDeg:0,smoothing:.15,showOffscreenIndicators:!1}}function Ie(e){try{localStorage.setItem(ye,JSON.stringify(e))}catch{}}function ke(e){const t=e.settings||De();e.settings=t;const o=document.getElementById("startBtn"),a=document.getElementById("helpBtn"),n=document.getElementById("onboarding"),i=document.getElementById("collapseBtn"),r=document.getElementById("controlsBody"),l=document.getElementById("distance"),u=document.getElementById("distanceValue"),d=document.getElementById("unitsKm"),c=document.getElementById("unitsMi"),s=document.getElementById("hfov"),h=document.getElementById("hfovValue"),f=document.getElementById("headingOffset"),w=document.getElementById("headingOffsetValue"),M=document.getElementById("smooth"),T=document.getElementById("smoothValue"),D=document.getElementById("showOffscreen"),A=document.getElementById("dbgHeading"),b=document.getElementById("dbgPitch"),G=document.getElementById("dbgRoll"),L=document.getElementById("dbgSource"),R=document.getElementById("dbgRate"),N=document.getElementById("dbgSmooth"),_=document.getElementById("geoText"),y=document.getElementById("manualGeo"),g=document.getElementById("lat"),m=document.getElementById("lon"),S=document.getElementById("setGeo");localStorage.getItem("arcities.onboarded")||n.showModal(),document.getElementById("onboardingClose").addEventListener("click",()=>{localStorage.setItem("arcities.onboarded","1")}),a.addEventListener("click",()=>n.showModal()),i.addEventListener("click",()=>{const p=!(i.getAttribute("aria-expanded")==="true");i.setAttribute("aria-expanded",String(p)),r.style.display=p?"block":"none",i.textContent=p?"▾":"▸"}),l.value=String(t.maxDistanceKm),s.value=String(t.hfovDeg),f.value=String(t.headingOffsetDeg),M.value=String(t.smoothing),t.units==="km"?d.checked=!0:c.checked=!0,D.checked=!!t.showOffscreenIndicators;function I(v,p){if(p==="km")return`${Math.round(v)} km`;const k=v*.621371;return`${Math.round(k)} mi`}function P(){u.textContent=I(Number(l.value),t.units),h.textContent=`${s.value}°`,w.textContent=`${f.value}°`,T.textContent=`${Number(M.value).toFixed(2)}`}P();function E(){Ie(t),e.onSettingsChange?.(t),P()}return l.addEventListener("input",()=>{t.maxDistanceKm=Number(l.value),E()}),s.addEventListener("input",()=>{t.hfovDeg=Number(s.value),E()}),f.addEventListener("input",()=>{t.headingOffsetDeg=Number(f.value),E()}),M.addEventListener("input",()=>{t.smoothing=Number(M.value),E()}),D.addEventListener("change",()=>{t.showOffscreenIndicators=D.checked,E()}),d.addEventListener("change",()=>{t.units="km",E()}),c.addEventListener("change",()=>{t.units="mi",E()}),o.addEventListener("click",()=>e.onStart?.()),S.addEventListener("click",()=>{const v=Number(g.value),p=Number(m.value);!Number.isFinite(v)||!Number.isFinite(p)||e.onManualGeo?.({lat:v,lon:p})}),{setGeoStatus(v){_.textContent=v},showManualGeo(v){y.classList.toggle("hidden",!v)},updateDebug(v,p,k,C,B){A.textContent=v.toFixed(1),b.textContent=p.toFixed(1),G.textContent=k.toFixed(1),L.textContent=C,R.textContent=B?B.toFixed(0):"–",N.textContent=t.smoothing.toFixed(2)},getSettings(){return t}}}function q(e){return e*Math.PI/180}function Oe(e){return e*180/Math.PI}function K(e){let t=e%360;return t<0&&(t+=360),t}function Z(e){return((e+180)%360+360)%360-180}function ve(e,t,o,a){const n=6371.0088,i=q(o-e),r=q(a-t),l=Math.sin(i/2)**2+Math.cos(q(e))*Math.cos(q(o))*Math.sin(r/2)**2,u=2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l));return n*u}function Te(e,t,o,a){const n=q(e),i=q(o),r=q(a-t),l=Math.sin(r)*Math.cos(i),u=Math.cos(n)*Math.sin(i)-Math.sin(n)*Math.cos(i)*Math.cos(r),d=Oe(Math.atan2(l,u));return K(d)}function Le(e,t,o){const a=Z(t-e);return K(e+a*(1-Math.exp(-o)))}function he(e,t,o){return e+(t-e)*(1-Math.exp(-o))}async function Be(){try{const e=window,t=e.DeviceMotionEvent&&typeof e.DeviceMotionEvent.requestPermission=="function"?await e.DeviceMotionEvent.requestPermission():"granted",o=e.DeviceOrientationEvent&&typeof e.DeviceOrientationEvent.requestPermission=="function"?await e.DeviceOrientationEvent.requestPermission():"granted"}catch{}}async function Re(e){try{const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}},audio:!1});return e.srcObject=t,await e.play(),t}catch(t){return console.warn("Camera access failed",t),null}}function Ce(e,t){if(!("geolocation"in navigator))return t(new DOMException("Geolocation not supported")),()=>{};if(!window.isSecureContext)return t(new DOMException("Geolocation requires HTTPS")),()=>{};let o=null;const a={enableHighAccuracy:!0,maximumAge:5e3,timeout:2e4};try{navigator.geolocation.getCurrentPosition(n=>{const{latitude:i,longitude:r,accuracy:l}=n.coords;e({lat:i,lon:r,accuracy:l})},n=>{t(n)},a)}catch(n){t(n)}try{o=navigator.geolocation.watchPosition(n=>{const{latitude:i,longitude:r,accuracy:l}=n.coords;e({lat:i,lon:r,accuracy:l})},n=>t(n),a)}catch(n){t(n)}return()=>{o!==null&&navigator.geolocation.clearWatch(o)}}function Ae(e,t,o,a){const n=t*t,i=2*(a*e+t*o),r=1-2*(e*e+n),l=Math.atan2(i,r);let u=2*(a*t-o*e);u=Math.max(-1,Math.min(1,u));const d=Math.asin(u),c=2*(a*o+e*t),s=1-2*(n+o*o);return{yaw:Math.atan2(c,s)*180/Math.PI,pitch:d*180/Math.PI,roll:l*180/Math.PI}}function Fe(e){let t=e.smoothing,o=e.headingOffsetDeg,a=new Set,n="deviceorientation+motion",i=null,r=0,l=0,u=0,d=0,c={headingDeg:0,pitchDeg:0,rollDeg:0,timestamp:performance.now()};const s=.02,h=.01;let f=null;const w=window,M=w.AbsoluteOrientationSensor,T=w.RelativeOrientationSensor;let D=null;function A(y){const g=K(r+o),m=l,S=u,I=Le(c.headingDeg,g,t),P=he(c.pitchDeg,m,t),E=he(c.rollDeg,S,t),v={headingDeg:I,pitchDeg:P,rollDeg:E,source:n,timestamp:y};c=v,a.forEach(p=>p(v))}function b(){try{const y=M||T;if(!y)return!1;const g=new y({frequency:60});return D=g,n="generic-sensor",g.onreading=()=>{const m=g.quaternion;if(!m)return;const{yaw:S,pitch:I,roll:P}=Ae(m[0],m[1],m[2],m[3]);r=K(S),l=I,u=P,A(performance.now())},g.onerror=()=>{},g.start(),!0}catch{return!1}}function G(){n="deviceorientation+motion";function y(m){const S=m;typeof S.webkitCompassHeading=="number"?f=K(S.webkitCompassHeading):typeof m.alpha=="number"&&(f=K(m.alpha))}function g(m){const S=performance.now(),I=d?(S-d)/1e3:0;d=S;const P=m.rotationRate;if(P){const v=P.alpha??0,p=P.beta??0,k=P.gamma??0;r=K(r+v*I),l=l+p*I,u=u+k*I}const E=m.accelerationIncludingGravity;if(E){const v=E.x??0,p=E.y??0,k=E.z??-9.8,C=Math.atan2(-v,Math.hypot(p,k))*180/Math.PI,B=Math.atan2(p,k)*180/Math.PI;l=l*(1-s)+C*s,u=u*(1-s)+B*s}if(f!=null){const v=Z(f-r);r=K(r+v*h)}A(S)}return window.addEventListener("deviceorientation",y,!0),window.addEventListener("devicemotion",g,!0),()=>{window.removeEventListener("deviceorientation",y,!0),window.removeEventListener("devicemotion",g,!0)}}let L=[];function R(){n="virtual";let y=!1,g=0,m=0;const S=.1,I=.1;function P(p){y=!0,g=p.clientX,m=p.clientY,p.target.setPointerCapture?.(p.pointerId)}function E(p){y=!1,p.target.releasePointerCapture?.(p.pointerId)}function v(p){if(!y)return;const k=p.clientX-g,C=p.clientY-m;g=p.clientX,m=p.clientY,r=K(r+k*S),l=Math.max(-89,Math.min(89,l-C*I)),A(performance.now())}window.addEventListener("pointerdown",P),window.addEventListener("pointerup",E),window.addEventListener("pointermove",v),L.push(()=>{window.removeEventListener("pointerdown",P),window.removeEventListener("pointerup",E),window.removeEventListener("pointermove",v)})}if(!b()){const y=G();L.push(y);const g=setTimeout(()=>{d===0&&f==null&&R()},2e3);L.push(()=>clearTimeout(g))}function _(){A(performance.now()),i=requestAnimationFrame(_)}return i=requestAnimationFrame(_),{subscribe(y){return a.add(y),()=>a.delete(y)},setSmoothing(y){t=Math.max(0,Math.min(.3,y))},setHeadingOffset(y){o=y},getSource(){return n},stop(){i!==null&&cancelAnimationFrame(i),L.forEach(y=>y()),D?.stop?.(),a.clear()}}}function Ge(e,t,o){const a=o/2,n=e/t*a+a;return Math.max(0,Math.min(o,n))}function _e(e,t,o){const a=o/2,n=-e/t*a+a;return Math.max(0,Math.min(o,n))}function $e(e,t,o){return e*(o/Math.max(1,t))}function Ne(e,t){const o=t/2;return e>=-o&&e<=o}function He(e){return e<0?"left":"right"}function Ke(e){return e}function je(e){if(e==null)return Ke;var t,o,a=e.scale[0],n=e.scale[1],i=e.translate[0],r=e.translate[1];return function(l,u){u||(t=o=0);var d=2,c=l.length,s=new Array(c);for(s[0]=(t+=l[0])*a+i,s[1]=(o+=l[1])*n+r;d<c;)s[d]=l[d],++d;return s}}function We(e,t){for(var o,a=e.length,n=a-t;n<--a;)o=e[n],e[n++]=e[a],e[a]=o}function Ye(e,t){return typeof t=="string"&&(t=e.objects[t]),t.type==="GeometryCollection"?{type:"FeatureCollection",features:t.geometries.map(function(o){return fe(e,o)})}:fe(e,t)}function fe(e,t){var o=t.id,a=t.bbox,n=t.properties==null?{}:t.properties,i=we(e,t);return o==null&&a==null?{type:"Feature",properties:n,geometry:i}:a==null?{type:"Feature",id:o,properties:n,geometry:i}:{type:"Feature",id:o,bbox:a,properties:n,geometry:i}}function we(e,t){var o=je(e.transform),a=e.arcs;function n(c,s){s.length&&s.pop();for(var h=a[c<0?~c:c],f=0,w=h.length;f<w;++f)s.push(o(h[f],f));c<0&&We(s,w)}function i(c){return o(c)}function r(c){for(var s=[],h=0,f=c.length;h<f;++h)n(c[h],s);return s.length<2&&s.push(s[0]),s}function l(c){for(var s=r(c);s.length<4;)s.push(s[0]);return s}function u(c){return c.map(l)}function d(c){var s=c.type,h;switch(s){case"GeometryCollection":return{type:s,geometries:c.geometries.map(d)};case"Point":h=i(c.coordinates);break;case"MultiPoint":h=c.coordinates.map(i);break;case"LineString":h=r(c.arcs);break;case"MultiLineString":h=c.arcs.map(r);break;case"Polygon":h=u(c.arcs);break;case"MultiPolygon":h=c.arcs.map(u);break;default:return null}return{type:s,coordinates:h}}return d(t)}function Ve(e,t){var o={},a={},n={},i=[],r=-1;t.forEach(function(d,c){var s=e.arcs[d<0?~d:d],h;s.length<3&&!s[1][0]&&!s[1][1]&&(h=t[++r],t[r]=d,t[c]=h)}),t.forEach(function(d){var c=l(d),s=c[0],h=c[1],f,w;if(f=n[s])if(delete n[f.end],f.push(d),f.end=h,w=a[h]){delete a[w.start];var M=w===f?f:f.concat(w);a[M.start=f.start]=n[M.end=w.end]=M}else a[f.start]=n[f.end]=f;else if(f=a[h])if(delete a[f.start],f.unshift(d),f.start=s,w=n[s]){delete n[w.end];var T=w===f?f:w.concat(f);a[T.start=w.start]=n[T.end=f.end]=T}else a[f.start]=n[f.end]=f;else f=[d],a[f.start=s]=n[f.end=h]=f});function l(d){var c=e.arcs[d<0?~d:d],s=c[0],h;return e.transform?(h=[0,0],c.forEach(function(f){h[0]+=f[0],h[1]+=f[1]})):h=c[c.length-1],d<0?[h,s]:[s,h]}function u(d,c){for(var s in d){var h=d[s];delete c[h.start],delete h.start,delete h.end,h.forEach(function(f){o[f<0?~f:f]=1}),i.push(h)}}return u(n,a),u(a,n),t.forEach(function(d){o[d<0?~d:d]||i.push([d])}),i}function Ue(e){return we(e,qe.apply(this,arguments))}function qe(e,t,o){var a,n,i;if(arguments.length>1)a=Je(e,t,o);else for(n=0,a=new Array(i=e.arcs.length);n<i;++n)a[n]=n;return{type:"MultiLineString",arcs:Ve(e,a)}}function Je(e,t,o){var a=[],n=[],i;function r(s){var h=s<0?~s:s;(n[h]||(n[h]=[])).push({i:s,g:i})}function l(s){s.forEach(r)}function u(s){s.forEach(l)}function d(s){s.forEach(u)}function c(s){switch(i=s,s.type){case"GeometryCollection":s.geometries.forEach(c);break;case"LineString":l(s.arcs);break;case"MultiLineString":case"Polygon":u(s.arcs);break;case"MultiPolygon":d(s.arcs);break}}return c(t),n.forEach(o==null?function(s){a.push(s[0].i)}:function(s){o(s[0].g,s[s.length-1].g)&&a.push(s[0].i)}),a}const Xe="https://unpkg.com/world-atlas@2/land-110m.json",ze="https://unpkg.com/world-atlas@2/countries-110m.json";let x=null,X=null,ne=null;async function Qe(){if(!(X&&ne)){if(x)return x;x=(async()=>{const[e,t]=await Promise.all([fetch(Xe,{cache:"force-cache"}),fetch(ze,{cache:"force-cache"})]);if(!e.ok||!t.ok)throw new Error("Failed to load world atlas");const[o,a]=await Promise.all([e.json(),t.json()]);X=Ye(o,o.objects.land),ne=Ue(a,a.objects.countries,(r,l)=>r!==l)})();try{await x}finally{x=null}}}function W(e,t,o,a,n,i){const r=o+(e+180)/360*n,l=a+(90-t)/180*i;return{px:r,py:l}}function $(e){return e*Math.PI/180}function ge(e){return e*180/Math.PI}function ie(e,t,o,a){const i=a/6371,r=$(o),l=$(e),u=$(t),d=Math.sin(l),c=Math.cos(l),s=Math.sin(i),h=Math.cos(i),f=d*h+c*s*Math.cos(r),w=Math.asin(Math.max(-1,Math.min(1,f))),M=Math.sin(r)*s*c,T=h-d*f,D=u+Math.atan2(M,T);return{lat:ge(w),lon:(ge(D)+540)%360-180}}function Ze(e,t,o,a,n,i){e.beginPath(),e.moveTo(t+i,o),e.arcTo(t+a,o,t+a,o+n,i),e.arcTo(t+a,o+n,t,o+n,i),e.arcTo(t,o+n,t,o,i),e.arcTo(t,o,t+a,o,i),e.closePath()}function xe(e,t,o,a,n,i){for(const r of t.coordinates){for(let l=0;l<r.length;l++){const[u,d]=r[l],{px:c,py:s}=W(u,d,o,a,n,i);l===0?e.moveTo(c,s):e.lineTo(c,s)}e.closePath()}}function et(e,t,o,a,n,i){for(const r of t.coordinates)for(const l of r){for(let u=0;u<l.length;u++){const[d,c]=l[u],{px:s,py:h}=W(d,c,o,a,n,i);u===0?e.moveTo(s,h):e.lineTo(s,h)}e.closePath()}}function tt(e,t,o,a,n,i){const r=t.type==="LineString"?[t.coordinates]:t.coordinates;for(const l of r)for(let u=0;u<l.length;u++){const[d,c]=l[u],{px:s,py:h}=W(d,c,o,a,n,i);u===0?e.moveTo(s,h):e.lineTo(s,h)}}async function nt(e,t){const{x:o,y:a,w:n,h:i,user:r,headingDeg:l,hfovDeg:u,maxDistanceKm:d,cities:c}=t;e.save(),e.globalAlpha=.95,e.fillStyle="rgba(10,12,14,0.7)",Ze(e,o,a,n,i,8),e.fill(),e.restore();try{await Qe()}catch{}X&&(e.save(),e.strokeStyle="rgba(120,160,120,0.6)",e.fillStyle="rgba(40,80,50,0.35)",e.lineWidth=1,e.beginPath(),X.type==="Polygon"?xe(e,X,o,a,n,i):et(e,X,o,a,n,i),e.fill(),e.stroke(),e.restore()),ne&&(e.save(),e.strokeStyle="rgba(255,255,255,0.45)",e.lineWidth=.8,e.beginPath(),tt(e,ne,o,a,n,i),e.stroke(),e.restore());const s=W(r.lon,r.lat,o,a,n,i);e.save(),e.fillStyle="rgba(255,255,255,0.9)",e.beginPath(),e.arc(s.px,s.py,2.5,0,Math.PI*2),e.fill(),e.restore(),e.save(),e.strokeStyle="rgba(255,255,255,0.4)",e.lineWidth=1,e.beginPath();const h=128;for(let b=0;b<=h;b++){const G=b/h*360,L=ie(r.lat,r.lon,G,d),R=W(L.lon,L.lat,o,a,n,i);b===0?e.moveTo(R.px,R.py):e.lineTo(R.px,R.py)}e.closePath(),e.stroke(),e.restore(),e.save(),e.strokeStyle="rgba(255,220,120,0.7)",e.fillStyle="rgba(255,220,120,0.15)",e.lineWidth=1;const f=Z(l-u/2),w=Z(l+u/2),M=ie(r.lat,r.lon,f,d),T=ie(r.lat,r.lon,w,d),D=W(M.lon,M.lat,o,a,n,i),A=W(T.lon,T.lat,o,a,n,i);e.beginPath(),e.moveTo(s.px,s.py),e.lineTo(D.px,D.py),e.lineTo(A.px,A.py),e.closePath(),e.fill(),e.stroke(),e.restore(),e.save();for(const b of c){const L=ve(r.lat,r.lon,b.lat,b.lon)<=d,{px:R,py:N}=W(b.lon,b.lat,o,a,n,i);let _=.25,y="rgba(180,220,255,";if(L){const g=Math.atan2(Math.sin($(b.lon-r.lon))*Math.cos($(b.lat)),Math.cos($(r.lat))*Math.sin($(b.lat))-Math.sin($(r.lat))*Math.cos($(b.lat))*Math.cos($(b.lon-r.lon)))*180/Math.PI;Math.abs(Z(g-l))<=u/2?(_=.9,y="rgba(255,255,255,"):(_=.6,y="rgba(120,180,255,")}e.fillStyle=`${y}${_})`,e.fillRect(R-1,N-1,2,2)}e.restore()}const ot=e=>`${e.name}|${e.country}`,z=new Map;function it(e,t){const n=new Set([...z.keys(),...e.keys()]);for(const i of n){const r=z.get(i)??0,l=e.has(i),u=l?Math.min(1,r+4*t):Math.max(0,r-3*t);u<=0&&!l?z.delete(i):z.set(i,u)}}function at(e,t){return{w:e.measureText(t).width+12,h:24}}function st(e,t){return!(e.x+e.w<t.x||t.x+t.w<e.x||e.y+e.h<t.y||t.y+t.h<e.y)}function me(e,t,o,a=12){const n=new Set,i=Math.max(12,e.h+6),r=e.y,l=[r];for(let u=1;u<=a;u++)l.push(r-u*i);for(let u=1;u<=a;u++)l.push(r+u*i);for(let u of l){if(u=Math.max(0,Math.min(o-e.h,u)),n.has(u))continue;n.add(u);const d={x:e.x,y:u,w:e.w,h:e.h};if(!t.some(c=>st(c,d)))return u}return null}function rt(e,t,o,a){const{width:n,height:i,hfovDeg:r,pitchDeg:l,headingDeg:u,cities:d,user:c,units:s,maxDistanceKm:h,showOffscreenIndicators:f,showMinimap:w}=t,M=Math.max(1,window.devicePixelRatio||1);(e.canvas.width!==Math.floor(n*M)||e.canvas.height!==Math.floor(i*M))&&(e.canvas.width=Math.floor(n*M),e.canvas.height=Math.floor(i*M)),e.setTransform(M,0,0,M,0,0),e.clearRect(0,0,n,i);const T=$e(r,n,i),D=_e(l,T,i);e.save(),e.strokeStyle="rgba(180,200,220,0.25)",e.lineWidth=2,e.beginPath(),e.moveTo(0,D),e.lineTo(n,D),e.stroke(),e.restore();const A=.621371,b=d.map(g=>{const m=ve(c.lat,c.lon,g.lat,g.lon);return{c:g,distKm:m,bearing:Te(c.lat,c.lon,g.lat,g.lon)}}).filter(g=>g.distKm<=h);b.sort((g,m)=>m.c.population-g.c.population);const G=[],L=[],R=[],N=new Set,_=24,y=a.v?Math.min(.1,(o-a.v)/1e3):0;a.v=o;for(const g of b){const m=ot(g.c),S=Z(g.bearing-u),I=!Ne(S,r),P=s==="km"?g.distKm:g.distKm*A,E=P>=100?Math.round(P).toString():P.toFixed(1),v=g.c.population,p=v>=1e6?`~${(v/1e6).toFixed(1)}M`:`~${Math.round(v/1e3)}k`,k=`${g.c.name}, ${g.c.country} — ${E} ${s} — Pop ${p}`;e.font="600 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";const{w:C,h:B}=at(e,k);let Se=Ge(S,r,n);const Pe=Math.max(0,Math.min(i-_,D-6)),F={x:Math.max(4,Math.min(n-C-4,Se-C/2)),y:Pe-B,w:C,h:B};if(I){if(!f){N.add(m);continue}N.add(m);const te=z.get(m)??0;if(te<=.01)continue;const J=He(S),O=6,H=J==="left"?{x:O,y:Math.max(0,Math.min(i-B,D-B/2)),w:C,h:B}:{x:n-O-C,y:Math.max(0,Math.min(i-B,D-B/2)),w:C,h:B},le=J==="left"?L:R,Ee=Math.ceil(i/(H.h+6))+2,ue=me(H,le,i,Ee);if(ue===null)continue;H.y=ue,le.push({...H});const j=H.y+H.h/2,de=H.y+H.h-6;e.save(),e.globalAlpha=te,e.strokeStyle="rgba(255,255,255,0.6)",e.fillStyle="rgba(255,255,255,0.9)",e.lineWidth=2,e.beginPath(),J==="left"?(e.moveTo(O,j),e.lineTo(O+10,j-6),e.moveTo(O,j),e.lineTo(O+10,j+6),e.stroke(),e.textAlign="left",e.fillText(k,O+16,de)):(e.moveTo(n-O,j),e.lineTo(n-O-10,j-6),e.moveTo(n-O,j),e.lineTo(n-O-10,j+6),e.stroke(),e.textAlign="right",e.fillText(k,n-O-16,de)),e.restore()}else{const te=Math.ceil(i/(F.h+6))+2,J=me(F,G,i,te);if(J===null)continue;F.y=J,G.push({...F}),N.add(m);const O=z.get(m)??0;if(O<=.01)continue;e.save(),e.globalAlpha=O,e.fillStyle="rgba(0,0,0,0.45)",e.strokeStyle="rgba(255,255,255,0.2)",ct(e,F.x,F.y,F.w,F.h,6),e.fill(),e.fillStyle="white",e.shadowColor="rgba(0,0,0,0.6)",e.shadowBlur=2,e.fillText(k,F.x+6,F.y+F.h-6),e.restore()}}if(it(N,y),w!==!1){const m=Math.min(240,Math.floor(n*.5)),S=Math.min(140,Math.floor(i*.35)),I=n-8-m,P=i-8-S;nt(e,{x:I,y:P,w:m,h:S,user:c,headingDeg:u,hfovDeg:r,maxDistanceKm:h,cities:d})}return{visibleCount:G.length}}function ct(e,t,o,a,n,i){e.beginPath(),e.moveTo(t+i,o),e.arcTo(t+a,o,t+a,o+n,i),e.arcTo(t+a,o+n,t,o+n,i),e.arcTo(t,o+n,t,o,i),e.arcTo(t,o,t+a,o,i),e.closePath()}const lt=document.getElementById("camera"),Y=document.getElementById("overlay"),U=Y.getContext("2d");let V={maxDistanceKm:1e3,units:"km",hfovDeg:60,headingOffsetDeg:0,smoothing:.15,showOffscreenIndicators:!1},re={lat:39.996,lon:-74.0621},ce=!1,se=[],oe=Fe({smoothing:V.smoothing,headingOffsetDeg:V.headingOffsetDeg});performance.now();let ee=[],ut={v:0};const dt=ke({settings:V,onSettingsChange:e=>{V=e,oe.setSmoothing(e.smoothing),oe.setHeadingOffset(e.headingOffsetDeg)},onStart:async()=>{ht(),Be().catch(()=>{}),Re(lt).catch(()=>{})},onManualGeo:e=>{re=e,ce=!0,Q.setGeoStatus(`${e.lat.toFixed(5)}, ${e.lon.toFixed(5)} (manual)`)}}),Q=dt;function ht(){Q.setGeoStatus("requesting…"),Ce(e=>{re={lat:e.lat,lon:e.lon},ce=!0,Q.setGeoStatus(`${e.lat.toFixed(5)}, ${e.lon.toFixed(5)} ±${Math.round(e.accuracy||0)}m`)},e=>{console.warn("Geolocation error",e);let t="location error";const o=e;if(typeof o?.code=="number")switch(o.code){case 1:t="permission denied — check site settings";break;case 2:t="position unavailable";break;case 3:t="timeout — move outdoors or check settings";break;default:t="location error"}else o?.message&&(t=o.message);Q.setGeoStatus(t),Q.showManualGeo(!0)})}async function ft(){se=await(await fetch("./cities.json")).json()}function Me(){const e=Y.getBoundingClientRect();Y.width=e.width*window.devicePixelRatio,Y.height=e.height*window.devicePixelRatio}window.addEventListener("resize",Me);Me();let pe=performance.now(),ae=0;oe.subscribe(e=>{ae++;const t=performance.now();if(t-pe>1e3){ee.push(ae),ee.length>4&&ee.shift();const o=ee.reduce((a,n)=>a+n,0)/ee.length;Q.updateDebug(e.headingDeg,e.pitchDeg,e.rollDeg,e.source,o),ae=0,pe=t}});function be(){const e=performance.now();let t=window.__arc_heading??0,o=window.__arc_pitch??0;window.__arc_bound||(window.__arc_bound=!0,oe.subscribe(i=>{window.__arc_heading=i.headingDeg,window.__arc_pitch=i.pitchDeg,window.__arc_roll=i.rollDeg}));const a=Y.clientWidth,n=Y.clientHeight;Y.width=Math.floor(a*window.devicePixelRatio),Y.height=Math.floor(n*window.devicePixelRatio),U.setTransform(window.devicePixelRatio,0,0,window.devicePixelRatio,0,0),ce&&se.length>0?rt(U,{width:a,height:n,hfovDeg:V.hfovDeg,pitchDeg:o,headingDeg:t,units:V.units,maxDistanceKm:V.maxDistanceKm,user:re,cities:se,showOffscreenIndicators:V.showOffscreenIndicators},e,ut):(U.clearRect(0,0,a,n),U.fillStyle="rgba(255,255,255,0.7)",U.font="600 16px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial",U.textAlign="center",U.fillText("Press Start and allow permissions",a/2,n/2)),requestAnimationFrame(be)}ft();requestAnimationFrame(be);"serviceWorker"in navigator&&navigator.serviceWorker.register("./sw.js").catch(()=>{});
