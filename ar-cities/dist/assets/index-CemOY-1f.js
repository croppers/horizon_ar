(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function o(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(n){if(n.ep)return;n.ep=!0;const i=o(n);fetch(n.href,i)}})();const me="arcities.settings.v2";function we(){try{const e=localStorage.getItem(me);if(e)return JSON.parse(e)}catch{}return{maxDistanceKm:1e3,units:"km",hfovDeg:60,headingOffsetDeg:0,smoothing:.15,showOffscreenIndicators:!1}}function ve(e){try{localStorage.setItem(me,JSON.stringify(e))}catch{}}function ye(e){const t=e.settings||we();e.settings=t;const o=document.getElementById("startBtn"),a=document.getElementById("helpBtn"),n=document.getElementById("onboarding"),i=document.getElementById("collapseBtn"),r=document.getElementById("controlsBody"),d=document.getElementById("distance"),c=document.getElementById("distanceValue"),S=document.getElementById("unitsKm"),M=document.getElementById("unitsMi"),P=document.getElementById("hfov"),U=document.getElementById("hfovValue"),B=document.getElementById("headingOffset"),k=document.getElementById("headingOffsetValue"),F=document.getElementById("smooth"),G=document.getElementById("smoothValue"),$=document.getElementById("showOffscreen"),A=document.getElementById("dbgHeading"),q=document.getElementById("dbgPitch"),J=document.getElementById("dbgRoll"),_=document.getElementById("dbgSource"),H=document.getElementById("dbgRate"),Z=document.getElementById("dbgSmooth"),X=document.getElementById("geoText"),s=document.getElementById("manualGeo"),u=document.getElementById("lat"),g=document.getElementById("lon"),b=document.getElementById("setGeo"),y=document.getElementById("allowLocationRow"),D=document.getElementById("allowLocationBtn");function E(l,p){if(!l)return null;let v=l.trim().toUpperCase();v=v.replace(/,/g," "),v=v.replace(/[\s]+/g," ");let m=null;const T=v.match(/([NSEW])$/);T&&(m=T[1],v=v.slice(0,-1).trim());const O=[];let w=v.replace(/°/g," ").replace(/'/g," ").replace(/"/g," ");if(w=w.replace(/[\s]+/g," ").trim(),!w)return null;for(const ce of w.split(" ")){if(!ce)continue;const le=Number(ce);if(!Number.isFinite(le))return null;if(O.push(le),O.length===3)break}if(O.length===0)return null;const x=O[0],ee=O[1]||0,ie=O[2]||0;let W=1;x<0&&(W=-1),m&&((m==="S"||m==="W")&&(W=-1),(m==="N"||m==="E")&&(W=1));let C=Math.abs(x)+Math.abs(ee)/60+Math.abs(ie)/3600,z=W*C;if(p){if(Math.abs(z)>90)return null}else if(Math.abs(z)>180)return null;return z}localStorage.getItem("arcities.onboarded")||n.showModal(),document.getElementById("onboardingClose").addEventListener("click",()=>{localStorage.setItem("arcities.onboarded","1")}),a.addEventListener("click",()=>n.showModal()),i.addEventListener("click",()=>{const p=!(i.getAttribute("aria-expanded")==="true");i.setAttribute("aria-expanded",String(p)),r.style.display=p?"block":"none",i.textContent=p?"▾":"▸"}),d.value=String(t.maxDistanceKm),P.value=String(t.hfovDeg),B.value=String(t.headingOffsetDeg),F.value=String(t.smoothing),t.units==="km"?S.checked=!0:M.checked=!0,$.checked=!!t.showOffscreenIndicators;function I(l,p){if(p==="km")return`${Math.round(l)} km`;const v=l*.621371;return`${Math.round(v)} mi`}function h(){c.textContent=I(Number(d.value),t.units),U.textContent=`${P.value}°`,k.textContent=`${B.value}°`,G.textContent=`${Number(F.value).toFixed(2)}`}h();try{const l=navigator;l.permissions&&typeof l.permissions.query=="function"&&l.permissions.query({name:"geolocation"}).then(p=>{const v=p.state;y?.classList.toggle("hidden",v==="granted"),p.onchange=()=>{const m=p.state;y?.classList.toggle("hidden",m==="granted")}}).catch(()=>{})}catch{}function f(){ve(t),e.onSettingsChange?.(t),h()}return d.addEventListener("input",()=>{t.maxDistanceKm=Number(d.value),f()}),P.addEventListener("input",()=>{t.hfovDeg=Number(P.value),f()}),B.addEventListener("input",()=>{t.headingOffsetDeg=Number(B.value),f()}),F.addEventListener("input",()=>{t.smoothing=Number(F.value),f()}),$.addEventListener("change",()=>{t.showOffscreenIndicators=$.checked,f()}),S.addEventListener("change",()=>{t.units="km",f()}),M.addEventListener("change",()=>{t.units="mi",f()}),o.addEventListener("click",()=>e.onStart?.()),D?.addEventListener("click",()=>e.onRequestLocation?.()),b.addEventListener("click",()=>{const l=E(u.value,!0),p=E(g.value,!1);if(!Number.isFinite(l)||!Number.isFinite(p)){const v=document.getElementById("geoText");v&&(v.textContent="invalid lat/lon format");return}e.onManualGeo?.({lat:l,lon:p})}),{setGeoStatus(l){X.textContent=l},showManualGeo(l){s.classList.toggle("hidden",!l)},showAllowLocation(l){y?.classList.toggle("hidden",!l)},updateDebug(l,p,v,m,T){A.textContent=l.toFixed(1),q.textContent=p.toFixed(1),J.textContent=v.toFixed(1),_.textContent=m,H.textContent=T?T.toFixed(0):"–",Z.textContent=t.smoothing.toFixed(2)},getSettings(){return t}}}function V(e){return e*Math.PI/180}function Me(e){return e*180/Math.PI}function R(e){let t=e%360;return t<0&&(t+=360),t}function re(e){return((e+180)%360+360)%360-180}function be(e,t,o,a){const n=6371.0088,i=V(o-e),r=V(a-t),d=Math.sin(i/2)**2+Math.cos(V(e))*Math.cos(V(o))*Math.sin(r/2)**2,c=2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d));return n*c}function Ee(e,t,o,a){const n=V(e),i=V(o),r=V(a-t),d=Math.sin(r)*Math.cos(i),c=Math.cos(n)*Math.sin(i)-Math.sin(n)*Math.cos(i)*Math.cos(r),S=Me(Math.atan2(d,c));return R(S)}function Se(e,t,o){const a=re(t-e);return R(e+a*(1-Math.exp(-o)))}function de(e,t,o){return e+(t-e)*(1-Math.exp(-o))}async function De(){try{const e=window,t=e.DeviceMotionEvent&&typeof e.DeviceMotionEvent.requestPermission=="function"?await e.DeviceMotionEvent.requestPermission():"granted",o=e.DeviceOrientationEvent&&typeof e.DeviceOrientationEvent.requestPermission=="function"?await e.DeviceOrientationEvent.requestPermission():"granted"}catch{}}async function Ie(e){try{const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}},audio:!1});return e.srcObject=t,await e.play(),t}catch(t){return console.warn("Camera access failed",t),null}}function Le(e,t){if(!("geolocation"in navigator))return t(new DOMException("Geolocation not supported")),()=>{};if(!window.isSecureContext)return t(new DOMException("Geolocation requires HTTPS")),()=>{};let o=null;const a={enableHighAccuracy:!0,maximumAge:5e3,timeout:2e4};try{navigator.geolocation.getCurrentPosition(n=>{const{latitude:i,longitude:r,accuracy:d}=n.coords;e({lat:i,lon:r,accuracy:d})},n=>{t(n)},a)}catch(n){t(n)}try{o=navigator.geolocation.watchPosition(n=>{const{latitude:i,longitude:r,accuracy:d}=n.coords;e({lat:i,lon:r,accuracy:d})},n=>t(n),a)}catch(n){t(n)}return()=>{o!==null&&navigator.geolocation.clearWatch(o)}}async function Pe(){return new Promise((e,t)=>{if(!("geolocation"in navigator)){t(new DOMException("Geolocation not supported"));return}if(!window.isSecureContext){t(new DOMException("Geolocation requires HTTPS"));return}const o={enableHighAccuracy:!0,maximumAge:0,timeout:2e4};navigator.geolocation.getCurrentPosition(a=>{const{latitude:n,longitude:i,accuracy:r}=a.coords;e({lat:n,lon:i,accuracy:r})},a=>t(a),o)})}function Oe(e,t,o,a){const n=t*t,i=2*(a*e+t*o),r=1-2*(e*e+n),d=Math.atan2(i,r);let c=2*(a*t-o*e);c=Math.max(-1,Math.min(1,c));const S=Math.asin(c),M=2*(a*o+e*t),P=1-2*(n+o*o);return{yaw:Math.atan2(M,P)*180/Math.PI,pitch:S*180/Math.PI,roll:d*180/Math.PI}}function Be(e){let t=e.smoothing,o=e.headingOffsetDeg,a=new Set,n="deviceorientation+motion",i=null,r=0,d=0,c=0,S=0,M={headingDeg:0,pitchDeg:0,rollDeg:0,timestamp:performance.now()};const P=.02,U=.01;let B=null;const k=window,F=k.AbsoluteOrientationSensor,G=k.RelativeOrientationSensor;let $=null;function A(s){const u=R(r+o),g=d,b=c,y=Se(M.headingDeg,u,t),D=de(M.pitchDeg,g,t),E=de(M.rollDeg,b,t),I={headingDeg:y,pitchDeg:D,rollDeg:E,source:n,timestamp:s};M=I,a.forEach(h=>h(I))}function q(){try{const s=F||G;if(!s)return!1;const u=new s({frequency:60});return $=u,n="generic-sensor",u.onreading=()=>{const g=u.quaternion;if(!g)return;const{yaw:b,pitch:y,roll:D}=Oe(g[0],g[1],g[2],g[3]);r=R(b),d=y,c=D,A(performance.now())},u.onerror=()=>{},u.start(),!0}catch{return!1}}function J(){n="deviceorientation+motion";function s(g){const b=g;typeof b.webkitCompassHeading=="number"?B=R(b.webkitCompassHeading):typeof g.alpha=="number"&&(B=R(g.alpha))}function u(g){const b=performance.now(),y=S?(b-S)/1e3:0;S=b;const D=g.rotationRate;if(D){const I=D.alpha??0,h=D.beta??0,f=D.gamma??0;r=R(r+I*y),d=d+h*y,c=c+f*y}const E=g.accelerationIncludingGravity;if(E){const I=E.x??0,h=E.y??0,f=E.z??-9.8,l=Math.atan2(-I,Math.hypot(h,f))*180/Math.PI,p=Math.atan2(h,f)*180/Math.PI;d=d*(1-P)+l*P,c=c*(1-P)+p*P}if(B!=null){const I=re(B-r);r=R(r+I*U)}A(b)}return window.addEventListener("deviceorientation",s,!0),window.addEventListener("devicemotion",u,!0),()=>{window.removeEventListener("deviceorientation",s,!0),window.removeEventListener("devicemotion",u,!0)}}let _=[];function H(){n="virtual";let s=!1,u=0,g=0;const b=.1,y=.1;function D(h){s=!0,u=h.clientX,g=h.clientY,h.target.setPointerCapture?.(h.pointerId)}function E(h){s=!1,h.target.releasePointerCapture?.(h.pointerId)}function I(h){if(!s)return;const f=h.clientX-u,l=h.clientY-g;u=h.clientX,g=h.clientY,r=R(r+f*b),d=Math.max(-89,Math.min(89,d-l*y)),A(performance.now())}window.addEventListener("pointerdown",D),window.addEventListener("pointerup",E),window.addEventListener("pointermove",I),_.push(()=>{window.removeEventListener("pointerdown",D),window.removeEventListener("pointerup",E),window.removeEventListener("pointermove",I)})}if(!q()){const s=J();_.push(s);const u=setTimeout(()=>{S===0&&B==null&&H()},2e3);_.push(()=>clearTimeout(u))}function X(){A(performance.now()),i=requestAnimationFrame(X)}return i=requestAnimationFrame(X),{subscribe(s){return a.add(s),()=>a.delete(s)},setSmoothing(s){t=Math.max(0,Math.min(.3,s))},setHeadingOffset(s){o=s},getSource(){return n},stop(){i!==null&&cancelAnimationFrame(i),_.forEach(s=>s()),$?.stop?.(),a.clear()}}}function xe(e,t,o){const a=o/2,n=e/t*a+a;return Math.max(0,Math.min(o,n))}function ke(e,t,o){const a=o/2,n=-e/t*a+a;return Math.max(0,Math.min(o,n))}function Te(e,t,o){return e*(o/Math.max(1,t))}function Ce(e,t){const o=t/2;return e>=-o&&e<=o}function Ge(e){return e<0?"left":"right"}const Ae=e=>`${e.name}|${e.country}`,j=new Map;function Re(e,t){const n=new Set([...j.keys(),...e.keys()]);for(const i of n){const r=j.get(i)??0,d=e.has(i),c=d?Math.min(1,r+4*t):Math.max(0,r-3*t);c<=0&&!d?j.delete(i):j.set(i,c)}}function Fe(e,t){return{w:e.measureText(t).width+12,h:24}}function $e(e,t){return!(e.x+e.w<t.x||t.x+t.w<e.x||e.y+e.h<t.y||t.y+t.h<e.y)}function ue(e,t,o,a=12){const n=new Set,i=Math.max(12,e.h+6),r=e.y,d=[r];for(let c=1;c<=a;c++)d.push(r-c*i);for(let c=1;c<=a;c++)d.push(r+c*i);for(let c of d){if(c=Math.max(0,Math.min(o-e.h,c)),n.has(c))continue;n.add(c);const S={x:e.x,y:c,w:e.w,h:e.h};if(!t.some(M=>$e(M,S)))return c}return null}function _e(e,t,o,a){const{width:n,height:i,hfovDeg:r,pitchDeg:d,headingDeg:c,cities:S,user:M,units:P,maxDistanceKm:U,showOffscreenIndicators:B}=t,k=Math.max(1,window.devicePixelRatio||1);(e.canvas.width!==Math.floor(n*k)||e.canvas.height!==Math.floor(i*k))&&(e.canvas.width=Math.floor(n*k),e.canvas.height=Math.floor(i*k)),e.setTransform(k,0,0,k,0,0),e.clearRect(0,0,n,i);const F=Te(r,n,i),G=ke(d,F,i);e.save(),e.strokeStyle="rgba(180,200,220,0.25)",e.lineWidth=2,e.beginPath(),e.moveTo(0,G),e.lineTo(n,G),e.stroke(),e.restore();const $=.621371,A=S.map(s=>{const u=be(M.lat,M.lon,s.lat,s.lon);return{c:s,distKm:u,bearing:Ee(M.lat,M.lon,s.lat,s.lon)}}).filter(s=>s.distKm<=U);A.sort((s,u)=>u.c.population-s.c.population);const q=[],J=[],_=[],H=new Set,Z=24,X=a.v?Math.min(.1,(o-a.v)/1e3):0;a.v=o;for(const s of A){const u=Ae(s.c),g=re(s.bearing-c),b=!Ce(g,r),y=P==="km"?s.distKm:s.distKm*$,D=y>=100?Math.round(y).toString():y.toFixed(1),E=s.c.population,I=E>=1e6?`~${(E/1e6).toFixed(1)}M`:`~${Math.round(E/1e3)}k`,h=`${s.c.name}, ${s.c.country} — ${D} ${P} — Pop ${I}`;e.font="600 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";const{w:f,h:l}=Fe(e,h);let p=xe(g,r,n);const v=Math.max(0,Math.min(i-Z,G-6)),m={x:Math.max(4,Math.min(n-f-4,p-f/2)),y:v-l,w:f,h:l};if(b){if(!B){H.add(u);continue}H.add(u);const T=j.get(u)??0;if(T<=.01)continue;const O=Ge(g),w=6,x=O==="left"?{x:w,y:Math.max(0,Math.min(i-l,G-l/2)),w:f,h:l}:{x:n-w-f,y:Math.max(0,Math.min(i-l,G-l/2)),w:f,h:l},ee=O==="left"?J:_,ie=Math.ceil(i/(x.h+6))+2,W=ue(x,ee,i,ie);if(W===null)continue;x.y=W,ee.push({...x});const C=x.y+x.h/2,z=x.y+x.h-6;e.save(),e.globalAlpha=T,e.strokeStyle="rgba(255,255,255,0.6)",e.fillStyle="rgba(255,255,255,0.9)",e.lineWidth=2,e.beginPath(),O==="left"?(e.moveTo(w,C),e.lineTo(w+10,C-6),e.moveTo(w,C),e.lineTo(w+10,C+6),e.stroke(),e.textAlign="left",e.fillText(h,w+16,z)):(e.moveTo(n-w,C),e.lineTo(n-w-10,C-6),e.moveTo(n-w,C),e.lineTo(n-w-10,C+6),e.stroke(),e.textAlign="right",e.fillText(h,n-w-16,z)),e.restore()}else{const T=Math.ceil(i/(m.h+6))+2,O=ue(m,q,i,T);if(O===null)continue;m.y=O,q.push({...m}),H.add(u);const w=j.get(u)??0;if(w<=.01)continue;e.save(),e.globalAlpha=w,e.fillStyle="rgba(0,0,0,0.45)",e.strokeStyle="rgba(255,255,255,0.2)",He(e,m.x,m.y,m.w,m.h,6),e.fill(),e.fillStyle="white",e.shadowColor="rgba(0,0,0,0.6)",e.shadowBlur=2,e.fillText(h,m.x+6,m.y+m.h-6),e.restore()}}return Re(H,X),{visibleCount:q.length}}function He(e,t,o,a,n,i){e.beginPath(),e.moveTo(t+i,o),e.arcTo(t+a,o,t+a,o+n,i),e.arcTo(t+a,o+n,t,o+n,i),e.arcTo(t,o+n,t,o,i),e.arcTo(t,o,t+a,o,i),e.closePath()}const Ne=document.getElementById("camera"),N=document.getElementById("overlay"),Y=N.getContext("2d");let K={maxDistanceKm:1e3,units:"km",hfovDeg:60,headingOffsetDeg:0,smoothing:.15,showOffscreenIndicators:!1},te={lat:0,lon:0},ne=!1,se=[],oe=Be({smoothing:K.smoothing,headingOffsetDeg:K.headingOffsetDeg});performance.now();let Q=[],Ke={v:0};const qe=ye({settings:K,onSettingsChange:e=>{K=e,oe.setSmoothing(e.smoothing),oe.setHeadingOffset(e.headingOffsetDeg)},onStart:async()=>{he(),De().catch(()=>{}),Ie(Ne).catch(()=>{})},onRequestLocation:async()=>{try{L.setGeoStatus("requesting…");const e=await Pe();te={lat:e.lat,lon:e.lon},ne=!0,L.setGeoStatus(`${e.lat.toFixed(5)}, ${e.lon.toFixed(5)} ±${Math.round(e.accuracy||0)}m`),L.showManualGeo(!1),L.showAllowLocation(!1),he()}catch(e){console.warn("Geolocation prompt error",e);let t="location error";const o=e;if(typeof o?.code=="number")switch(o.code){case 1:t="permission denied — check site settings";break;case 2:t="position unavailable";break;case 3:t="timeout — move outdoors or check settings";break}else o?.message&&(t=o.message);L.setGeoStatus(t),L.showAllowLocation(!0),L.showManualGeo(!0)}},onManualGeo:e=>{te=e,ne=!0,L.setGeoStatus(`${e.lat.toFixed(5)}, ${e.lon.toFixed(5)} (manual)`)}}),L=qe;function he(){L.setGeoStatus("requesting…"),Le(e=>{te={lat:e.lat,lon:e.lon},ne=!0,L.setGeoStatus(`${e.lat.toFixed(5)}, ${e.lon.toFixed(5)} ±${Math.round(e.accuracy||0)}m`),L.showAllowLocation(!1)},e=>{console.warn("Geolocation error",e);let t="location error";const o=e;if(typeof o?.code=="number")switch(o.code){case 1:t="permission denied — check site settings";break;case 2:t="position unavailable";break;case 3:t="timeout — move outdoors or check settings";break;default:t="location error"}else o?.message&&(t=o.message);L.setGeoStatus(t),L.showAllowLocation(!0),L.showManualGeo(!0)})}async function We(){se=await(await fetch("./cities.json")).json()}function fe(){const e=N.getBoundingClientRect();N.width=e.width*window.devicePixelRatio,N.height=e.height*window.devicePixelRatio}window.addEventListener("resize",fe);fe();let ge=performance.now(),ae=0;oe.subscribe(e=>{ae++;const t=performance.now();if(t-ge>1e3){Q.push(ae),Q.length>4&&Q.shift();const o=Q.reduce((a,n)=>a+n,0)/Q.length;L.updateDebug(e.headingDeg,e.pitchDeg,e.rollDeg,e.source,o),ae=0,ge=t}});function pe(){const e=performance.now();let t=window.__arc_heading??0,o=window.__arc_pitch??0;window.__arc_bound||(window.__arc_bound=!0,oe.subscribe(i=>{window.__arc_heading=i.headingDeg,window.__arc_pitch=i.pitchDeg,window.__arc_roll=i.rollDeg}));const a=N.clientWidth,n=N.clientHeight;N.width=Math.floor(a*window.devicePixelRatio),N.height=Math.floor(n*window.devicePixelRatio),Y.setTransform(window.devicePixelRatio,0,0,window.devicePixelRatio,0,0),ne&&se.length>0?_e(Y,{width:a,height:n,hfovDeg:K.hfovDeg,pitchDeg:o,headingDeg:t,units:K.units,maxDistanceKm:K.maxDistanceKm,user:te,cities:se,showOffscreenIndicators:K.showOffscreenIndicators},e,Ke):(Y.clearRect(0,0,a,n),Y.fillStyle="rgba(255,255,255,0.7)",Y.font="600 16px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial",Y.textAlign="center",Y.fillText("Press Start and allow permissions",a/2,n/2)),requestAnimationFrame(pe)}We();requestAnimationFrame(pe);"serviceWorker"in navigator&&navigator.serviceWorker.register("./sw.js").catch(()=>{});
