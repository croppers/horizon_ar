(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function o(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(n){if(n.ep)return;n.ep=!0;const i=o(n);fetch(n.href,i)}})();const lt="arcities.settings.v1";function ht(){try{const t=localStorage.getItem(lt);if(t)return JSON.parse(t)}catch{}return{maxDistanceKm:1e3,units:"km",hfovDeg:60,headingOffsetDeg:0,smoothing:.15}}function gt(t){try{localStorage.setItem(lt,JSON.stringify(t))}catch{}}function mt(t){const e=t.settings||ht();t.settings=e;const o=document.getElementById("startBtn"),a=document.getElementById("helpBtn"),n=document.getElementById("onboarding"),i=document.getElementById("collapseBtn"),s=document.getElementById("controlsBody"),c=document.getElementById("distance"),r=document.getElementById("distanceValue"),b=document.getElementById("unitsKm"),M=document.getElementById("unitsMi"),S=document.getElementById("hfov"),_=document.getElementById("hfovValue"),w=document.getElementById("headingOffset"),$=document.getElementById("headingOffsetValue"),I=document.getElementById("smooth"),Y=document.getElementById("smoothValue"),C=document.getElementById("dbgHeading"),P=document.getElementById("dbgPitch"),W=document.getElementById("dbgRoll"),V=document.getElementById("dbgSource"),B=document.getElementById("dbgRate"),q=document.getElementById("dbgSmooth"),U=document.getElementById("geoText"),g=document.getElementById("manualGeo"),l=document.getElementById("lat"),m=document.getElementById("lon"),f=document.getElementById("setGeo");localStorage.getItem("arcities.onboarded")||n.showModal(),document.getElementById("onboardingClose").addEventListener("click",()=>{localStorage.setItem("arcities.onboarded","1")}),a.addEventListener("click",()=>n.showModal()),i.addEventListener("click",()=>{const u=!(i.getAttribute("aria-expanded")==="true");i.setAttribute("aria-expanded",String(u)),s.style.display=u?"block":"none",i.textContent=u?"▾":"▸"}),c.value=String(e.maxDistanceKm),S.value=String(e.hfovDeg),w.value=String(e.headingOffsetDeg),I.value=String(e.smoothing),e.units==="km"?b.checked=!0:M.checked=!0;function v(h,u){if(u==="km")return`${Math.round(h)} km`;const d=h*.621371;return`${Math.round(d)} mi`}function D(){r.textContent=v(Number(c.value),e.units),_.textContent=`${S.value}°`,$.textContent=`${w.value}°`,Y.textContent=`${Number(I.value).toFixed(2)}`}D();function p(){gt(e),t.onSettingsChange?.(e),D()}return c.addEventListener("input",()=>{e.maxDistanceKm=Number(c.value),p()}),S.addEventListener("input",()=>{e.hfovDeg=Number(S.value),p()}),w.addEventListener("input",()=>{e.headingOffsetDeg=Number(w.value),p()}),I.addEventListener("input",()=>{e.smoothing=Number(I.value),p()}),b.addEventListener("change",()=>{e.units="km",p()}),M.addEventListener("change",()=>{e.units="mi",p()}),o.addEventListener("click",()=>t.onStart?.()),f.addEventListener("click",()=>{const h=Number(l.value),u=Number(m.value);!Number.isFinite(h)||!Number.isFinite(u)||t.onManualGeo?.({lat:h,lon:u})}),{setGeoStatus(h){U.textContent=h},showManualGeo(h){g.classList.toggle("hidden",!h)},updateDebug(h,u,d,y,x){C.textContent=h.toFixed(1),P.textContent=u.toFixed(1),W.textContent=d.toFixed(1),V.textContent=y,B.textContent=x?x.toFixed(0):"–",q.textContent=e.smoothing.toFixed(2)},getSettings(){return e}}}function R(t){return t*Math.PI/180}function ft(t){return t*180/Math.PI}function O(t){let e=t%360;return e<0&&(e+=360),e}function tt(t){return((t+180)%360+360)%360-180}function pt(t,e,o,a){const n=6371.0088,i=R(o-t),s=R(a-e),c=Math.sin(i/2)**2+Math.cos(R(t))*Math.cos(R(o))*Math.sin(s/2)**2,r=2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c));return n*r}function vt(t,e,o,a){const n=R(t),i=R(o),s=R(a-e),c=Math.sin(s)*Math.cos(i),r=Math.cos(n)*Math.sin(i)-Math.sin(n)*Math.cos(i)*Math.cos(s),b=ft(Math.atan2(c,r));return O(b)}function wt(t,e,o){const a=tt(e-t);return O(t+a*(1-Math.exp(-o)))}function st(t,e,o){return t+(e-t)*(1-Math.exp(-o))}async function yt(){try{const t=window,e=t.DeviceMotionEvent&&typeof t.DeviceMotionEvent.requestPermission=="function"?await t.DeviceMotionEvent.requestPermission():"granted",o=t.DeviceOrientationEvent&&typeof t.DeviceOrientationEvent.requestPermission=="function"?await t.DeviceOrientationEvent.requestPermission():"granted"}catch{}}async function Mt(t){try{const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}},audio:!1});return t.srcObject=e,await t.play(),e}catch(e){return console.warn("Camera access failed",e),null}}function bt(t,e){if(!("geolocation"in navigator))return e(new DOMException("Geolocation not supported")),()=>{};if(!window.isSecureContext)return e(new DOMException("Geolocation requires HTTPS")),()=>{};let o=null;const a={enableHighAccuracy:!0,maximumAge:5e3,timeout:2e4};try{navigator.geolocation.getCurrentPosition(n=>{const{latitude:i,longitude:s,accuracy:c}=n.coords;t({lat:i,lon:s,accuracy:c})},n=>{e(n)},a)}catch(n){e(n)}try{o=navigator.geolocation.watchPosition(n=>{const{latitude:i,longitude:s,accuracy:c}=n.coords;t({lat:i,lon:s,accuracy:c})},n=>e(n),a)}catch(n){e(n)}return()=>{o!==null&&navigator.geolocation.clearWatch(o)}}function St(t,e,o,a){const n=e*e,i=2*(a*t+e*o),s=1-2*(t*t+n),c=Math.atan2(i,s);let r=2*(a*e-o*t);r=Math.max(-1,Math.min(1,r));const b=Math.asin(r),M=2*(a*o+t*e),S=1-2*(n+o*o);return{yaw:Math.atan2(M,S)*180/Math.PI,pitch:b*180/Math.PI,roll:c*180/Math.PI}}function Dt(t){let e=t.smoothing,o=t.headingOffsetDeg,a=new Set,n="deviceorientation+motion",i=null,s=0,c=0,r=0,b=0,M={headingDeg:0,pitchDeg:0,rollDeg:0,timestamp:performance.now()};const S=.02,_=.01;let w=null;const $=window,I=$.AbsoluteOrientationSensor,Y=$.RelativeOrientationSensor;let C=null;function P(l){const m=O(s+o),f=c,v=r,D=wt(M.headingDeg,m,e),p=st(M.pitchDeg,f,e),h=st(M.rollDeg,v,e),u={headingDeg:D,pitchDeg:p,rollDeg:h,source:n,timestamp:l};M=u,a.forEach(d=>d(u))}function W(){try{const l=I||Y;if(!l)return!1;const m=new l({frequency:60});return C=m,n="generic-sensor",m.onreading=()=>{const f=m.quaternion;if(!f)return;const{yaw:v,pitch:D,roll:p}=St(f[0],f[1],f[2],f[3]);s=O(v),c=D,r=p,P(performance.now())},m.onerror=()=>{},m.start(),!0}catch{return!1}}function V(){n="deviceorientation+motion";function l(f){const v=f;typeof v.webkitCompassHeading=="number"?w=O(v.webkitCompassHeading):typeof f.alpha=="number"&&(w=O(f.alpha))}function m(f){const v=performance.now(),D=b?(v-b)/1e3:0;b=v;const p=f.rotationRate;if(p){const u=p.alpha??0,d=p.beta??0,y=p.gamma??0;s=O(s+u*D),c=c+d*D,r=r+y*D}const h=f.accelerationIncludingGravity;if(h){const u=h.x??0,d=h.y??0,y=h.z??-9.8,x=Math.atan2(-u,Math.hypot(d,y))*180/Math.PI,J=Math.atan2(d,y)*180/Math.PI;c=c*(1-S)+x*S,r=r*(1-S)+J*S}if(w!=null){const u=tt(w-s);s=O(s+u*_)}P(v)}return window.addEventListener("deviceorientation",l,!0),window.addEventListener("devicemotion",m,!0),()=>{window.removeEventListener("deviceorientation",l,!0),window.removeEventListener("devicemotion",m,!0)}}let B=[];function q(){n="virtual";let l=!1,m=0,f=0;const v=.1,D=.1;function p(d){l=!0,m=d.clientX,f=d.clientY,d.target.setPointerCapture?.(d.pointerId)}function h(d){l=!1,d.target.releasePointerCapture?.(d.pointerId)}function u(d){if(!l)return;const y=d.clientX-m,x=d.clientY-f;m=d.clientX,f=d.clientY,s=O(s+y*v),c=Math.max(-89,Math.min(89,c-x*D)),P(performance.now())}window.addEventListener("pointerdown",p),window.addEventListener("pointerup",h),window.addEventListener("pointermove",u),B.push(()=>{window.removeEventListener("pointerdown",p),window.removeEventListener("pointerup",h),window.removeEventListener("pointermove",u)})}if(!W()){const l=V();B.push(l);const m=setTimeout(()=>{b===0&&w==null&&q()},2e3);B.push(()=>clearTimeout(m))}function g(){P(performance.now()),i=requestAnimationFrame(g)}return i=requestAnimationFrame(g),{subscribe(l){return a.add(l),()=>a.delete(l)},setSmoothing(l){e=Math.max(0,Math.min(.3,l))},setHeadingOffset(l){o=l},getSource(){return n},stop(){i!==null&&cancelAnimationFrame(i),B.forEach(l=>l()),C?.stop?.(),a.clear()}}}function Et(t,e,o){const a=o/2,n=t/e*a+a;return Math.max(0,Math.min(o,n))}function It(t,e,o){const a=o/2,n=-t/e*a+a;return Math.max(0,Math.min(o,n))}function Pt(t,e,o){return t*(o/Math.max(1,e))}function Bt(t,e){const o=e/2;return t>=-o&&t<=o}function Lt(t){return t<0?"left":"right"}const Ot=t=>`${t.name}|${t.country}`,K=new Map;function xt(t,e){const n=new Set([...K.keys(),...t.keys()]);for(const i of n){const s=K.get(i)??0,c=t.has(i),r=c?Math.min(1,s+4*e):Math.max(0,s-3*e);r<=0&&!c?K.delete(i):K.set(i,r)}}function kt(t,e){const o=t.measureText(e),a=(o.actualBoundingBoxAscent||12)+(o.actualBoundingBoxDescent||4);return{w:o.width+12,h:a}}function Tt(t,e){return!(t.x+t.w<e.x||e.x+e.w<t.x||t.y+t.h<e.y||e.y+e.h<t.y)}function rt(t,e,o,a=12){const n=new Set,i=Math.max(10,t.h+4),s=t.y,c=[s];for(let r=1;r<=a;r++)c.push(s-r*i);for(let r=1;r<=a;r++)c.push(s+r*i);for(let r of c){if(r=Math.max(0,Math.min(o-t.h,r)),n.has(r))continue;n.add(r);const b={x:t.x,y:r,w:t.w,h:t.h};if(!e.some(M=>Tt(M,b)))return r}return null}function Ct(t,e,o,a){const{width:n,height:i,hfovDeg:s,pitchDeg:c,headingDeg:r,cities:b,user:M,units:S,maxDistanceKm:_}=e,w=Math.max(1,window.devicePixelRatio||1);(t.canvas.width!==Math.floor(n*w)||t.canvas.height!==Math.floor(i*w))&&(t.canvas.width=Math.floor(n*w),t.canvas.height=Math.floor(i*w)),t.setTransform(w,0,0,w,0,0),t.clearRect(0,0,n,i);const $=Pt(s,n,i),I=It(c,$,i);t.save(),t.strokeStyle="rgba(180,200,220,0.25)",t.lineWidth=2,t.beginPath(),t.moveTo(0,I),t.lineTo(n,I),t.stroke(),t.restore();const Y=.621371,C=b.map(g=>{const l=pt(M.lat,M.lon,g.lat,g.lon);return{c:g,distKm:l,bearing:vt(M.lat,M.lon,g.lat,g.lon)}}).filter(g=>g.distKm<=_);C.sort((g,l)=>l.c.population-g.c.population);const P=[],W=[],V=[],B=new Set,q=22,U=a.v?Math.min(.1,(o-a.v)/1e3):0;a.v=o;for(const g of C){const l=Ot(g.c),m=tt(g.bearing-r),f=!Bt(m,s),v=S==="km"?g.distKm:g.distKm*Y,D=v>=100?Math.round(v).toString():v.toFixed(1),p=g.c.population,h=p>=1e6?`~${(p/1e6).toFixed(1)}M`:`~${Math.round(p/1e3)}k`,u=`${g.c.name}, ${g.c.country} — ${D} ${S} — Pop ${h}`;t.font="600 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";const{w:d,h:y}=kt(t,u);let x=Et(m,s,n);const J=Math.max(0,Math.min(i-q,I-6)),L={x:Math.max(4,Math.min(n-d-4,x-d/2)),y:J-y,w:d,h:y};if(f){B.add(l);const X=K.get(l)??0;if(X<=.01)continue;const H=Lt(m),E=6,A=H==="left"?{x:E,y:Math.max(0,Math.min(i-y,I-y/2)),w:d,h:y}:{x:n-E-d,y:Math.max(0,Math.min(i-y,I-y/2)),w:d,h:y},ot=H==="left"?W:V,it=rt(A,ot,i);if(it===null)continue;A.y=it,ot.push({...A});const k=A.y+A.h/2,at=A.y+A.h-6;t.save(),t.globalAlpha=X,t.strokeStyle="rgba(255,255,255,0.6)",t.fillStyle="rgba(255,255,255,0.9)",t.lineWidth=2,t.beginPath(),H==="left"?(t.moveTo(E,k),t.lineTo(E+10,k-6),t.moveTo(E,k),t.lineTo(E+10,k+6),t.stroke(),t.textAlign="left",t.fillText(u,E+16,at)):(t.moveTo(n-E,k),t.lineTo(n-E-10,k-6),t.moveTo(n-E,k),t.lineTo(n-E-10,k+6),t.stroke(),t.textAlign="right",t.fillText(u,n-E-16,at)),t.restore()}else{const X=rt(L,P,i);if(X===null)continue;L.y=X,P.push({...L}),B.add(l);const H=K.get(l)??0;if(H<=.01)continue;t.save(),t.globalAlpha=H,t.fillStyle="rgba(0,0,0,0.45)",t.strokeStyle="rgba(255,255,255,0.2)",At(t,L.x,L.y,L.w,L.h,6),t.fill(),t.fillStyle="white",t.shadowColor="rgba(0,0,0,0.6)",t.shadowBlur=2,t.fillText(u,L.x+6,L.y+L.h-6),t.restore()}}return xt(B,U),{visibleCount:P.length}}function At(t,e,o,a,n,i){t.beginPath(),t.moveTo(e+i,o),t.arcTo(e+a,o,e+a,o+n,i),t.arcTo(e+a,o+n,e,o+n,i),t.arcTo(e,o+n,e,o,i),t.arcTo(e,o,e+a,o,i),t.closePath()}const Gt=document.getElementById("camera"),T=document.getElementById("overlay"),G=T.getContext("2d");let F={maxDistanceKm:1e3,units:"km",hfovDeg:60,headingOffsetDeg:0,smoothing:.15},et={lat:0,lon:0},nt=!1,Z=[],z=Dt({smoothing:F.smoothing,headingOffsetDeg:F.headingOffsetDeg});performance.now();let j=[],Rt={v:0};const Ft=mt({settings:F,onSettingsChange:t=>{F=t,z.setSmoothing(t.smoothing),z.setHeadingOffset(t.headingOffsetDeg)},onStart:async()=>{_t(),yt().catch(()=>{}),Mt(Gt).catch(()=>{})},onManualGeo:t=>{et=t,nt=!0,N.setGeoStatus(`${t.lat.toFixed(5)}, ${t.lon.toFixed(5)} (manual)`)}}),N=Ft;function _t(){N.setGeoStatus("requesting…"),bt(t=>{et={lat:t.lat,lon:t.lon},nt=!0,N.setGeoStatus(`${t.lat.toFixed(5)}, ${t.lon.toFixed(5)} ±${Math.round(t.accuracy||0)}m`)},t=>{console.warn("Geolocation error",t);let e="location error";const o=t;if(typeof o?.code=="number")switch(o.code){case 1:e="permission denied — check site settings";break;case 2:e="position unavailable";break;case 3:e="timeout — move outdoors or check settings";break;default:e="location error"}else o?.message&&(e=o.message);N.setGeoStatus(e),N.showManualGeo(!0)})}async function $t(){Z=await(await fetch("./cities.json")).json()}function dt(){const t=T.getBoundingClientRect();T.width=t.width*window.devicePixelRatio,T.height=t.height*window.devicePixelRatio}window.addEventListener("resize",dt);dt();let ct=performance.now(),Q=0;z.subscribe(t=>{Q++;const e=performance.now();if(e-ct>1e3){j.push(Q),j.length>4&&j.shift();const o=j.reduce((a,n)=>a+n,0)/j.length;N.updateDebug(t.headingDeg,t.pitchDeg,t.rollDeg,t.source,o),Q=0,ct=e}});function ut(){const t=performance.now();let e=window.__arc_heading??0,o=window.__arc_pitch??0;window.__arc_bound||(window.__arc_bound=!0,z.subscribe(i=>{window.__arc_heading=i.headingDeg,window.__arc_pitch=i.pitchDeg,window.__arc_roll=i.rollDeg}));const a=T.clientWidth,n=T.clientHeight;T.width=Math.floor(a*window.devicePixelRatio),T.height=Math.floor(n*window.devicePixelRatio),G.setTransform(window.devicePixelRatio,0,0,window.devicePixelRatio,0,0),nt&&Z.length>0?Ct(G,{width:a,height:n,hfovDeg:F.hfovDeg,pitchDeg:o,headingDeg:e,units:F.units,maxDistanceKm:F.maxDistanceKm,user:et,cities:Z},t,Rt):(G.clearRect(0,0,a,n),G.fillStyle="rgba(255,255,255,0.7)",G.font="600 16px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial",G.textAlign="center",G.fillText("Press Start and allow permissions",a/2,n/2)),requestAnimationFrame(ut)}$t();requestAnimationFrame(ut);"serviceWorker"in navigator&&navigator.serviceWorker.register("./sw.js").catch(()=>{});
